
---
title: "UKB Cubic Mods"
output: html_document
date: '2023-10-06'
---

Playing around with model-selection algorithms using data cleaned & curated in `ukb_curation-eda.Rmd`

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider)

# #pull plotting functions from github
# plot.func.url <- "https://raw.githubusercontent.com/BGDlab/GAMLSS/main/plotting_functions.R?token=GHSAT0AAAAAACGAYP4HZWCTHACGUM6KG2PSZIQUPBA"
# Sys.setenv(GITHUB_PAT = "") #if needed to access private BGDlab GAMLSS repo
# source_url(plot.func.url) #sometimes doesn't work....?

source("/Users/megardn/Desktop/BGD_Repos/GAMLSS/plotting_functions.R")
```


## Load Data

```{r}
ukb_df_totals <- read_csv(file="data/ukb_CN_data.csv")
```

## Global Mod Fitting

Try using `stepGAICALL.A()`

```{r}
m1 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(age_days):sex,
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)

m2 <- stepGAICAll.A(m1, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(age_days):sex), k=2) #AIC

m2
summary(m2)
```

seeing if things change when i hard-code a sex*age interaction term

```{r}
m3 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4 <- stepGAICAll.A(m3, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age)), k=2) #AIC

summary(m4)
```

Seems like stepGAICAll handles combined sex.age term better than an interaction
Try adding TBV
```{r}
m3.tbv <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4.tbv <- stepGAICAll.A(Ventricles_mod, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV)), k=2, glim.control(cyc=100)) #AIC
summary(m4.tbv)
```

```{r}
plot_singlestudy_centiles(m4, "GMV", ukb_df, "sex")
```

Let's look at diagnostics
```{r}
plot(m4)
wp(m4, xvar=age_days, n.inter=4) #leptokurtosis (tails fo fitted distribution too light)
dtop(m4)
rqres.plot(m4)

plot(m4.tbv)
wp(m4.tbv, xvar=age_days, n.inter=4) #U-shape: fitted skewness too low
dtop(m4.tbv)
rqres.plot(m4.tbv)
```

# CUBIC Models
Playing around wiht models fit on cubic using `fit_ukb_mod.R`

scp-ing random model to look at (`lh_SA_middletemporal_mod.rds`)

```{r}
lh_SA_middletemporal_mod <- readRDS("ukb/gamlss_objs/lh_SA_middletemporal_mod.rds")
a <- summary(lh_SA_middletemporal_mod)
dim(a)

#sigma coefficients
coef(lh_SA_middletemporal_mod, what="sigma") %>%
  names()

test <- confint(lh_SA_middletemporal_mod)
colnames(test)
rownames(test)
test["sigma.sexMale", "97.5 %"]
df.test <- as.data.frame(test)
df.test$params <- rownames(df.test)
# Remove the row names from the dataframe
rownames(df.test) <- NULL

df.test
#using drop1 to get significance, gamlss book p 125 for df info
#get df from OG model - not sure how this would be affected by using stepGAIC?


str(lh_SA_middletemporal_mod)
lh_SA_middletemporal_mod$sigma.nl.df

#start df with confidence intervals
confint.matrix <- confint(lh_SA_middletemporal_mod)
df <- as.data.frame(confint.matrix) %>%
  rownames_to_column(var = "moment.param") %>%
  mutate(
    moment = sapply(strsplit(moment.param, "\\."), `[`, 1),
    param = sub("^[^.]+\\.", "", moment.param)
  )

#now that we have the moments, add the rest of the summary info
sum.table <- summary(lh_SA_middletemporal_mod)
df2 <- as.data.frame(sum.table) %>%
  rownames_to_column(var = "param")
#check
rownames(sum.table) == df$param

find.param <- function(gamlss.rds.file, moment, string) {
  #USE WITH sapply(USE.NAMES=TRUE) to keep file names with values!
  gamlss.obj <- readRDS(gamlss.rds.file)
  sigma.coeff.list <- coef(gamlss.rds.file, what= moment) %>%
    names()
  any(sapply(sigma.coeff.list, function(x) grepl(string, x, ignore.case = TRUE)))
}
find.param(lh_SA_middletemporal_mod, "sigma", "sex")

readRDS("ukb/gamlss_objs/rh_Vol_parsopercularis_mod.rds")

```

### Sex-effects visualization

load info parsed from models via  `var_parse.sh` (which calls `R_scripts/variance_parser.R`)

```{r}
sigma.df <- read.csv(file="ukb/sigma.csv", row.names=1)
skim(sigma.df)
```

all contain sex in sigma

```{r}
sigma.df<- sigma.df %>%
  mutate(mu_form = as.factor(sub(".*~", "", mu_form)),
         sig_form = as.factor(sig_form),
         nu_form = as.factor(nu_form),
         measure_type = as.factor(case_when(grepl("Vol", region) ~ "Vol",
                                  grepl("CT", region) ~ "CT",
                                  grepl("SA", region) ~ "SA",
                                  TRUE ~ "Global")))

table(sigma.df$sig_form)
table(sigma.df$mu_form)
table(sigma.df$nu_form)
```

Weirdly only nu has variation in terms selected...?

plot sex effects in sigma
```{r}
ggplot(sigma.df, aes(x=sexMale, fill=measure_type)) +
  geom_histogram(alpha=0.6, position = "identity", color="white")
```

Normalize sexMale's beta weight by the overall value of all sigma terms

```{r}
#get betas
file.list <- list.files(path="/Users/megardn/Desktop/BGD_Repos/combat_biovar/ukb/gamlss_objs", pattern="_mod.rds", full.names = TRUE)

betas.mat <- sapply(file.list, get.moment.betas, moment="sigma", USE.NAMES=TRUE)
colnames(betas.mat) <- map(colnames(betas.mat), basename)


```

