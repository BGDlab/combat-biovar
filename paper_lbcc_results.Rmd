---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

Rmd to show and get feedback on planned for results & figures for the combatLS paper. Currently thinking I'll have centile score results be the focus of the paper and keep z-scores for the supplement.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, skimr, gam)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")

#ATLAS
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
#plotting info from dk atlas
dk.parc <- dk_nomed$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()

#PHENO LISTS
pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
pheno_list.z <- paste0(pheno_list, ".z")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

#PATH
der_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/lifespan"
```

#Load

Combat-GAM Centiles - site-level batch correction

```{r}
gam_centile_df <- fread(file=paste0(der_path, "/lifespan-CN-imp-sites-euler-log-cf-cf.gam-batch.site_predictions.csv"))
dim(gam_centile_df)
```

Combat-LS Centiles
```{r}
gamlss_centile_df <- fread(file=paste0(der_path, "/lifespan-CN-imp-sites-euler-log-cf-cf.gamlss-batch.site_predictions.csv"))
dim(gamlss_centile_df)
```

Deltas

```{r}
deltas_df <- fread(file=paste0(der_path, "/batch.site_pred_deltas.csv"))
# skimr::skim(deltas_df)
cent_deltas_df <- deltas_df %>%
  mutate(study=sub("\\_.*", "", site),
         age_years=age_days/365.25) %>%
  dplyr::select(!contains(".z") & !ends_with("_total") & !contains("TBV")) #drop z-scores and non-centiles

tbl.df <- as.data.frame(table(cent_deltas_df$site, cent_deltas_df$study))
```

#Clean & EDA

Sample plot
```{r}
#reorder studies by age
age.df <- cent_deltas_df %>%
  group_by(study) %>%
  summarize(mean_age = mean(age_years)) %>%
  arrange(mean_age)

sample_boxplot <- cent_deltas_df %>%
  mutate(study = factor(study, levels=c(age.df$study), ordered=TRUE)) %>%
ggplot(aes(y=interaction(site,study, sep = "&"), x=age_years)) +
  geom_boxplot(outlier.size = 1, outlier.colour=NULL) +
  theme_linedraw(base_size = 11) +
  guides(y = ggh4x::guide_axis_nested(delim = "&")) +
  theme(axis.title.x=element_blank(), axis.ticks.y = element_blank(), axis.text=element_blank(), ggh4x.axis.nesttext.y = element_text(size=6)) +
  labs(color="Sex", y = "Site")

#overall sample
full_boxplot <- 
  cent_deltas_df %>%
  mutate(ylab = "  Full \n  Sample") %>%
  ggplot(aes(y=ylab, x=age_years, color=sex)) +
  geom_boxplot(outlier.size = 1, outlier.colour=NULL) +
  theme_linedraw(base_size = 11) +
  # theme(plot.margin = margin(0,0,0,0, 'cm')) +
  # scale_y_discrete(labels=c("1" = "Full Sample")) +
  labs(color="Sex", x = "Age (Years)", y="")

sample_barplot <- cent_deltas_df %>%
  mutate(study = factor(study, levels=c(age.df$study), ordered=TRUE)) %>%
  ggplot() +
  geom_bar(aes( x=..count../tapply(..count.., ..y.. ,sum)[..y..], y=interaction(site,study, sep = "&"), fill=sex)) +
  scale_x_continuous(labels = scales::percent) +
  geom_vline(xintercept = .5, color="lightgray", linetype="longdash") +
  theme_linedraw(base_size = 11) +
  theme(axis.ticks.y = element_blank(), axis.text=element_blank(), axis.title=element_blank()) +
  labs(color="Sex")

full_barplot <- 
  cent_deltas_df %>%
  mutate(ylab = "Full Sample") %>%
  ggplot() +
  geom_bar(aes(x=..count../tapply(..count.., ..y.. ,sum)[..y..], y=ylab, fill=sex)) + 
  scale_x_continuous(labels = scales::percent) +
  geom_vline(xintercept = .5, color="lightgray", linetype="longdash") +
  theme_linedraw(base_size = 11) +
  theme(axis.ticks.y = element_blank(), axis.text.y=element_blank(), axis.title.y=element_blank()) +
  labs(color="Sex", x = "Sex")

ggarrange(sample_boxplot, sample_barplot,
          full_boxplot, full_barplot,
          nrow=2, ncol=2, 
          align = "hv", 
          common.legend = TRUE,
          widths=c(2, 1),
          heights=c(10, 1))
```

```{r}
ggplot(deltas_df, aes(x=age_days, y=delta.sGMV, color=sex)) +
  geom_point() +
  geom_smooth()
```

```{r}
cent_deltas_df_long <- cent_deltas_df %>%
  pivot_longer(cols=starts_with("delta."), names_to="pheno", names_prefix = "delta.", values_to = "delta")

cent_deltas_df_long %>%
  ggplot() +
  geom_histogram(aes(x=delta, color=study, fill=study))
```


```{r}
delta_n.sex <- cent_deltas_df_long %>%
  mutate(abs.delta = abs(delta)) %>%
  group_by(sex, study, site) %>%
  summarise(sex_n = n(),
            mean_abs.delta=mean(abs.delta),
            mean_delta=mean(delta),
            mean_age_yrs=mean(age_days)/365.25) #get number males and females in each site

#get site-level stats
delta_summary.df <- cent_deltas_df_long %>%
  mutate(abs.delta = abs(delta)) %>%
  group_by(study, site) %>%
  summarise(site_mean_abs.delta=mean(abs.delta),
            site_mean_delta=mean(delta),
            site_mean_age=mean(age_days),
            site_mean_age_yrs=mean(age_days)/365.25,
            site_max_abs.delta=max(abs.delta),
            site_n=n())

delta_n.sex %>%
  dplyr::filter(site=="abide2_BNI_1")
```

```{r}
delta_sum.by.sex.df <- full_join(delta_summary.df, delta_n.sex) %>%
  mutate(sex_prop=sex_n/site_n,
         majority = ifelse(sex_prop > .5, 1, 0))

delta_sum.by.sex.df_piv <- delta_sum.by.sex.df %>%
  pivot_wider(id_cols=c(study, site, site_n, site_mean_age, site_mean_age_yrs, site_mean_delta, site_mean_abs.delta), names_from=sex, values_from=c(sex_n, sex_prop, mean_delta, mean_abs.delta))

#Merge back female prop back into overall site-level stats
to_merge <- delta_sum.by.sex.df_piv %>%
  dplyr::select(study, site, sex_prop_Female) %>%
  mutate_at(vars(sex_prop_Female), ~replace_na(., 0)) #set prop Female to 0 if no females in study

delta_sum.df_merged <- full_join(delta_summary.df, to_merge)
```

plots!

delta ~ sex-imbalance

```{r}
delta_sum.df_merged %>%
  ggplot(aes(x=sex_prop_Female, y=site_mean_delta)) +
  geom_count(aes(size=site_n)) +
  geom_smooth(method="lm")

delta_sum.by.sex.df %>%
  ggplot(aes(x=sex, y=mean_delta, color=site, fill=site)) +
  geom_count(aes(size=sex_prop), alpha=0.5) +
  geom_line(aes(group=site)) +
  theme(legend.position="none")

delta_sum.by.sex.df %>%
  ggplot(aes(x=sex, y=mean_delta, color=as.factor(majority), fill=as.factor(majority))) +
  geom_count(aes(shape=as.factor(majority), size=sex_prop), alpha=0.5) +
  geom_line(aes(group=site), color="darkgray")

delta_sum.by.sex.df %>%
  ggplot(aes(x=sex_prop, y=mean_abs.delta, color=mean_age_yrs)) +
  geom_count(aes(size=sex_n)) +
  geom_smooth(method="lm") +
  facet_wrap(~sex)

delta_sum.by.sex.df_piv %>%
  ggplot(aes(x=sex_prop_Female, y=site_mean_abs.delta, color=study)) +
  geom_count(aes(size=site_n)) +
  geom_smooth(method="lm")
```


look at max abs. delta across sites
```{r}
delta_sum.df_merged %>%
  ggplot() +
  geom_histogram(aes(x=site_max_abs.delta*100))

delta_sum.df_merged %>%
  ggplot(aes(y=site_max_abs.delta*100, x=site_n)) +
  geom_point() +
  geom_smooth(method="lm")

delta_sum.df_merged %>%
  ggplot(aes(y=site_max_abs.delta*100, x=site_mean_age_yrs)) +
  geom_point() +
  geom_smooth(method="lm")

delta_sum.df_merged %>%
  ggplot(aes(y=site_max_abs.delta*100, x=sex_prop_Female)) +
  geom_point() +
  geom_smooth(method="lm")
```

##Feature-wise
do deltas differ by feature?
```{r}
cent_deltas_df_long2 <- cent_deltas_df_long %>%
   mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

cent_deltas_df_long2 %>%
  ggplot() +
  geom_histogram(aes(x=delta, fill=pheno), position="identity", alpha=0.3) +
  theme(legend.position="none")

cent_deltas_df_long2 %>%
  ggplot() +
  geom_histogram(aes(x=delta*100, fill=pheno_cat, color=pheno_cat), position="identity", alpha=0.7, bins=60)

cent_deltas_df_long2 %>%
  ggplot() +
  geom_histogram(aes(x=delta*100, fill=study, color=study), position="identity", alpha=0.3, bins=60) +
  facet_wrap(~pheno_cat, scales="free") +
  theme(legend.position="none")
```


#Site-Level Mean Results

delta ~ age

```{r}
# age
summary(lm(site_mean_abs.delta ~ site_mean_age_yrs, data=delta_sum.df_merged))
summary(lm(site_mean_delta ~ site_mean_age_yrs, data=delta_sum.df_merged))

#forward selection for site_mean_abs.delta
summary(lm(site_mean_abs.delta ~ site_mean_age_yrs + site_n, data=delta_sum.df_merged)) #small effect but remains significant/grows stronger
summary(lm(site_mean_abs.delta ~ site_mean_age_yrs + site_n + sex_prop_Female, data=delta_sum.df_merged)) #small effect but remains significant/grows stronger
full.delta.age.fit <- lm((site_mean_abs.delta*100) ~ site_mean_age_yrs + site_n + sex_prop_Female, data=delta_sum.df_merged) #scaling to centile space
sjPlot::plot_model(full.delta.age.fit, type = "pred", terms = "site_mean_age_yrs")
```


```{r}
delta_sum.df_merged %>%
  ggplot(aes(x=site_mean_age_yrs, y=site_mean_abs.delta)) +
  geom_count(aes(size=site_n)) +
  geom_smooth(method="lm")

age_effects.plt <- delta_sum.df_merged %>%
  ggplot(aes(x=site_mean_age_yrs, y=(site_mean_abs.delta*100))) +
  geom_count(aes(size=site_n, color=sex_prop_Female)) +
  paletteer::scale_color_paletteer_c("ggthemes::Blue", name = "Proportion \nFemale") +
  geom_smooth(method="lm", color="#2A5783FF") +
  theme_linedraw(base_size = 11) +
  labs(size="site N", x = "Mean Age (Years)", y = "Mean Absolute Difference in Centile Scores")

# skim(delta_sum.df_piv) #some missing data! check on this!
```

are studies w older subjects changing more because there are fewer of them?
check for association between study size and age
```{r}
summary(lm(site_mean_age_yrs ~ site_n, data=delta_sum.df_merged)) #study size is associated with age, but assoc. remains when controlling for size
```

```{r}
cent_deltas_df %>%
  ggplot() +
  geom_histogram(aes(x=age_days))
```

delta ~ % female

```{r}
# %female
summary(lm(site_mean_abs.delta ~ sex_prop_Female, data=delta_sum.df_merged))
summary(lm(site_mean_delta ~ sex_prop_Female, data=delta_sum.df_merged))
summary(lm(site_mean_delta ~ sex_prop_Female + site_n, data=delta_sum.df_merged)) #add site size covariate
summary(lm(site_mean_delta ~ sex_prop_Female + site_n + site_mean_age, data=delta_sum.df_merged)) #add site size & age covariates
full.delta.sex.fit <- lm((100*site_mean_delta) ~ sex_prop_Female + site_n + site_mean_age, data=delta_sum.df_merged) #scaling for plot

sjPlot::plot_model(full.delta.sex.fit, type = "pred", terms = "sex_prop_Female") 
```

```{r}
delta_sum.by.sex.df %>%
  ggplot(aes(x=sex, y=(mean_delta*100), color=as.factor(majority), fill=as.factor(majority))) +
  geom_count(aes(shape=as.factor(majority), size=sex_prop), alpha=0.5) +
  geom_line(aes(group=site))

sex_effects.plt <- delta_sum.df_merged %>%
  ggplot(aes(x=sex_prop_Female, y=(site_mean_delta*100))) +
  geom_count(aes(size=site_n, color=site_mean_age_yrs)) +
  geom_smooth(method="lm", color="#24693DFF") +
  paletteer::scale_color_paletteer_c("ggthemes::Green", name = "Mean Age \n(Years)") +
  theme_linedraw(base_size = 11) +
  labs(size="site N", x = "Proportion Female", y = "Mean Difference in Centile Scores")

delta_sum.by.sex.df %>%
  ggplot(aes(x=sex, y=(mean_delta*100))) +
  geom_boxplot()
```

```{r}
# age*%female
summary(lm(site_mean_abs.delta ~ site_mean_age_yrs*sex_prop_Female, data=delta_sum.df_merged))
summary(lm(site_mean_delta ~ site_mean_age_yrs*sex_prop_Female, data=delta_sum.df_merged))
```

## Plots

```{r}
cent_deltas_df %>%
  ggplot(aes(x=age_days, y=(delta.GMV*100))) +
  geom_point(alpha=0.4) +
  geom_smooth(method="lm")

cent_deltas_df %>%
  ggplot(aes(x=delta.lh_SA_fusiform*100, color=sex, fill=sex)) +
  geom_histogram(aes(y=after_stat(c(
      count[group==1]/sum(count[group==1]),
      count[group==2]/sum(count[group==2])
    )*100)), alpha=0.4, position="identity", bins=60) +
  ylab("Percentage")

cent_deltas_df %>%
  ggplot(aes(x=age_days, y=delta.rh_Vol_supramarginal*100, color=sex, fill=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth(method="lm")

cent_deltas_df %>%
  ggplot(aes(x=age_days, y=delta.rh_Vol_temporalpole*100, color=sex, fill=sex)) +
  geom_point(alpha=0.4) +
  geom_smooth(method="lm")
```

#Site Effects

Test to see if centile score is associated with site in either ComBatLS or ComBat-GAM harmonized data.

## ComBat-GAM

```{r}
#clean predictions
gam_centile_df.clean <- gam_centile_df %>%
  mutate(study=sub("\\_.*", "", site),
         age_years=age_days/365.25) %>%
  dplyr::select(!contains(".z") & !ends_with("_total") & !contains("TBV")) #drop z-scores and non-centiles

skim(gam_centile_df.clean)
```

w/in feature ANOVAs

```{r}
gam.feat_to_test <- intersect(pheno_list, names(gam_centile_df.clean))

df_gam_feat_aov <- data.frame()
for(pheno in gam.feat_to_test){
  # print(pheno)
  df <- tidy(aov(gam_centile_df.clean[[pheno]] ~ gam_centile_df.clean[["site"]]))
  df$pheno <- pheno
  df_gam_feat_aov <- rbind(df_gam_feat_aov, df)
}

df_gam_feat_aov.study <- df_gam_feat_aov %>%
  dplyr::filter(term != "Residuals") %>%
  dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(gam.feat_to_test)), #apply fdr correction across all phenos tested
                  sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE))
df_gam_feat_aov.study %>%
  ggplot() +
  geom_bar(aes(y=sig_fdr))
```

Test single pheno

```{r}
gam_centile_df.clean %>%
  ggplot() +
  geom_boxplot(aes(x=site, y=WMV)) +
  theme(axis.text.x = element_text(angle=90, hjust=0.5))

summary(lm(WMV ~ site + age_days + sex, data = gam_centile_df.clean))
```

average w/in subject

```{r}
gam_centile_df.mean <- gam_centile_df.clean %>%
  pivot_longer(cols=any_of(pheno_list), names_to="pheno", values_to = "centile") %>%
  group_by(participant) %>%
  summarize(study = unique(study),
            site = unique(site),
            age_days=unique(age_days),
            sex=unique(sex),
            mean_cent=mean(centile))
nrow(gam_centile_df.mean) == n_unique(gam_centile_df.mean$participant)
```

```{r}
gam_centile_df.mean %>%
  ggplot() +
  geom_boxplot(aes(x=site, y=mean_cent)) +
  theme(axis.text.x = element_text(angle=90, hjust=0.5))

gam_centile_df.mean %>%
  ggplot() +
  geom_boxplot(aes(x=study, y=mean_cent)) +
  theme(axis.text.x = element_text(angle=90, hjust=0.5))

gam_centile_df.mean %>%
  ggplot() +
  geom_point(aes(x=age_days/365.25, y=mean_cent, color=site), alpha=0.5) +
  geom_smooth(aes(x=age_days/365.25, y=mean_cent), method="lm") +
  theme(legend.position = "none") +
  facet_wrap(~study)
```

linear model

```{r}
summary(lm(mean_cent ~ site, data=gam_centile_df.mean))
summary(lm(mean_cent ~ study, data=gam_centile_df.mean))

summary(aov(mean_cent ~ site, data=gam_centile_df.mean))
```

success!

###Z-Scores

```{r}
#clean predictions
gam_z_df.clean <- gam_centile_df %>%
  mutate(study=sub("\\_.*", "", site),
         age_years=age_days/365.25) %>%
  dplyr::select(!any_of(pheno_list) & !ends_with("_total") & !contains("TBV")) #drop z-scores and non-centiles
```

w/in feature ANOVAs

```{r}
gam.feat_to_test.z <- paste0(gam.feat_to_test, ".z")
df_gam_feat_aov.z <- data.frame()
for(pheno in gam.feat_to_test.z){
  # print(pheno)
  df <- tidy(aov(gam_z_df.clean[[pheno]] ~ gam_z_df.clean[["site"]]))
  df$pheno <- pheno
  df_gam_feat_aov.z <- rbind(df_gam_feat_aov.z, df)
}

df_gam_feat_aov.z.study <- df_gam_feat_aov.z %>%
  dplyr::filter(term != "Residuals") %>%
  dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(gam.feat_to_test.z)), #apply fdr correction across all phenos tested
                  sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE))
df_gam_feat_aov.z.study %>%
  ggplot() +
  geom_bar(aes(y=sig_fdr))
```

average w/in subject

```{r}
gam_z_df.mean <- gam_z_df.clean %>%
  pivot_longer(cols=any_of(pheno_list.z), names_to="pheno", values_to = "z_score") %>%
  group_by(participant) %>%
  summarize(study = unique(study),
            site = unique(site),
            age_days=unique(age_days),
            sex=unique(sex),
            mean_z=mean(z_score))
nrow(gam_z_df.mean) == n_unique(gam_z_df.clean$participant)
```

```{r}
gam_z_df.mean %>%
  ggplot() +
  geom_point(aes(x=age_days/365.25, y=mean_z), alpha=0.5) +
  geom_smooth(aes(x=age_days/365.25, y=mean_z), method="lm") 
# +
#   facet_wrap(~study)
```

linear model

```{r}
summary(lm(mean_z ~ site, data=gam_z_df.mean))
summary(lm(mean_z ~ study, data=gam_z_df.mean))

summary(aov(mean_z ~ study, data=gam_z_df.mean))
```


##ComBatLS

```{r}
#clean predictions
gamlss_centile_df.clean <- gamlss_centile_df %>%
  mutate(study=sub("\\_.*", "", site),
         age_years=age_days/365.25) %>%
  dplyr::select(!contains(".z") & !ends_with("_total") & !contains("TBV")) #drop z-scores and non-centiles
```

```{r}
gamlss_centile_df.clean %>%
  ggplot() +
  geom_boxplot(aes(x=study, y=WMV))

wmv_cent_gamlss.lm <- lm(WMV ~ study + age_days + sex, data=gamlss_centile_df.clean)

# gtsummary::tbl_regression(wmv_cent_gamlss.lm) %>%
#   gtsummary::add_global_p()

gamlss_centile_df.clean %>%
  ggplot() +
  geom_boxplot(aes(x=site, y=WMV, fill=study)) +
  theme(axis.text.x = element_text(angle=90), legend.position = "none")
```

w/in feature ANOVAs

```{r}
feat_to_test <- intersect(pheno_list, names(gamlss_centile_df.clean))

df_gamlss_feat_aov <- data.frame()
for(pheno in feat_to_test){
  # print(pheno)
  df <- tidy(aov(gamlss_centile_df.clean[[pheno]] ~ gamlss_centile_df.clean[["site"]]))
  df$pheno <- pheno
  df_gamlss_feat_aov <- rbind(df_gamlss_feat_aov, df)
}

df_gamlss_feat_aov.study <- df_gamlss_feat_aov %>%
  dplyr::filter(term != "Residuals") %>%
  dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(feat_to_test)), #apply fdr correction across all phenos tested
                  sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE))
df_gamlss_feat_aov.study %>%
  ggplot() +
  geom_bar(aes(y=sig_fdr))

df_gamlss_feat_aov.study %>%
  dplyr::filter(sig_fdr==TRUE)
```
average w/in subject

```{r}
gamlss_centile_df.mean <- gamlss_centile_df.clean %>%
  pivot_longer(cols=any_of(pheno_list), names_to="pheno", values_to = "centile") %>%
  group_by(participant) %>%
  summarize(study = unique(study),
            site = unique(site),
            age_days=unique(age_days),
            sex=unique(sex),
            log_age=unique(log_age),
            sexMale=unique(sexMale),
            fs_version=unique(fs_version),
            mean_cent=mean(centile))
nrow(gamlss_centile_df.mean) == n_unique(gamlss_centile_df.mean$participant)
```

```{r}
gamlss_centile_df.mean %>%
  ggplot() +
  geom_boxplot(aes(x=reorder(site, age_days), y=mean_cent)) + 
  theme(axis.text.x = element_text(angle=90))

gamlss_centile_df.mean %>%
  ggplot() +
  geom_boxplot(aes(x=reorder(study, age_days), y=mean_cent)) + 
  theme(axis.text.x = element_text(angle=90))

gamlss_centile_df.mean %>%
  ggplot() +
  geom_point(aes(x=age_days/365.25, y=mean_cent, color=site), alpha=0.5) +
  geom_smooth(aes(x=age_days/365.25, y=mean_cent), method="lm") +
  theme(legend.position = "none") +
  facet_wrap(~study)

gamlss_centile_df.mean %>%
  ggplot() +
  geom_boxplot(aes(x=site, y=mean_cent, fill=study)) + 
  theme(axis.text.x = element_text(angle=90), legend.position = "none")
```

linear model

```{r}
summary(lm(mean_cent ~ site, data=gamlss_centile_df.mean))
summary(lm(mean_cent ~ study, data=gamlss_centile_df.mean))

summary(aov(mean_cent ~ site, data=gamlss_centile_df.mean))
```

success!

###Z-Scores

```{r}
#clean predictions
gamlss_z_df.clean <- gamlss_centile_df %>%
  mutate(study=sub("\\_.*", "", site),
         age_years=age_days/365.25) %>%
  dplyr::select(!any_of(pheno_list) & !ends_with("_total") & !contains("TBV")) #drop z-scores and non-centiles
```

w/in feature ANOVAs

```{r}
gamlss.feat_to_test.z <- paste0(feat_to_test, ".z")
df_gamlss_feat_aov.z <- data.frame()
for(pheno in gamlss.feat_to_test.z){
  # print(pheno)
  df <- tidy(aov(gamlss_z_df.clean[[pheno]] ~ gamlss_z_df.clean[["site"]]))
  df$pheno <- pheno
  df_gamlss_feat_aov.z <- rbind(df_gamlss_feat_aov.z, df)
}

df_gamlss_feat_aov.z.study <- df_gamlss_feat_aov.z %>%
  dplyr::filter(term != "Residuals") %>%
  dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(gamlss.feat_to_test.z)), #apply fdr correction across all phenos tested
                  sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE))
df_gamlss_feat_aov.z.study %>%
  ggplot() +
  geom_bar(aes(y=sig_fdr))
```

average w/in subject

```{r}
gamlss_z_df.mean <- gamlss_z_df.clean %>%
  pivot_longer(cols=any_of(pheno_list.z), names_to="pheno", values_to = "z_score") %>%
  group_by(participant) %>%
  summarize(study = unique(study),
            site=unique(site),
            age_days=unique(age_days),
            sex=unique(sex),
            mean_z=mean(z_score))
nrow(gamlss_z_df.mean) == n_unique(gamlss_z_df.clean$participant)
```

```{r}
gamlss_z_df.mean %>%
  ggplot() +
  geom_point(aes(x=age_days/365.25, y=mean_z, color=study), alpha=0.5) +
  geom_smooth(aes(x=age_days/365.25, y=mean_z), method="lm") +
  facet_wrap(~study)
```

linear model

```{r}
summary(lm(mean_z ~ site, data=gamlss_z_df.mean))
summary(lm(mean_z ~ study, data=gamlss_z_df.mean))

summary(aov(mean_z ~ study, data=gamlss_z_df.mean))
```


#FIGURE 4

```{r}
# study demographics
fig5 <- ggarrange(
ggarrange(sample_boxplot, sample_barplot,
          full_boxplot, full_barplot,
          nrow=2, ncol=2, 
          # align = "hv", 
          common.legend = TRUE,
          legend = "bottom",
          widths=c(2, 1),
          heights=c(14, 1)),
# mean effects
ggarrange(age_effects.plt,
sex_effects.plt,
nrow=2, ncol=1,
align="hv",
labels=c("B", "C")),
common.legend=FALSE,
nrow=1, ncol=2,
labels=c("A", NA),
widths=c(1, 1.3)
)

fig5_annotate <- annotate_figure(fig5, top = text_grob("Figure 5. Differences in centile scores of lifespan consortium data when harmonized with ComBat-GAM and ComBatLS", color = "black", hjust = 0, x = 0))
fig5_annotate
ggsave("figs/figure_5.jpeg", fig5_annotate, width=12, height=10, units="in")
```
