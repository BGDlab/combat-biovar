---
title: "UKB Models"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
date: '2023-09-23'
---

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider)

# #pull plotting functions from github
# plot.func.url <- "https://raw.githubusercontent.com/BGDlab/GAMLSS/main/plotting_functions.R?token=GHSAT0AAAAAACGAYP4HZWCTHACGUM6KG2PSZIQUPBA"
# Sys.setenv(GITHUB_PAT = "") #if needed to access private BGDlab GAMLSS repo
# source_url(plot.func.url) #sometimes doesn't work....?

source("/Users/megardn/Desktop/BGD_Repos/GAMLSS/plotting_functions.R")
```

## Load Data

Load UKB Data from Jakob

```{r}
cn_data <- fread(file="data/lifespan_dataset_dkatlas_CNonly.csv")
#table(cn_data$study)
```

Filter

```{r}
ukb_df <- cn_data %>%
  dplyr::filter(study == "UKB") %>%
  mutate(age_yrs = round(age_days/365.25),
         log_age = log(age_days, base=10),
         TBV=(sGMV+GMV+WMV+Ventricles),
         fs_version = as.factor(fs_version),
         sex = as.factor(sex),
         sex_int = as.numeric(case_when(sex == "Male" ~ 0,
                                        sex == "Female" ~ 1)),
         sex.age = sex_int * age_days) %>%
  na.omit() #1 subj has 1 missing val

skim(ukb_df)
n_unique(ukb_df$participant) == nrow(ukb_df) #no duplicate subj
```

Write lists of phenotypes

```{r}
col_list <- colnames(ukb_df)
pheno_list <- col_list[grepl("^lh_|^rh_|^GMV$|^WMV$|^sGMV$|^Ventricles$", col_list)]
length(pheno_list) #total number of models to run

#split by measure type (Vol, SA, CT)
vol_list_global <- c("GMV", "sGMV", "WMV", "Ventricles")
writeLines(vol_list_global, con = "pheno_lists/Vol_list_global.txt")

vol_list_regions <- col_list[grepl("^lh_Vol|^rh_Vol", col_list)]
writeLines(vol_list_regions, con = "pheno_lists/Vol_list_regions.txt")

sa_list <- col_list[grepl("^lh_SA|^rh_SA", col_list)]
writeLines(sa_list, con = "pheno_lists/SA_list.txt")

ct_list <- col_list[grepl("^lh_CT|^rh_CT", col_list)]
writeLines(ct_list, con = "pheno_lists/CT_list.txt")
```

Add brainwide phenotypes!
Summing across regions for volumes (rather than summing GMV, sGMV, etc) for consistency with SA and CT

```{r}
vol_list_regions <- col_list[grepl("^lh_Vol|^rh_Vol", col_list)]

ukb_df_totals <- ukb_df %>%
  mutate(Vol_total=rowSums(select(., .dots=all_of(c(vol_list_regions)))),
         SA_total=rowSums(select(., .dots=all_of(c(sa_list)))),
         CT_total=rowSums(select(., .dots=all_of(c(ct_list)))))

#write data
write_csv(ukb_df_totals, file="data/ukb_CN_data.csv")
```

## EDA

```{r}
ggplot(data=ukb_df, aes(x=age_days)) +
  geom_histogram(aes(fill=sex), alpha=0.6, position="identity")
ggplot(data=ukb_df, aes(x=log_age)) +
  geom_histogram(aes(fill=sex), alpha=0.6, position="identity")

ggplot(data=ukb_df, aes(x=log_age, y=GMV)) +
  geom_point(aes(color=sex), alpha=0.6)
ggplot(data=ukb_df, aes(x=age_days, y=GMV)) +
  geom_point(aes(color=sex), alpha=0.6)
```

Going to stick with age_days since distribution is fairly normal, not lifespan data

```{r}
ggplot(data=ukb_df_totals, aes(x=age_days, y=Vol_total)) +
  geom_point(aes(color=sex), alpha=0.6, position="identity")

ggplot(data=ukb_df_totals, aes(x=age_days, y=TBV)) +
  geom_point(aes(color=sex), alpha=0.6, position="identity") #TBV includes ventricles, WMV, subcortical GMV

ggplot(data=ukb_df_totals, aes(x=age_days, y=CT_total)) +
  geom_point(aes(color=sex), alpha=0.6, position="identity")

ggplot(data=ukb_df_totals, aes(x=age_days, y=SA_total)) +
  geom_point(aes(color=sex), alpha=0.6, position="identity")
```

Look at variances
```{r}
plot.hist.by.sex <- function(data, pheno_list) {

  # Create an empty list to store the ggplot objects
  plots <- list()
  
  # Loop through the list of variables
  for (pheno in pheno_list) {
    # Check if the variable exists in the data frame
    if (!pheno %in% names(data)) {
      warning(paste("Variable '", pheno, "' not found in the data frame. Skipping..."))
      next
    }
    
    # Create a ggplot histogram for the variable
    plot <- ggplot(data, aes(x = .data[[pheno]], fill= sex, color=sex)) +
      geom_histogram(alpha=0.5, position="identity") +
      labs(title = paste("Histogram of", pheno), x = pheno, y = "Frequency")
    
    # Add the plot to the list
    plots[[pheno]] <- plot
  }
  
  # Return the list of ggplot objects
  return(plots)
}
```

center
```{r}
ukb_centered <- ukb_df_totals %>%
  group_by(sex) %>%
  mutate_if(is.numeric, funs(scale(., center=TRUE, scale=FALSE))) %>%
  ungroup()
```

```{r}
# Generate histograms (mean-centered w/in sex)
global_plots <- plot.hist.by.sex(ukb_centered, vol_list_global)

# Print or display the histograms
for (pheno in vol_list_global) {
  print(global_plots[[pheno]])
}
```

```{r}
# Generate histograms (mean-centered w/in sex)
region_vol_plots <- plot.hist.by.sex(ukb_centered, vol_list_regions)

# Print or display the histograms
for (pheno in vol_list_regions) {
  print(region_vol_plots[[pheno]])
}
```

```{r}
# Generate histograms (mean-centered w/in sex)
region_sa_plots <- plot.hist.by.sex(ukb_centered, sa_list)

# Print or display the histograms
for (pheno in sa_list) {
  print(region_sa_plots[[pheno]])
}
```

```{r}
# Generate histograms (mean-centered w/in sex)
region_ct_plots <- plot.hist.by.sex(ukb_centered, ct_list)

# Print or display the histograms
for (pheno in ct_list) {
  print(region_ct_plots[[pheno]])
}
```

## Global Mod Fitting

Try using `stepGAICALL.A()`

```{r}
m1 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(age_days):sex,
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)

m2 <- stepGAICAll.A(m1, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(age_days):sex), k=2) #AIC

m2
summary(m2)
```

seeing if things change when i hard-code a sex*age interaction term

```{r}
m3 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4 <- stepGAICAll.A(m3, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age)), k=2) #AIC

summary(m4)
```

Seems like stepGAICAll handles combined sex.age term better than an interaction
Try adding TBV
```{r}
m3.tbv <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4.tbv <- stepGAICAll.A(Ventricles_mod, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV)), k=2, glim.control(cyc=100)) #AIC
summary(m4.tbv)
```

```{r}
plot_singlestudy_centiles(m4, "GMV", ukb_df, "sex")
```

Let's look at diagnostics
```{r}
plot(m4)
wp(m4, xvar=age_days, n.inter=4) #leptokurtosis (tails fo fitted distribution too light)
dtop(m4)
rqres.plot(m4)

plot(m4.tbv)
wp(m4.tbv, xvar=age_days, n.inter=4) #U-shape: fitted skewness too low
dtop(m4.tbv)
rqres.plot(m4.tbv)
```

# CUBIC Models
Playing around wiht models fit on cubic using `fit_ukb_mod.R`

scp-ing random model to look at (`lh_SA_middletemporal_mod.rds`)

```{r}
lh_SA_middletemporal_mod <- readRDS("ukb/gamlss_objs/lh_SA_middletemporal_mod.rds")
a <- summary(lh_SA_middletemporal_mod)
dim(a)

#sigma coefficients
coef(lh_SA_middletemporal_mod, what="sigma") %>%
  names()

test <- confint(lh_SA_middletemporal_mod)
colnames(test)
rownames(test)
test["sigma.sexMale", "97.5 %"]
df.test <- as.data.frame(test)
df.test$params <- rownames(df.test)
# Remove the row names from the dataframe
rownames(df.test) <- NULL

df.test
#using drop1 to get significance, gamlss book p 125 for df info
#get df from OG model - not sure how this would be affected by using stepGAIC?


str(lh_SA_middletemporal_mod)
lh_SA_middletemporal_mod$sigma.nl.df

#start df with confidence intervals
confint.matrix <- confint(lh_SA_middletemporal_mod)
df <- as.data.frame(confint.matrix) %>%
  rownames_to_column(var = "moment.param") %>%
  mutate(
    moment = sapply(strsplit(moment.param, "\\."), `[`, 1),
    param = sub("^[^.]+\\.", "", moment.param)
  )

#now that we have the moments, add the rest of the summary info
sum.table <- summary(lh_SA_middletemporal_mod)
df2 <- as.data.frame(sum.table) %>%
  rownames_to_column(var = "param")
#check
rownames(sum.table) == df$param

find.param <- function(gamlss.rds.file, moment, string) {
  #USE WITH sapply(USE.NAMES=TRUE) to keep file names with values!
  gamlss.obj <- readRDS(gamlss.rds.file)
  sigma.coeff.list <- coef(gamlss.rds.file, what= moment) %>%
    names()
  any(sapply(sigma.coeff.list, function(x) grepl(string, x, ignore.case = TRUE)))
}
find.param(lh_SA_middletemporal_mod, "sigma", "sex")

readRDS("ukb/gamlss_objs/rh_Vol_parsopercularis_mod.rds")

```

### Sex-effects visualization

load info parsed from models via  `var_parse.sh` (which calls `R_scripts/variance_parser.R`)

```{r}
sigma.df <- read.csv(file="ukb/sigma.csv", row.names=1)
skim(sigma.df)
```

all contain sex in sigma

```{r}
sigma.df<- sigma.df %>%
  mutate(mu_form = as.factor(sub(".*~", "", mu_form)),
         sig_form = as.factor(sig_form),
         nu_form = as.factor(nu_form),
         measure_type = as.factor(case_when(grepl("Vol", region) ~ "Vol",
                                  grepl("CT", region) ~ "CT",
                                  grepl("SA", region) ~ "SA",
                                  TRUE ~ "Global")))

table(sigma.df$sig_form)
table(sigma.df$mu_form)
table(sigma.df$nu_form)
```

Weirdly only nu has variation in terms selected...?

plot sex effects in sigma
```{r}
ggplot(sigma.df, aes(x=sexMale, fill=measure_type)) +
  geom_histogram(alpha=0.6, position = "identity", color="white")
```

Normalize sexMale's beta weight by the overall value of all sigma terms

```{r}
#get betas
file.list <- list.files(path="/Users/megardn/Desktop/BGD_Repos/combat_biovar/ukb/gamlss_objs", pattern="_mod.rds", full.names = TRUE)

betas.mat <- sapply(file.list, get.moment.betas, moment="sigma", USE.NAMES=TRUE)
colnames(betas.mat) <- map(colnames(betas.mat), basename)


```

