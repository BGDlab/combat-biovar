---
title: "UKB Models"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
date: '2023-09-23'
---

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider)

# #pull plotting functions from github
# plot.func.url <- "https://raw.githubusercontent.com/BGDlab/GAMLSS/main/plotting_functions.R?token=GHSAT0AAAAAACGAYP4HZWCTHACGUM6KG2PSZIQUPBA"
# Sys.setenv(GITHUB_PAT = "") #if needed to access private BGDlab GAMLSS repo
# source_url(plot.func.url) #sometimes doesn't work....?

source("/Users/megardn/Desktop/BGD_Repos/GAMLSS/plotting_functions.R")
```

## Load Data

Load UKB Data from Jakob

```{r}
cn_data <- fread(file="data/lifespan_dataset_dkatlas_CNonly.csv")
#table(cn_data$study)
```

Filter

```{r}
ukb_df <- cn_data %>%
  dplyr::filter(study == "UKB") %>%
  mutate(age_yrs = round(age_days/365.25),
         log_age = log(age_days, base=10),
         TBV=(sGMV+GMV+WMV+Ventricles),
         fs_version = as.factor(fs_version),
         sex = as.factor(sex),
         sex_int = as.numeric(case_when(sex == "Male" ~ 0,
                                        sex == "Female" ~ 1)),
         sex.age = sex_int * age_days) %>%
  na.omit() #1 subj has 1 missing val

skim(ukb_df)
n_unique(ukb_df$participant) == nrow(ukb_df) #no duplicate subj

#write data
write_csv(ukb_df, file="data/ukb_CN_data.csv")

col_list <- colnames(ukb_df)
pheno_list <- col_list[grepl("^lh_|^rh_|^GMV$|^WMV$|^sGMV$|^Ventricles$", col_list)]
writeLines(pheno_list, con = "phenotype_list.txt")
```

## EDA

```{r}
ggplot(data=ukb_df, aes(x=age_days)) +
  geom_histogram(aes(fill=sex), alpha=0.6, position="identity")
ggplot(data=ukb_df, aes(x=log_age)) +
  geom_histogram(aes(fill=sex), alpha=0.6, position="identity")

ggplot(data=ukb_df, aes(x=log_age, y=GMV)) +
  geom_point(aes(color=sex), alpha=0.6)
ggplot(data=ukb_df, aes(x=age_days, y=GMV)) +
  geom_point(aes(color=sex), alpha=0.6)
```

Going to stick with age_days since distribution is fairly normal, not lifespan data

## Basic Plot Function

```{r}
mean.tbv.sim <- function(df, s, ageRange){
  tbv_list <- list()
  for (i in ageRange){
      tbv.df <- df %>%
        dplyr::filter(sex == s) %>%
        arrange(age_yrs) %>%
        dplyr::filter(age_yrs >= (i-0.005) & age_yrs <= (i+0.005)) %>%
        summarize(m = mean(TBV, na.rm = TRUE))
      tbv.val <-tbv.df$m
      tbv_list <- append(tbv_list, tbv.val)
  }
  return(unlist(tbv_list))
}

sim.data.ukb <- function(df){
  minAge <- min(df$age_days)
  maxAge <- max(df$age_days)
  ageRange <- seq(minAge, maxAge, 25)  # generate an age range with increments of 25 (since scaling in days)
  
  #sim data
  dataToPredictM <- data.frame(age_yrs=ageRange,
                               sex=c(rep(as.factor("Male"), length(ageRange))),
                               fs_version=c(rep(Mode(df$fs_version), length(ageRange))),
                               study=c(as.factor(rep(Mode(df$study), length(ageRange)))),
                               sex.age_yrs=c(rep(0, length(ageRange))))
  dataToPredictM$TBV <- mean.tbv.sim(df, "Male", ageRange)
  
  dataToPredictF <- data.frame(age_yrs=ageRange,
                               sex=c(rep(as.factor("Female"), length(ageRange))),
                               fs_version=c(rep(Mode(df$fs_version), length(ageRange))),
                               study=c(as.factor(rep(Mode(df$study), length(ageRange)))),
                               sex.age_yrs=ageRange)
  dataToPredictF$TBV <- mean.tbv.sim(df, "Female", ageRange)
  
  # List of centiles for the fan plot
  desiredCentiles <- c(0.1, 0.25, 0.5, 0.75, 0.9)
  
  # return
  sim <- list(ageRange, dataToPredictM, dataToPredictF, desiredCentiles)
  names(sim) <- c("ageRange", "dataToPredictM", "dataToPredictF", "desiredCentiles")
  return(sim)
}


plot_singlestudy_centiles <- function(gamlssModel, phenotype, df, color_var)
{
  #use functions in GAMLSS repo plotting_functions.R to sim and predict
  sim <- sim.data.ukb(df) #simulate data
  pred <- centile_predict(gamlssModel, sim$dataToPredictM, sim$dataToPredictF, sim$ageRange, sim$desiredCentiles) #predict centiles
  
  #extract vals
  ages <- sim$ageRange
  age_col <- df$age_yrs
  male_peak_age <- pred$peak_age_M
  female_peak_age <- pred$peak_age_F
  unit_text <- "(years)"
  
  #plot!
  #sometimes df[,get()] works, sometimes not found...????
  yvar <- df[[phenotype]]
  color_col <- df[[color_var]]
  
  sampleCentileFan <- ggplot() +
    geom_point(aes(x=age_col, y=yvar, color=color_col), alpha=0.3) +
    scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) + 
    geom_line(aes(x=ages, y=pred$fanCentiles_M[[1]]), alpha=0.1) +
    geom_line(aes(x=ages, y=pred$fanCentiles_M[[2]]), alpha=0.3) +
    geom_line(aes(x=ages, y=pred$fanCentiles_M[[3]]), color="#40004BFF") +
    geom_line(aes(x=ages, y=pred$fanCentiles_M[[4]]), alpha=0.3) +
    geom_line(aes(x=ages, y=pred$fanCentiles_M[[5]]), alpha=0.1) +
    geom_line(aes(x=ages, y=pred$fanCentiles_F[[1]]), alpha=0.1) +
    geom_line(aes(x=ages, y=pred$fanCentiles_F[[2]]), alpha=0.3) +
    geom_line(aes(x=ages, y=pred$fanCentiles_F[[3]]), color="#00441BFF") +
    geom_line(aes(x=ages, y=pred$fanCentiles_F[[4]]), alpha=0.3) +
    geom_line(aes(x=ages, y=pred$fanCentiles_F[[5]]), alpha=0.1) +
    geom_point(aes(x=male_peak_age, y=pred$peak_M), color="#40004BFF", size=3) +
    geom_point(aes(x=female_peak_age, y=pred$peak_F), color="#00441BFF", size=3) +
    labs(title=deparse(substitute(gamlssModel))) +
    theme(legend.title = element_blank())+
    xlab(paste("Age at Scan", unit_text)) +
    ylab(deparse(substitute(phenotype)))
  
  print(sampleCentileFan)
}
```

## Global Mod Fitting

Try using `stepGAICALL.A()`

```{r}
m1 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(age_days):sex,
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)

m2 <- stepGAICAll.A(m1, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(age_days):sex), k=2) #AIC

m2
summary(m2)
```

seeing if things change when i hard-code a sex*age interaction term

```{r}
m3 <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4 <- stepGAICAll.A(m3, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age)), k=2) #AIC

summary(m4)
```

Seems like stepGAICAll handles combined sex.age term better than an interaction
Try adding TBV
```{r}
m3.tbv <- gamlss(formula = GMV ~ pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV),
                       sigma.formula = ~  pb(age_days) + sex,
                       nu.formula = ~ 1,
                       control = gamlss.control(n.cyc = 200), 
                       family = BCCG, data=ukb_df, trace = FALSE)
m4.tbv <- stepGAICAll.A(m3, scope=list(lower=~1, upper=~pb(age_days) + sex + fs_version + pb(sex.age) + pb(TBV)), k=2, glim.control(cyc=100)) #AIC
summary(m4.tbv)
```

```{r}
plot_singlestudy_centiles(m4, "GMV", ukb_df, "sex")
```

Let's look at diagnostics
```{r}
plot(m4)
wp(m4, xvar=age_days, n.inter=4) #leptokurtosis (tails fo fitted distribution too light)
dtop(m4)
rqres.plot(m4)

plot(m4.tbv)
wp(m4.tbv, xvar=age_days, n.inter=4) #U-shape: fitted skewness too low
dtop(m4.tbv)
rqres.plot(m4.tbv)
```
