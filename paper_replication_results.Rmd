---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, gdata)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
```

single script to parse outputs & get results (condensed from `ukb_sim.site_analyses.Rmd`)

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/ukb_perm"
base_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar"

pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

pheno_list.z <- paste0(pheno_list, ".z")
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)
z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#also load raw data
ukb_cn_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/ukb_CN_data_simsites.csv")

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
```

## Load Data

Read in subject-wise summary stats (pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_permute/perm_centile_csvs/subject-wise/*.csv' .`)

```{r}
raw_files <- list.files(path = data_path, pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|perm|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("perm_subj_list", df_list)
}
length(perm_subj_list)
perm_subj.df <- bind_rows(perm_subj_list)
```

```{r}
n_perm_list <- lapply(c(1:10), str_pad, 3, pad = "0")
n_perm_list <- paste0("perm-", n_perm_list)
pheno_list.z <- paste0(pheno_list, ".z")
```

## CENTILES

Do each feature's centile abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
cent.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_cent_t_tests_all_out.RDS"))
names(cent.feat.t.test) <- n_perm_list
cent.feat.t.test.df <- bind_rows(cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
  separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

cent.feat.t.test.df %>%
  group_by(comp, smaller_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

**need to prettify table for supplement**

```{r}
comp_names <- c(cf.gam_cf = "ComBat-GAM v. ComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. ComBat w/o Covar")

dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")

cent.test.comp.plt <- cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(smaller_group=factor(smaller_group, levels=c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw()+
  theme(axis.text.x = element_blank()) +
  facet_grid(pheno_cat~comp, scales="free_y", labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  labs(x="Sampling Permutation", y="Feature Count")
ggsave(paste0(base_path, "/figs/perm_cent_test_barplt.jpg"), plot=cent.test.comp.plt, width=15.5, height=6, units="in")
```

```{r}
#look at combatGAM vs combatLS
cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam") %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar() +
  # geom_text(stat='count', aes(label=..count..)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~pheno_cat)

cf.gam_worse <- cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam" & bigger_group == "cf.gamlss") %>%
  group_by(perm) %>%
  summarise(count = n())

median(cf.gam_worse$count)
IQR(cf.gam_worse$count)
```

Plot CT with combatGAM and combatLS on brains

```{r}
ct.t.tests <- cent.feat.t.test.df %>%
  dplyr::filter(comp =="cf.gamlss_cf.gam" & stringr::str_detect(pheno, "CT")) %>%
  mutate(label=gsub("_CT", "", pheno),
         better_fit = case_when(sig_fdr==TRUE & bigger_group == "cf.gam" ~ "cf.gamlss",
                              sig_fdr==TRUE & bigger_group == "cf.gamlss" ~ "cf.gam",
                              sig_fdr==FALSE ~ "NS"))

ct.t.tests_to_plt <- left_join(ct.t.tests, dk.parc)

ct.brain.plt <- ct.t.tests_to_plt %>%
  ggplot() +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
            aes(fill=better_fit)) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank(),
        legend.position="top") +
  scale_fill_manual(values = c(NS= "darkgray", cf.gam = "#3D75C2", cf.gamlss ="#CFB023FF"), name = "Better ComBat Method", labels=dataset_names) +
  facet_wrap(~perm, nrow=2)

ct.t.tests_to_plt.sum <- ct.t.tests_to_plt %>%
  group_by(hemi, region, label, bigger_group) %>%
  summarise(n_worse = sum(sig_fdr)) %>%
  pivot_wider(id_cols=c(hemi, label, region), names_from = bigger_group, values_from=n_worse) %>%
  mutate(cf.gamlss=ifelse(is.na(cf.gamlss), 0, cf.gamlss)) %>%
  mutate(cf.gamlss_minus_cf.gam_better=as.integer(cf.gam-cf.gamlss),
         percent_cf.gamlss_better=(cf.gam/100)*100) %>%
  ungroup()

ct.brain.sum.plt <- ct.t.tests_to_plt.sum %>%
  ggplot() +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
            aes(fill=percent_cf.gamlss_better))  +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  scale_fill_gradient(low="#605210", high= "#e6d16d",  name = "% Replications") +
  labs(title="Replications where ComBatLS recapitulates cortical thickness centiles \nsignificantly better than ComBat-GAM")
```

W/in subj average plots

```{r}
dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
cent.diffs.v.plot <- perm_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_cent_abs.diff, color=perm), scale="count") +
  labs(y= "Mean Magnitude Centile Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  # guides(fill=guide_legend(title="Sampling \nPermutation")) + 
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat configurations replicated 100x") +
  theme(legend.position="none")
cent.diffs.v.plot
ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot, width=11, height=4.5, units="in")
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
cent.subj.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_cent_sex_bias_tests.RDS"))
cent.subj.sex.test.df <- bind_rows(cent.subj.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
cent.subj.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

```{r}
#get range
cent.subj.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset) %>%
  summarize(min_sex_diff = min(median_sex_diff, na.rm=TRUE),
            max_sex_diff = max(median_sex_diff, na.rm=TRUE))

#look by feature type
cent.subj.sex.test.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  mutate(dataset = factor(dataset, levels = c("cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    perm = as.factor(sub("perm-0", "", perm))) %>%
ggplot() +
  geom_histogram(aes(x=median_sex_diff, color=perm, fill=perm), alpha=0.3, position="identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(pheno_cat~dataset, scales="free", labeller = labeller(dataset = as_labeller(dataset_names))) +
  theme_linedraw(base_size=12) +
  theme(legend.position = "none") +
  labs(x="Male - Female Median Centile Errors", y="Number of Features") 
```

Distribution of error medians w/in each pheno category
```{r}
cent.sex.test.med <- cent.subj.sex.test.df %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

t.test.cent.sex.test.med <- cent.sex.test.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(cent.sex.test.med$dataset))*length(unique(cent.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""))

t.test.cent.sex.test.med.filt <- t.test.cent.sex.test.med %>% dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss")

t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

sex_bias_density_plt <- cent.sex.test.med %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=ifelse(t.test.cent.sex.test.med.filt$dataset == "cf.gam", 10.2, 5.5)),
              data = t.test.cent.sex.test.med.filt) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")

cent.sex.test.med %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=ifelse(t.test.cent.sex.test.med$dataset == "cf.gam", 10.2, 5.5)),
              data = t.test.cent.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")
```

plot subj. with averages in extremes 
```{r}
#recalc subject's true mean centiles
raw_mean_cent <- perm_subj.df %>%
  dplyr::filter(dataset=="cf") %>%
  mutate(mean_centile = mean_centile - mean_cent_diff,
        VolGlob_mean_centile = VolGlob_mean_centile - VolGlob_mean_cent_diff,
        VolReg_mean_centile = VolReg_mean_centile - VolReg_mean_cent_diff,
        CT_mean_centile = CT_mean_centile - CT_mean_cent_diff,
        SA_mean_centile = SA_mean_centile - SA_mean_cent_diff) %>%
  dplyr::select(!c(Source_File, contains("diff"))) %>%
  mutate(dataset="raw")

raw_mean_cent %>%
  dplyr::filter(perm=="perm-001") %>%
  dplyr::filter(SA_mean_centile < .2) %>% 
  nrow()

perm_subj.df2 <- full_join(perm_subj.df, raw_mean_cent)

perm_subj.df2_long <- perm_subj.df2 %>%
  rename(allpheno_mean_centile = mean_centile) %>%
  pivot_longer(cols=contains("mean_centile"), names_to="pheno_cat", values_to="mean_centile") %>%
  mutate(pheno_cat = gsub("_mean_centile", "", pheno_cat)) %>%
  mutate(pheno_cat = case_when(pheno_cat == "VolGlob" ~ "Global Volume",
                               pheno_cat == "VolReg" ~ "Regional Volume",
                               pheno_cat == "CT" ~ "Regional CT",
                               pheno_cat == "SA" ~ "Regional SA"))

high_cent.sum <- perm_subj.df2_long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_centile > 0.80) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

low_cent.sum <- perm_subj.df2_long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_centile < 0.20) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

ext_cent.sum <- perm_subj.df2_long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_centile < 0.20 | mean_centile > 0.80) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )
```

```{r}
#get raw vals for horizontal lines
high_cent.sum_raw <- high_cent.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

low_cent.sum_raw <- low_cent.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

ext_cent.sum_raw <- ext_cent.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

#test significance
get_t_tests <- function(df, raw_df){
  #df <- df_list[[cat]]
  cat <- unique(df$pheno_cat)
  #print(cat)
  mu <- raw_df$female_ratio[which(raw_df$pheno_cat == cat)]
  #print(mu)
  out <- df %>%
    dplyr::filter(dataset != "raw") %>%
    group_by(dataset) %>%
    summarise(p_val = t.test(female_ratio, mu=mu)$p.val,
              pheno_cat = cat,
              max_val = max(female_ratio),
              mu=mu) %>%
    mutate(p.val_fdr = p.adjust(p_val, method="fdr", n = (4*4*3)), #adjusting for 4 methods * 4 pheno classes * 3 centile categories
           sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ "NS"))
  return(out)
}

high_t_test.df <- lapply(split(high_cent.sum, high_cent.sum$pheno_cat), get_t_tests, raw_df=high_cent.sum_raw) %>% bind_rows()
low_t_test.df <- lapply(split(low_cent.sum, low_cent.sum$pheno_cat), get_t_tests, raw_df=low_cent.sum_raw) %>% bind_rows()
ext_t_test.df <- lapply(split(ext_cent.sum, ext_cent.sum$pheno_cat), get_t_tests, raw_df=ext_cent.sum_raw) %>% bind_rows()

#merge dfs
all_cent_sum.df <- gdata::combine(high_cent.sum, low_cent.sum, ext_cent.sum) %>%
  mutate(source = gsub("_cent.sum", "", source))
all_cent.sum_raw <- all_cent_sum.df %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

all_t_test.df <- gdata::combine(high_t_test.df, low_t_test.df, ext_t_test.df) %>%
  mutate(source = gsub("_t_test.df", "", source))

#scale by raw value
all_cent_sum.df_scaled <- all_cent_sum.df %>%
  mutate(dataset = factor(dataset, levels=c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
  arrange(dataset) %>%
  group_by(source, pheno_cat) %>%
  mutate(female_ratio_sc = female_ratio/first(female_ratio),
         female_ratio_diff = female_ratio - first(female_ratio))

#plots!
all_cent_sum.df %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y") +
  geom_hline(data=all_cent.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = max_val + 0.01),
              data = all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"),  name = "ComBat Configuration", labels=dataset_names) + 
  theme_linedraw()

cent_ext_list <- c(ext = ">80% and <20%", high = ">80%", low = "<20%")

all_cent_sum_boxplt <- all_cent_sum.df %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(data=all_cent.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  # geom_text(aes(label = sig_fdr, y = max_val + 0.01),
  #             data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Proportion Female", x = "Dataset")

all_cent_sum.df_scaled %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_sc)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(yintercept=1, linetype="dashed")+
  # geom_text(aes(label = sig_fdr, y = max_val + 0.01),
  #             data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")

all_cent_sum_boxplt.diff <- all_cent_sum.df_scaled %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  # geom_text(aes(label = sig_fdr, y = max_val + 0.01),
  #             data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")

all_cent_sum_boxplt_wtest <- all_cent_sum.df %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(data=all_cent.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = max_val + 0.01),
              data = all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Proportion Female", x = "Dataset")

```

linear ComBat ~ too few women with high centiles, too many women with low centiles; ~ balances out overall

ComBat-GAM -> variable pattern, pretty close to raw

ComBatLS -> pretty close to raw!


### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.cent.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_t_tests_all_out.RDS"))
names(noext.cent.feat.t.test) <- n_perm_list
noext.cent.feat.t.test.df <- bind_rows(noext.cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

noext.cent.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.cent.t.test.df2 <- noext.cent.feat.t.test.df %>%
  mutate(full_df = 0)
cent.feat.t.test.df2 <- cent.feat.t.test.df %>%
  mutate(full_df = 1)

comp.df <- full_join(noext.cent.t.test.df2, cent.feat.t.test.df2)
comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.sex.test.list <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_sex_bias_tests.RDS"))
noext.sex.test.df <- bind_rows(noext.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-differences

```{r}
noext.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category
```{r}
noext.sex.testmed <- noext.sex.test.df %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

next.t.test.cent.sex.test.med <- noext.sex.testmed %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(cent.sex.test.med$dataset))*length(unique(cent.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""))


t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

next.t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

noext.sex.testmed %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=ifelse(t.test.cent.sex.test.med$dataset == "cf.gam", 10.2, 5.5)),
              data = next.t.test.cent.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")
```

## Z-SCORES

Do each feature's z-score abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
z.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_z_t_tests_all_out.RDS"))
names(z.feat.t.test) <- n_perm_list
z.feat.t.test.df <- bind_rows(z.feat.t.test, .id="perm") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_blank()) +
  facet_grid(pheno_cat~comp, scales="free_y", labeller = labeller(comp = as_labeller(comp_names)))
```

look at combatGAM vs combatLS

```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam") %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~pheno_cat)

z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam") %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar(position='fill') +
  geom_hline(yintercept = .5) +
  theme(axis.text.x = element_blank()) +
  facet_wrap(~pheno_cat)
```

W/in subj average plots

```{r}
z.diffs.v.plot <- perm_subj.df %>%
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_z_abs.diff, color=perm), scale="count") +
  labs(y= "Mean Absolute Z-Score Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  theme(legend.position = "none") +
  ggtitle("Within-subject mean magnitude of error in z scores across ComBat \nconfigurations replicated 10x")
z.diffs.v.plot
# ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot)
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
z.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_z_sex_bias_tests.RDS"))
z.sex.test.df <- bind_rows(z.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
z.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category
```{r}
z.sex.test.med <- z.sex.test.df %>%
  mutate(pheno = gsub(".z", "", pheno)) %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

t.test.z.sex.test.med <- z.sex.test.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(z.sex.test.med$dataset))*length(unique(z.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""))

t.test.z.sex.test.med.filt <- t.test.z.sex.test.med %>% dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss")

t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

z.sex_bias_density_plt <- z.sex.test.med %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=ifelse(t.test.z.sex.test.med.filt$dataset == "cf.gam", 350, 120)),
              data = t.test.z.sex.test.med.filt) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Z Errors", y="Density Across 100 Replications")

z.sex.test.med %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=ifelse(t.test.z.sex.test.med$dataset == "cf.gam", 350, 120)),
              data = t.test.z.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Z Errors", y="Density Across 100 Replications")
```

plot subj. with averages in extremes 
```{r}
#recalc subject's true mean zs
raw_mean_z <- perm_subj.df %>%
  dplyr::filter(dataset=="cf") %>%
  mutate(mean_z = mean_z - mean_z_diff,
        VolGlob_mean_z = VolGlob_mean_z - VolGlob_mean_z_diff,
        VolReg_mean_z = VolReg_mean_z - VolReg_mean_z_diff,
        CT_mean_z = CT_mean_z - CT_mean_z_diff,
        SA_mean_z = SA_mean_z - SA_mean_z_diff) %>%
  dplyr::select(!c(contains("diff"), contains("centile"))) %>%
  mutate(dataset="raw")

raw_mean_z %>%
  dplyr::filter(perm=="perm-001") %>%
  dplyr::filter(SA_mean_z > 1.5) %>% 
  nrow()

perm_subj.df.z <- full_join(perm_subj.df, raw_mean_z)

perm_subj.df.z._long <- perm_subj.df.z %>%
  rename(allpheno_mean_z = mean_z) %>%
  pivot_longer(cols=contains("mean_z"), names_to="pheno_cat", values_to="mean_z") %>%
  mutate(pheno_cat = gsub("_mean_z", "", pheno_cat)) %>%
  mutate(pheno_cat = case_when(pheno_cat == "VolGlob" ~ "Global Volume",
                               pheno_cat == "VolReg" ~ "Regional Volume",
                               pheno_cat == "CT" ~ "Regional CT",
                               pheno_cat == "SA" ~ "Regional SA"))

high_z.sum <- perm_subj.df.z._long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_z > 1.5) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

low_z.sum <- perm_subj.df.z._long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_z < -1.5) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

ext_z.sum <- perm_subj.df.z._long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_z < -1.5 | mean_z > 1.5) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )
```

```{r}
#get raw vals for horizontal lines
high_z.sum_raw <- high_z.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

low_z.sum_raw <- low_z.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

ext_z.sum_raw <- ext_z.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

z.high_t_test.df <- lapply(split(high_z.sum, high_z.sum$pheno_cat), get_t_tests, raw_df=high_z.sum_raw) %>% bind_rows()
z.low_t_test.df <- lapply(split(low_z.sum, low_z.sum$pheno_cat), get_t_tests, raw_df=low_z.sum_raw) %>% bind_rows()
z.ext_t_test.df <- lapply(split(ext_z.sum, ext_z.sum$pheno_cat), get_t_tests, raw_df=ext_z.sum_raw) %>% bind_rows()

#merge dfs
all_z_sum.df <- gdata::combine(high_z.sum, low_z.sum, ext_z.sum) %>%
  mutate(source = gsub("_z.sum", "", source))
all_z.sum_raw <- all_z_sum.df %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

z.all_t_test.df <- gdata::combine(z.high_t_test.df, z.low_t_test.df, z.ext_t_test.df) %>%
  mutate(source = gsub("_t_test.df", "", source)) %>%
  mutate(source = gsub("z.", "", source))

#scale by raw value
all_z_sum.df_scaled <- all_z_sum.df %>%
  mutate(dataset = factor(dataset, levels=c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
  arrange(dataset) %>%
  group_by(source, pheno_cat) %>%
  mutate(female_ratio_sc = female_ratio/first(female_ratio),
         female_ratio_diff = female_ratio - first(female_ratio))

#plots!
all_z_sum.df %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y") +
  geom_hline(data=all_z.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = max_val + 0.01),
              data = z.all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"),  name = "ComBat Configuration", labels=dataset_names) + 
  theme_linedraw()

z_ext_list <- c(ext = ">1.5 and <-1.5", high = ">1.5", low = "<-1.5")

all_z_sum.df_scaled %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=z_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  # geom_text(aes(label = sig_fdr, y = max_val + 0.01),
  #             data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")

all_z_sum.df_scaled %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=z_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = .07),
              data = z.all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Proportion Female", x = "Dataset")
```


### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.z.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_z_t_tests_all_out.RDS"))
names(noext.z.feat.t.test) <- n_perm_list
noext.z.feat.t.test.df <- bind_rows(noext.z.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

noext.z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.z.t.test.df2 <- noext.z.feat.t.test.df %>%
  mutate(full_df = 0)
z.feat.t.test.df2 <- z.feat.t.test.df %>%
  mutate(full_df = 1)

z.comp.df <- full_join(noext.z.t.test.df2, z.feat.t.test.df2)
z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.sex.test.z.list <- readRDS(paste0(data_path, "/no.ext_featurewise_z_sex_bias_tests.RDS"))
noext.sex.test.z.df <- bind_rows(noext.sex.test.z.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
noext.sex.test.z.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category
```{r}
noext.sex.test.z.med <- noext.sex.test.z.df %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

next.t.test.z.sex.test.med <- noext.sex.test.z.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(z.sex.test.med$dataset))*length(unique(z.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""))


t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

next.t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

noext.sex.test.z.med %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=ifelse(next.t.test.z.sex.test.med$dataset == "cf.gam", 320, 100)),
              data = next.t.test.z.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in zile Errors", y="Density Across 100 Replications")
```


## FIGURE 3
```{r}
blank <- ggplot() + theme_void()
sex.var.plot.global <- readRDS("figs/sex_var_plot_global.RDS")
sex.var.plot <- readRDS("figs/sex_var_plot.RDS")

fig_3 <- ggarrange(
  ggarrange(
  ggarrange(blank, sex.var.plot.global, sex.var.plot,
  ncol=3, nrow=1, 
  widths = c(.1, .8, 3.1),
  hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  ),
  sex_bias_density_plt,
  nrow=2, ncol=1,
  labels=c("A", "B")
  ),
  all_cent_sum_boxplt.diff,
  ncol=2, nrow=1,
  labels=c(NA, "C"),
  widths = c(1, 1)
  # #align = "hv",
  # heights=c(1, 1.8),
  # common.legend = FALSE,
  # #labels=c("A", "B")
  )

fig_3
ggsave("figs/figure_3.jpeg", fig_3, width=15, height=10, units="in")
```

## Supplemental Fig
```{r}
sfig <- ggarrange(cent.test.comp.plt, ct.brain.sum.plt,
                  ncol=1, nrow=2, heights = c(2, 1))
sfig
ggsave(paste0(base_path, "/figs/combat_abs_errs_supp_plt.jpg"), plot=sfig, width=11, height=7, units="in")

```

Figure 3 but with sig. tests for boxplots

```{r}
fig_3_wtest <- ggarrange(
  ggarrange(
  ggarrange(sex.var.plot.global, sex.var.plot,
  ncol=2, nrow=1, 
  widths = c(1, 3.25),
  hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  ),
  sex_bias_density_plt,
  nrow=2, ncol=1,
  labels=c("A", "B")
  ),
  all_cent_sum_boxplt_wtest,
  ncol=2, nrow=1,
  labels=c(NA, "C"),
  widths = c(1, 1.8)
  # #align = "hv",
  # heights=c(1, 1.8),
  # common.legend = FALSE,
  # #labels=c("A", "B")
  )

fig_3_wtest
ggsave("figs/figure_3_wtest.jpeg", fig_3, width=15, height=10, units="in")
```