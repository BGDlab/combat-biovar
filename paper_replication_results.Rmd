---
title: "ComBatLS Replication Results"
output: html_document
date: '2023-11-12'
---

Rmd to compile and visualize tests of ComBatLS against other harmonization methods when replicating site simulations 100x. 

Relies on outputs derived/functions from:

1. `ukb_curation-eda.Rmd`
2. `run_permutation_pipeline.sh`
   - `R_scripts/permute_sites.R`
   - `R_scripts/combat_apply.R`
   - `R_scripts/fit_perm_basic_mod.R`
   - `R_scripts/fit_centiles.R`
   - `R_scripts/summarise_cent_subj-wise.R`
3. `run_permutation_stats.sh`
   - `R_scripts/summarise_cent_subj-wise.R`
   - `R_scripts/ratio_results.R`
   - `R_scripts/featurewise_sex_bias_test.R`
   - `R_scripts/remove_extremes_single.R`
4. `pull_stats.sh`

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, gdata, gtExtras, webshot2) #ggsegExtra
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")
remotes::install_github("BGDlab/ggseg-tissueclass-atlas")
```

single script to parse outputs & get results (condensed from `ukb_sim.site_analyses.Rmd`)

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/ukb_perm"
base_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar"

pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

pheno_list.z <- paste0(pheno_list, ".z")
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)
z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#also load raw data
ukb_cn_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/ukb_CN_data_simsites.csv")

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
```

## Load Data

Read in subject-wise summary stats (pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_permute/perm_centile_csvs/subject-wise/*.csv' .`)

```{r}
raw_files <- list.files(path = data_path, pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|perm|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("perm_subj_list", df_list)
}
length(perm_subj_list)
perm_subj.df <- bind_rows(perm_subj_list)
```

```{r}
n_perm_list <- lapply(c(1:10), str_pad, 3, pad = "0")
n_perm_list <- paste0("perm-", n_perm_list)
pheno_list.z <- paste0(pheno_list, ".z")
```

## CENTILES

Do each feature's centile abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
cent.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_cent_t_tests_all_out.RDS"))
names(cent.feat.t.test) <- n_perm_list
cent.feat.t.test.df <- bind_rows(cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
  separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

cent.tbl <- cent.feat.t.test.df %>%
  group_by(comp, smaller_group) %>%
  summarize(n_sig=sum(sig_fdr)) %>%
  mutate(perc_tests = n_sig/(208*100))

cent.tbl.pretty <- cent.tbl %>%
  mutate(comp = case_when(comp == "cf.gam_cf" ~ "ComBat-GAM vs ComBat w/o Covariates",
                          comp == "cf.gamlss_cf" ~ "ComBatLS vs ComBat w/o Covariates", 
                          comp == "cf.gamlss_cf.gam" ~ "ComBatLS vs ComBat-GAM",
                          comp == "cf.lm_cf" ~ "Linear ComBat vs ComBat w/o Covariates",
                          comp == "cf.lm_cf.gam" ~ "Linear ComBat vs ComBat-GAM",
                          comp == "cf.lm_cf.gamlss" ~ "Linear ComBat vs ComBatLS"),
         smaller_group = case_when(smaller_group == "cf" ~ "ComBat w/o Covariates",
                                   smaller_group == "cf.lm" ~ "Linear ComBat",
                                   smaller_group == "cf.gam" ~ "ComBat-GAM",
                                   smaller_group == "cf.gamlss" ~ "ComBatLS")) %>%
  rename(#"Pairwise Comparison"=comp,
         "Method Producing Smaller Absolute Errors" = smaller_group,
         "N Features" = n_sig,
         "% Features" = perc_tests)

pretty_cent_table <- cent.tbl.pretty %>%
  gt() %>% 
  #gt_theme_538() %>% 
tab_style(style = list(cell_fill(color = "gray95")),
    locations = cells_row_groups()) %>%
  fmt_percent(
    columns = "% Features",
    decimals = 2
  ) %>%
  tab_options(column_labels.font.weight = "bold") %>%
  tab_header(title = "Pairwise comparisons of ComBat methods' absolute centile errors for 208 brain features across 100 replications")

gtsave(pretty_cent_table, filename="figs/centile_table.png")
```


```{r}
comp_names <- c(cf.gam_cf = "ComBat-GAM v. ComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. ComBat w/o Covar")

dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")

cent.test.comp.plt <- cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(smaller_group=factor(smaller_group, levels=c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom") +
  facet_grid(pheno_cat~comp, scales="free_y", labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  labs(x="Sampling Permutation", y="Feature Count")
```

```{r}
cent.feat.t.test.df %>%
  dplyr::filter(bigger_group=="cf.gamlss" & sig_fdr==TRUE) %>%
  group_by(comp, pheno_cat) %>%
  summarize(count = n())

cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & bigger_group == "cf.gamlss") %>%
  group_by(comp, perm) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(comp) %>%
  summarize(med.count = median(count),
            IQR.count = IQR(count))
```

Plot CT with combatGAM and combatLS on brains

```{r}
ct.t.tests <- cent.feat.t.test.df %>%
  dplyr::filter(pheno_cat == "Regional CT" & grepl("gamlss", comp)) %>%
  mutate(label=gsub("_CT", "", pheno))

ct.t.tests_to_plt <- left_join(ct.t.tests, dk.parc)

ct.t.tests_to_plt.sum <- ct.t.tests_to_plt %>%
  group_by(comp, hemi, region, label, smaller_group) %>%
  summarise(n_better = sum(sig_fdr)) %>%
  mutate(perc.better=n_better/100) %>% #make NAs into 0s
  ungroup() %>%
  pivot_wider(id_cols=c(comp, hemi, label, region), names_from = smaller_group, values_from=perc.better) %>%
  dplyr::select(!c(cf, cf.lm, cf.gam))

min(ct.t.tests_to_plt.sum$cf.gamlss)

comp_names <- c(cf.gamlss_cf = "vs. ComBat w/o Covar", cf.lm_cf.gamlss = "vs. linear ComBat", cf.gamlss_cf.gam ="vs. ComBat-GAM")

ct.brain.sum.plt <- ct.t.tests_to_plt.sum %>%
  mutate(comp=as.character(comp)) %>%
  ggplot() +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
            aes(fill=cf.gamlss))  +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  scale_fill_gradient(low="#605210", high= "#EFE2A2",  name = "Proportion Replications", limits = c(.5, 1), breaks=c(0.50, 0.75, 1.00)) +
  facet_wrap(~comp, labeller = labeller(comp = as_labeller(comp_names)))
ct.brain.sum.plt
```

W/in subj average plots

```{r}
dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
cent.diffs.v.plot <- perm_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_cent_abs.diff, color=perm), scale="count") +
  labs(y= "Mean Magnitude Centile Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  # guides(fill=guide_legend(title="Sampling \nPermutation")) + 
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat configurations replicated 100x") +
  theme_linedraw() + 
  theme(legend.position="none")
cent.diffs.v.plot
ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot, width=11, height=4.5, units="in")
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
cent.subj.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_cent_sex_bias_tests.RDS"))
cent.subj.sex.test.df <- bind_rows(cent.subj.sex.test.list)
```

simple bar-plot to count regions w significant sex-biases

```{r}
cent.subj.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

```{r}
#get range
cent.subj.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset) %>%
  summarize(min_sex_diff = min(median_sex_diff, na.rm=TRUE),
            max_sex_diff = max(median_sex_diff, na.rm=TRUE))

#look by feature type
sex_bias_hist_plt <- cent.subj.sex.test.df %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    perm = as.factor(sub("perm-0", "", perm))) %>%
ggplot() +
  geom_histogram(aes(x=median_sex_diff, color=perm, fill=perm), alpha=0.3, position="identity", bins=40) +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(pheno_cat ~ dataset, scales="free", labeller = labeller(dataset = as_labeller(dataset_names))) +
  theme_linedraw(base_size=12) +
  theme(legend.position = "none") +
  labs(x="Male - Female Median Centile Errors", y="Number of Features")
ggsave(filename="figs/sex_bias_hist_plt.png", sex_bias_hist_plt, height=7, width=10, units="in")
```

Distribution of error medians w/in each pheno category
```{r}
cent.sex.test.med <- cent.subj.sex.test.df %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

#t-test of median sex diffs in centile error distributions vs 0
t.test.cent.sex.test.med <- cent.sex.test.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            t.test.stat = tidy(t.test(median_of_median_sex_diff))$statistic,
            t.test.df = tidy(t.test(median_of_median_sex_diff))$parameter,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(cent.sex.test.med$dataset))*length(unique(cent.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""),
         y_pos = case_when(dataset=="cf" ~ 9.3,
                           dataset=="cf.lm" ~ 11,
                           dataset=="cf.gam" ~ 10.5,
                           dataset=="cf.gamlss" ~ 6))
#get vals
t.test.cent.sex.test.med_tbl <- t.test.cent.sex.test.med %>%
  dplyr::select(dataset, pheno_cat, t.test.est, t.test.stat, t.test.df, p.val_fdr, sig_fdr) %>%
  mutate(dataset = case_when(dataset == "cf" ~ "ComBat w/o Covariates",
                                   dataset == "cf.lm" ~ "Linear ComBat",
                                   dataset == "cf.gam" ~ "ComBat-GAM",
                                   dataset == "cf.gamlss" ~ "ComBatLS")) %>%
  rename("ComBat Method" = dataset,
         "Phenotype Category" = pheno_cat,
         "Estimate" = t.test.est,
         "t-statistic" = t.test.stat,
         "dfs" = t.test.df,
         "p-value (FDR-corrected)" = p.val_fdr,
         "Significance" = sig_fdr) %>%
  gt() %>%
  tab_style(style = list(cell_fill(color = "gray95")),
    locations = cells_row_groups()) %>%
  tab_options(column_labels.font.weight = "bold") %>%
  tab_header(title = "One-sided t-tests of sex differences in centile errors across 100 replications")
gtsave(t.test.cent.sex.test.med_tbl, filename="figs/cent_median_sexdiff_table.png")
```

plots
```{r}
t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

t.test.cent.sex.test.med.filt <- t.test.cent.sex.test.med %>% dplyr::filter(dataset != "cf")

sex_bias_density_plt <- cent.sex.test.med %>%
  dplyr::filter(dataset != "cf") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=y_pos),
              data = t.test.cent.sex.test.med.filt) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")

#with combat w/o covar
sex_bias_density_plt_full <- cent.sex.test.med %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=y_pos),
              data = t.test.cent.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom") +
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")
ggsave(filename="figs/sex_bias_density_plt_full.png", sex_bias_density_plt_full, height=7, width=10, units="in")
```

plot subj. with averages in extremes 
```{r}
#recalc subject's true mean centiles
raw_mean_cent <- perm_subj.df %>%
  dplyr::filter(dataset=="cf") %>%
  mutate(mean_centile = mean_centile - mean_cent_diff,
        VolGlob_mean_centile = VolGlob_mean_centile - VolGlob_mean_cent_diff,
        VolReg_mean_centile = VolReg_mean_centile - VolReg_mean_cent_diff,
        CT_mean_centile = CT_mean_centile - CT_mean_cent_diff,
        SA_mean_centile = SA_mean_centile - SA_mean_cent_diff) %>%
  dplyr::select(!c(Source_File, contains("diff"))) %>%
  mutate(dataset="raw")

raw_mean_cent %>%
  dplyr::filter(perm=="perm-001") %>%
  dplyr::filter(SA_mean_centile < .2) %>% 
  nrow()

perm_subj.df2 <- full_join(perm_subj.df, raw_mean_cent)

perm_subj.df2_long <- perm_subj.df2 %>%
  rename(allpheno_mean_centile = mean_centile) %>%
  pivot_longer(cols=contains("mean_centile"), names_to="pheno_cat", values_to="mean_centile") %>%
  mutate(pheno_cat = gsub("_mean_centile", "", pheno_cat)) %>%
  mutate(pheno_cat = case_when(pheno_cat == "VolGlob" ~ "Global Volume",
                               pheno_cat == "VolReg" ~ "Regional Volume",
                               pheno_cat == "CT" ~ "Regional CT",
                               pheno_cat == "SA" ~ "Regional SA"))

high_cent.sum <- perm_subj.df2_long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_centile > 0.80) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

low_cent.sum <- perm_subj.df2_long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_centile < 0.20) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )
```

```{r}
#get raw vals for horizontal lines
high_cent.sum_raw <- high_cent.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

low_cent.sum_raw <- low_cent.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

#test significance
get_t_tests <- function(df, raw_df){
  #df <- df_list[[cat]]
  cat <- unique(df$pheno_cat)
  #print(cat)
  mu <- raw_df$female_ratio[which(raw_df$pheno_cat == cat)]
  #print(mu)
  out <- df %>%
    dplyr::filter(dataset != "raw") %>%
    group_by(dataset) %>%
    summarise(p_val = t.test(female_ratio, mu=mu)$p.val,
              pheno_cat = cat,
              max_val = max(female_ratio),
              mu=mu) %>%
    mutate(p.val_fdr = p.adjust(p_val, method="fdr", n = (4*4*2)), #adjusting for 4 methods * 4 pheno classes * 2 centile categories
           sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ "NS"))
  return(out)
}

high_t_test.df <- lapply(split(high_cent.sum, high_cent.sum$pheno_cat), get_t_tests, raw_df=high_cent.sum_raw) %>% bind_rows()
low_t_test.df <- lapply(split(low_cent.sum, low_cent.sum$pheno_cat), get_t_tests, raw_df=low_cent.sum_raw) %>% bind_rows()

#merge dfs
all_cent_sum.df <- gdata::combine(high_cent.sum, low_cent.sum) %>%
  mutate(source = gsub("_cent.sum", "", source))
all_cent.sum_raw <- all_cent_sum.df %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

all_t_test.df <- gdata::combine(high_t_test.df, low_t_test.df) %>%
  mutate(source = gsub("_t_test.df", "", source))

#scale by raw value
all_cent_sum.df_scaled <- all_cent_sum.df %>%
  mutate(dataset = factor(dataset, levels=c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
  arrange(dataset) %>%
  group_by(source, pheno_cat) %>%
  mutate(female_ratio_sc = female_ratio/first(female_ratio),
         female_ratio_diff = female_ratio - first(female_ratio))

y_pos.df <- all_cent_sum.df_scaled %>%
  group_by(source, pheno_cat, dataset) %>%
  summarise(y_pos=max(female_ratio_diff))

all_t_test.df <- full_join(all_t_test.df, y_pos.df) %>%
  dplyr::filter(dataset != "raw")
```

```{r}
#plots!
all_cent_sum.df %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y") +
  geom_hline(data=all_cent.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = max_val + 0.01),
              data = all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"),  name = "ComBat Configuration", labels=dataset_names) + 
  theme_linedraw()

cent_ext_list <- c(high = ">80%", low = "<20%")

all_cent_sum_boxplt.diff <- all_cent_sum.df_scaled %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = (y_pos)), nudge_y=.005,
               data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")

all_cent_sum_boxplt.diff_full <- all_cent_sum.df_scaled %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(source = factor(source, levels=c("low", "high", "ext"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="center") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=cent_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = (y_pos)), nudge_y=.005,
               data = all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")
ggsave(filename="figs/all_cent_sum_boxplt_wtest.png", all_cent_sum_boxplt.diff_full)
```

### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.cent.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_t_tests_all_out.RDS"))
names(noext.cent.feat.t.test) <- n_perm_list
noext.cent.feat.t.test.df <- bind_rows(noext.cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
      separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

noext.cent.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.cent.t.test.df2 <- noext.cent.feat.t.test.df %>%
  mutate(full_df = "No Extremes")
cent.feat.t.test.df2 <- cent.feat.t.test.df %>%
  mutate(full_df = "Full Dataset")

comp.df <- full_join(noext.cent.t.test.df2, cent.feat.t.test.df2)
comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

comp_names <- c(cf.gam_cf = "ComBat-GAM v. \nComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. \nComBat w/o Covar")
cent.test.comp.plt2 <- comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(smaller_group=factor(smaller_group, levels=c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom") +
  facet_grid(comp ~ full_df, labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  labs(x="Sampling Permutation", y="Feature Count")
ggsave(filename="figs/cent_comp_noext.png", cent.test.comp.plt2, height=13, width=13, units="in")

comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.sex.test.list <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_sex_bias_tests.RDS"))
noext.sex.test.df <- bind_rows(noext.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-differences

```{r}
noext.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category
```{r}
noext.sex.testmed <- noext.sex.test.df %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

next.t.test.cent.sex.test.med <- noext.sex.testmed %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(cent.sex.test.med$dataset))*length(unique(cent.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""),
         y_pos = case_when(dataset=="cf" ~ 6,
                           dataset=="cf.lm" ~ 9,
                           dataset=="cf.gam" ~ 9.5,
                           dataset=="cf.gamlss" ~ 5))


t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

next.t.test.cent.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

sex_bias_density_plt_noext <- noext.sex.testmed %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff*100, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos*100, y=y_pos),
              data = next.t.test.cent.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Centile Errors", y="Density Across 100 Replications")
ggsave(filename="figs/sex_bias_density_plt_noext.png", sex_bias_density_plt_noext, height=7, width=10, units="in")
```

## Z-SCORES

Do each feature's z-score abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
z.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_z_t_tests_all_out.RDS"))
names(z.feat.t.test) <- n_perm_list
z.feat.t.test.df <- bind_rows(z.feat.t.test, .id="perm") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
  separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
comp_names <- c(cf.gam_cf = "ComBat-GAM v. ComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. ComBat w/o Covar")

z.feat.t.test.plt <- z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom") +
  labs(x="Sampling Permutation", y="Feature Count") +
  facet_grid(pheno_cat~comp, scales="free_y", labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names)

ggsave(filename="figs/z.feat.t.test.plt.png", z.feat.t.test.plt, height=7, width=13, units="in")
```

look at ratios
```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & grepl("gamlss", comp)) %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar(position='fill') +
  geom_hline(yintercept = .5) +
  theme(axis.text.x = element_blank()) +
  facet_grid(comp~pheno_cat)
```

W/in subj average plots

```{r}
z.diffs.v.plot <- perm_subj.df %>%
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_z_abs.diff, color=perm), scale="count") +
  labs(y= "Mean Absolute Z-Score Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  theme_linedraw()+
  theme(legend.position = "none") +
  ggtitle("Within-subject mean magnitude of error in z scores across ComBat configurations replicated 100x")
z.diffs.v.plot
# ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot)
ggsave(filename="figs/zscore_violin.png", z.diffs.v.plot, width=11, height=4.5, units="in")
```


```{r}
z.tbl <- z.feat.t.test.df %>%
  group_by(comp, smaller_group) %>%
  summarize(n_sig=sum(sig_fdr)) %>%
  mutate(perc_tests = n_sig/(208*100))

z.tbl.pretty <- z.tbl %>%
  mutate(comp = case_when(comp == "cf.gam_cf" ~ "ComBat-GAM vs ComBat w/o Covariates",
                          comp == "cf.gamlss_cf" ~ "ComBatLS vs ComBat w/o Covariates", 
                          comp == "cf.gamlss_cf.gam" ~ "ComBatLS vs ComBat-GAM",
                          comp == "cf.lm_cf" ~ "Linear ComBat vs ComBat w/o Covariates",
                          comp == "cf.lm_cf.gam" ~ "Linear ComBat vs ComBat-GAM",
                          comp == "cf.lm_cf.gamlss" ~ "Linear ComBat vs ComBatLS"),
         smaller_group = case_when(smaller_group == "cf" ~ "ComBat w/o Covariates",
                                   smaller_group == "cf.lm" ~ "Linear ComBat",
                                   smaller_group == "cf.gam" ~ "ComBat-GAM",
                                   smaller_group == "cf.gamlss" ~ "ComBatLS")) %>%
  rename(#"Pairwise Comparison"=comp,
         "Method Producing Smaller Absolute Errors" = smaller_group,
         "N Features" = n_sig,
         "% Features" = perc_tests)

pretty_z_table <- z.tbl.pretty %>%
  gt() %>% 
  #gt_theme_538() %>% 
tab_style(style = list(cell_fill(color = "gray95")),
    locations = cells_row_groups()) %>%
  fmt_percent(
    columns = "% Features",
    decimals = 2
  ) %>%
  tab_options(column_labels.font.weight = "bold") %>%
  tab_header(title = "Pairwise comparisons of ComBat methods' absolute Z-score errors for 208 brain features across 100 replications")

gtsave(pretty_z_table, filename="figs/z_table.png")
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
z.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_z_sex_bias_tests.RDS"))
z.sex.test.df <- bind_rows(z.sex.test.list)
```

simple bar-plot to count regions w significant sex-biases

```{r}
z.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category

```{r}
#look by feature type
z.sex_bias_hist_plt <- z.sex.test.df %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  mutate(pheno = gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    perm = as.factor(sub("perm-0", "", perm))) %>%
ggplot() +
  geom_histogram(aes(x=median_sex_diff, color=perm, fill=perm), alpha=0.3, position="identity", bins=40) +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(pheno_cat~dataset, scales="free", labeller = labeller(dataset = as_labeller(dataset_names))) +
  theme_linedraw(base_size=12) +
  theme(legend.position = "none") +
  labs(x="Male - Female Median Centile Errors", y="Number of Features") +
  ggtitle("Sex differences in median centile errors across 100 sampling replications")
ggsave(filename="figs/z.sex_bias_hist_plt.z.png", sex_bias_hist_plt)
```

```{r}
z.sex.test.med <- z.sex.test.df %>%
  mutate(pheno = gsub(".z", "", pheno)) %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

t.test.z.sex.test.med <- z.sex.test.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            t.test.stat = tidy(t.test(median_of_median_sex_diff))$statistic,
            t.test.df = tidy(t.test(median_of_median_sex_diff))$parameter,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(z.sex.test.med$dataset))*length(unique(z.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""),
         y_pos = case_when(dataset=="cf" ~ 155,
                           dataset=="cf.lm" ~ 360,
                           dataset=="cf.gam" ~ 345,
                           dataset=="cf.gamlss" ~ 125))

#pretty table
t.test.z.sex.test.med_tbl <- t.test.z.sex.test.med %>%
  dplyr::select(dataset, pheno_cat, t.test.est, t.test.stat, t.test.df, p.val_fdr, sig_fdr) %>%
  mutate(dataset = case_when(dataset == "cf" ~ "ComBat w/o Covariates",
                                   dataset == "cf.lm" ~ "Linear ComBat",
                                   dataset == "cf.gam" ~ "ComBat-GAM",
                                   dataset == "cf.gamlss" ~ "ComBatLS")) %>%
  rename("ComBat Method" = dataset,
         "Phenotype Category" = pheno_cat,
         "Estimate" = t.test.est,
         "t-statistic" = t.test.stat,
         "dfs" = t.test.df,
         "p-value (FDR-corrected)" = p.val_fdr,
         "Significance" = sig_fdr) %>%
  gt() %>%
  tab_style(style = list(cell_fill(color = "gray95")),
    locations = cells_row_groups()) %>%
  tab_options(column_labels.font.weight = "bold") %>%
  tab_header(title = "One-sided t-tests of sex differences in z-score errors across 100 replications")
gtsave(t.test.z.sex.test.med_tbl, filename="figs/z_median_sexdiff_table.png")
```

plot
```{r}
t.test.z.sex.test.med.filt <- t.test.z.sex.test.med %>% 
  dplyr::filter(dataset != "cf")

t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

z.sex_bias_density_plt <- z.sex.test.med %>%
  dplyr::filter(dataset != "cf") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=y_pos),
              data = t.test.z.sex.test.med.filt) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "none")+
  labs(x="Medians of Sex-Differences in Z Errors", y="Density Across 100 Replications")

z.sex_bias_density_plt2 <- z.sex.test.med %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat, scales="free") +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=y_pos),
              data = t.test.z.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom") +
  labs(x="Medians of Sex-Differences in Z Errors", y="Density Across 100 Replications")
ggsave(filename="figs/z.sex_bias_density_plt2.png", z.sex_bias_density_plt2, height=6, width=14, units="in")
```

plot subj. with averages in extremes 
```{r}
#recalc subject's true mean zs
raw_mean_z <- perm_subj.df %>%
  dplyr::filter(dataset=="cf") %>%
  mutate(mean_z = mean_z - mean_z_diff,
        VolGlob_mean_z = VolGlob_mean_z - VolGlob_mean_z_diff,
        VolReg_mean_z = VolReg_mean_z - VolReg_mean_z_diff,
        CT_mean_z = CT_mean_z - CT_mean_z_diff,
        SA_mean_z = SA_mean_z - SA_mean_z_diff) %>%
  dplyr::select(!c(contains("diff"), contains("centile"))) %>%
  mutate(dataset="raw")

raw_mean_z %>%
  dplyr::filter(perm=="perm-001") %>%
  dplyr::filter(SA_mean_z > 1.5) %>% 
  nrow()

perm_subj.df.z <- full_join(perm_subj.df, raw_mean_z)

perm_subj.df.z._long <- perm_subj.df.z %>%
  rename(allpheno_mean_z = mean_z) %>%
  pivot_longer(cols=contains("mean_z"), names_to="pheno_cat", values_to="mean_z") %>%
  mutate(pheno_cat = gsub("_mean_z", "", pheno_cat)) %>%
  mutate(pheno_cat = case_when(pheno_cat == "VolGlob" ~ "Global Volume",
                               pheno_cat == "VolReg" ~ "Regional Volume",
                               pheno_cat == "CT" ~ "Regional CT",
                               pheno_cat == "SA" ~ "Regional SA"))

high_z.sum <- perm_subj.df.z._long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_z > 1.5) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

low_z.sum <- perm_subj.df.z._long %>%
  dplyr::filter(pheno_cat != "allpheno") %>%
  dplyr::filter(mean_z < -1.5) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )
```

```{r}
#get raw vals for horizontal lines
high_z.sum_raw <- high_z.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

low_z.sum_raw <- low_z.sum %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

z.high_t_test.df <- lapply(split(high_z.sum, high_z.sum$pheno_cat), get_t_tests, raw_df=high_z.sum_raw) %>% bind_rows()
z.low_t_test.df <- lapply(split(low_z.sum, low_z.sum$pheno_cat), get_t_tests, raw_df=low_z.sum_raw) %>% bind_rows()

#merge dfs
all_z_sum.df <- gdata::combine(high_z.sum, low_z.sum) %>%
  mutate(source = gsub("_z.sum", "", source))
all_z.sum_raw <- all_z_sum.df %>%
  dplyr::filter(dataset == "raw" & perm=="perm-001")

z.all_t_test.df <- gdata::combine(z.high_t_test.df, z.low_t_test.df) %>%
  mutate(source = gsub("_t_test.df", "", source)) %>%
  mutate(source = gsub("z.", "", source))

#scale by raw value
all_z_sum.df_scaled <- all_z_sum.df %>%
  mutate(dataset = factor(dataset, levels=c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
  arrange(dataset) %>%
  group_by(source, pheno_cat) %>%
  mutate(female_ratio_sc = female_ratio/first(female_ratio),
         female_ratio_diff = female_ratio - first(female_ratio))

#plots!
all_z_sum.df %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=female_ratio)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y") +
  geom_hline(data=all_z.sum_raw, aes(yintercept=female_ratio), linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = max_val + 0.01),
              data = z.all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"),  name = "ComBat Configuration", labels=dataset_names) + 
  theme_linedraw()

z_ext_list <- c(high = ">1.5", low = "<-1.5")

all_z_sum.df_scaled %>%
  dplyr::filter(dataset != "raw" & dataset != "cf") %>%
  mutate(source = factor(source, levels=c("low", "high"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=z_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  # geom_text(aes(label = sig_fdr, y = max_val + 0.01),
  #             data = all_t_test.df[which(all_t_test.df$dataset != "cf"),]) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  # scale_y_continuous(labels=function(x)x/all_t_test.df$female_ratio[which(raw_df$pheno_cat == pheno_cat)]) + 
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Female Bias", x = "Dataset")

z_sex_boxplts <- all_z_sum.df_scaled %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(source = factor(source, levels=c("low", "high"), ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=female_ratio_diff)) +
  geom_boxplot(aes(color=dataset)) +
  # geom_dotplot(binaxis = "y", stackdir="zer") +
  facet_grid(pheno_cat~source, scales="free_y", labeller = labeller(source=z_ext_list)) +
  geom_hline(yintercept=0, linetype="dashed")+
  geom_text(aes(label = sig_fdr, y = .07),
              data = z.all_t_test.df) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  theme_linedraw() +
  scale_x_discrete(labels=dataset_names) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Proportion Female", x = "Dataset")
ggsave("figs/z_sex_boxplts.jpeg", z_sex_boxplts)
```


### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.z.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_z_t_tests_all_out.RDS"))
names(noext.z.feat.t.test) <- n_perm_list
noext.z.feat.t.test.df <- bind_rows(noext.z.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
      separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

noext.z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.z.t.test.df2 <- noext.z.feat.t.test.df %>%
  mutate(full_df = "No Extremes")
z.feat.t.test.df2 <- z.feat.t.test.df %>%
  mutate(full_df = "Full Dataset")

z.comp.df <- full_join(noext.z.t.test.df2, z.feat.t.test.df2)

comp_names <- c(cf.gam_cf = "ComBat-GAM v. \nComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. \nComBat w/o Covar")

z.test.comp.plt2 <- z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(smaller_group=factor(smaller_group, levels=c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "bottom") +
  facet_grid(comp ~ full_df, labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  labs(x="Sampling Permutation", y="Feature Count")
ggsave(filename="figs/z_comp_noext.png", z.test.comp.plt2, height=13, width=13, units="in")

z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.sex.test.z.list <- readRDS(paste0(data_path, "/no.ext_featurewise_z_sex_bias_tests.RDS"))
noext.sex.test.z.df <- bind_rows(noext.sex.test.z.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
noext.sex.test.z.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  #geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("lightblue", "red"))
```

Distribution of error medians w/in each pheno category
```{r}
noext.sex.test.z.med <- noext.sex.test.z.df %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

next.t.test.z.sex.test.med <- noext.sex.test.z.med %>%
  group_by(dataset, pheno_cat) %>%
  summarise(t.test.p = tidy(t.test(median_of_median_sex_diff))$p.value,
            t.test.est = tidy(t.test(median_of_median_sex_diff))$estimate,
            x_pos = median(median_of_median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = length(unique(z.sex.test.med$dataset))*length(unique(z.sex.test.med$pheno_cat))),
                  sig_fdr = case_when(p.val_fdr < 0.001 ~ "***",
                               p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
                               p.val_fdr >= 0.01 & p.val_fdr < 0.05 ~ "*",
                               p.val_fdr >= 0.05 ~ ""),
         y_pos = case_when(dataset=="cf" ~ 150,
                           dataset=="cf.lm" ~ 320,
                           dataset=="cf.gam" ~ 330,
                           dataset=="cf.gamlss" ~ 125))


t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

next.t.test.z.sex.test.med %>%
  ggplot() +
  geom_col(aes(x=pheno_cat, y=sig_fdr, fill=dataset), position="dodge")

z.sex_bias_density_plt_noext <- noext.sex.test.z.med %>%
  #dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed", color="#3F3F3F") +
  facet_wrap(~pheno_cat) +
  theme_linedraw() +
  geom_text(aes(label = sig_fdr, x= x_pos, y=y_pos),
              data = next.t.test.z.sex.test.med) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom")+
  labs(x="Medians of Sex-Differences in Z-Score Errors", y="Density Across 100 Replications")
ggsave(filename="figs/z_sex_bias_density_plt_noext.png", z.sex_bias_density_plt_noext, height=7, width=10, units="in")
```


## FIGURE 3
```{r}
blank <- ggplot() + theme_void()
sex.var.plot.global <- readRDS("figs/sex_var_plot_global.RDS")
sex.var.plot <- readRDS("figs/sex_var_plot.RDS")
```

```{r}
fig_3 <- ggarrange(
  ggarrange(
  ggarrange(blank, sex.var.plot.global, sex.var.plot, blank,
  ncol=4, nrow=1, 
  widths = c(.3, .7, 2.9, .4),
  hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  ),
  sex_bias_density_plt,
  nrow=2, ncol=1,
  labels=c("A", "B")
  ),
  all_cent_sum_boxplt.diff,
  ncol=2, nrow=1,
  labels=c(NA, "C"),
  widths = c(1, 1)
  # #align = "hv",
  # heights=c(1, 1.8),
  # common.legend = FALSE,
  # #labels=c("A", "B")
  )

#fig_3
ggsave("figs/figure_3.jpeg", fig_3, width=15, height=10, units="in")
```

## Supplemental Fig
```{r}
sfig <- ggarrange(cent.test.comp.plt, ct.brain.sum.plt,
                  ncol=1, nrow=2, heights = c(1.8, 1), labels = "AUTO")
sfig
ggsave(paste0(base_path, "/figs/combat_abs_errs_supp_plt.jpg"), plot=sfig, width=13, height=9, units="in")
```


Figure 3 but with ComBat w/o covariates

```{r}
fig_3_wtest <- ggarrange(
  ggarrange(
  ggarrange(sex.var.plot.global, sex.var.plot,
  ncol=2, nrow=1, 
  widths = c(1, 3.25),
  hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  ),
  sex_bias_density_plt,
  nrow=2, ncol=1,
  labels=c("A", "B")
  ),
  all_cent_sum_boxplt.diff,
  ncol=2, nrow=1,
  labels=c(NA, "C"),
  widths = c(1, 1.8)
  # #align = "hv",
  # heights=c(1, 1.8),
  # common.legend = FALSE,
  # #labels=c("A", "B")
  )

fig_3_wtest
ggsave("figs/figure_3_wtest.jpeg", fig_3, width=15, height=10, units="in")
```