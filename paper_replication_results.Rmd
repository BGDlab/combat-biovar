---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
```

single script to parse outputs & get results (condensed from `ukb_sim.site_analyses.Rmd`)

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/ukb_perm"

pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

pheno_list.z <- paste0(pheno_list, ".z")
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)
z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#also load raw data
ukb_cn_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/ukb_CN_data_simsites.csv")

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
```

## Load Data

Read in centile/z-score errors (pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_permute/perm_centile_csvs/*_diffs.csv' .`)

```{r, eval=FALSE}
raw_files <- list.files(path = data_path, pattern = "_diffs.csv", full.names = TRUE) %>% unlist()

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|perm|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("diffs_perm.list", df_list)
}
length(diffs_perm.list)
diffs_perm.df <- bind_rows(diffs_perm.list)
```

Read in subject-wise summary stats (pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_permute/perm_centile_csvs/subject-wise/*.csv' .`)

```{r}
raw_files <- list.files(path = data_path, pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|perm|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("perm_subj_list", df_list)
}
length(perm_subj_list)
perm_subj.df <- bind_rows(perm_subj_list)
```

```{r}
n_perm_list <- lapply(c(1:10), str_pad, 3, pad = "0")
n_perm_list <- paste0("perm-", n_perm_list)
pheno_list.z <- paste0(pheno_list, ".z")
```

## CENTILES

Do each feature's centile abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
cent.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_cent_t_tests_all_out.RDS"))
names(cent.feat.t.test) <- n_perm_list
cent.feat.t.test.df <- bind_rows(cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
  separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

cent.feat.t.test.df %>%
  group_by(comp, smaller_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
comp_names <- c(cf.gam_cf = "ComBat-GAM v. ComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. ComBat w/o Covar")

cent.test.comp.plt <- cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(smaller_group=factor(smaller_group, levels=c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered=TRUE)) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=smaller_group)) +
  theme_linedraw()+
  theme(axis.text.x = element_blank()) +
  facet_grid(pheno_cat~comp, scales="free_y", labeller = labeller(comp = as_labeller(comp_names))) +
  scale_fill_manual(values = c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  labs(x="Sampling Permutation", y="Feature Count")
ggsave(paste0(base_path, "/figs/perm_cent_test_barplt.jpg"), plot=cent.test.comp.plt, width=15.5, height=6, units="in")
```

look at combatGAM vs combatLS

```{r}
cent.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam") %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~pheno_cat)
```

Plot CT with combatGAM and combatLS on brains

```{r}
ct.t.tests <- cent.feat.t.test.df %>%
  dplyr::filter(comp =="cf.gamlss_cf.gam" & stringr::str_detect(pheno, "CT")) %>%
  mutate(label=gsub("_CT", "", pheno),
         better_fit = case_when(sig_fdr==TRUE & bigger_group == "cf.gam" ~ "cf.gamlss",
                              sig_fdr==TRUE & bigger_group == "cf.gamlss" ~ "cf.gam",
                              sig_fdr==FALSE ~ "NS"))

ct.t.tests_to_plt <- left_join(ct.t.tests, dk.parc)

ct.brain.plt <- ct.t.tests_to_plt %>%
  ggplot() +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
            aes(fill=better_fit)) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank(),
        legend.position="top") +
  scale_fill_manual(values = c(NS= "darkgray", cf.gam = "#3D75C2", cf.gamlss ="#CFB023FF"), name = "Better ComBat Method", labels=dataset_names) +
  facet_wrap(~perm, nrow=2)

ct.t.tests_to_plt.sum <- ct.t.tests_to_plt %>%
  group_by(hemi, region, label, bigger_group) %>%
  summarise(n_worse = sum(sig_fdr)) %>%
  pivot_wider(id_cols=c(hemi, label, region), names_from = bigger_group, values_from=n_worse) %>%
  mutate(cf.gamlss=ifelse(is.na(cf.gamlss), 0, cf.gamlss)) %>%
  mutate(cf.gamlss_minus_cf.gam_better=as.integer(cf.gam-cf.gamlss),
         percent_cf.gamlss_better=(cf.gam/10)*100) %>%
  ungroup()

ct.brain.sum.plt <- ct.t.tests_to_plt.sum %>%
  ggplot() +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
            aes(fill=percent_cf.gamlss_better))  +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  scale_fill_gradient(low="#605210", high= "#e6d16d",  name = "% Replications where ComBatLS is Better")
```

W/in subj average plots

```{r}
dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
cent.diffs.v.plot <- perm_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_cent_abs.diff, fill=perm), scale="count") +
  labs(y= "Mean Magnitude Centile Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  guides(fill=guide_legend(title="Sampling \nPermutation")) + 
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat \nconfigurations replicated 10x")
cent.diffs.v.plot
# ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot)
```

Plot raw values from random permutation

```{r, eval=FALSE}
raw_files <- list.files(path = data_path, pattern = "_diffs.csv", full.names = TRUE) %>% unlist()

diff.df.rand <- fread(raw_files[3])

diff.df.rand <- diff.df.rand %>%
  mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|perm|-", "", Source_File))

global_abs.diffs <- diff.df.rand %>%
  dplyr::select(participant, sex, age_days, sim.site, dataset, paste0("abs.diff_", pheno_list)) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff") %>%
    mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         abs.diff = abs.diff*100,
         pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_), ordered=TRUE, levels=c("Global Volume", "Regional Volume", "Regional SA", "Regional CT"))) %>%
    mutate(pheno = factor(pheno, ordered=TRUE, levels=c(vol_list_global, vol_list_regions, sa_list, ct_list)))#sort w/in pheno_cat

dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
all.abs.err.plt <- global_abs.diffs %>%
  dplyr::filter(dataset != "cf") %>%
  ggplot() +
  geom_boxplot(aes(x=interaction(pheno,pheno_cat, sep = "&"), y=abs.diff, fill=dataset), outlier.size=.1) +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Absolulte Centile Error", x = "Feature") +
  guides(x = ggh4x::guide_axis_nested(delim = "&")) +
  facet_wrap(~dataset, nrow=3, labeller = as_labeller(dataset_names), scales="free_y") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust=0.4, size=6), ggh4x.axis.nesttext.x = element_text(angle = 90, vjust=0.4), legend.position="none")
ggsave("figs/all_abs_err_plt_wlabels.jpeg", all.abs.err.plt, width=16, height=9, units="in")
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
cent.subj.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_cent_sex_bias_tests.RDS"))
cent.subj.sex.test.df <- bind_rows(cent.subj.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
cent.subj.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_manual(values = c("lightblue", "red"))
```

```{r}
#get range
cent.subj.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset) %>%
  summarize(min_sex_diff = min(median_sex_diff, na.rm=TRUE),
            max_sex_diff = max(median_sex_diff, na.rm=TRUE))

#look by feature type
cent.subj.sex.test.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  mutate(dataset = factor(dataset, levels = c("cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    perm = as.factor(sub("perm-0", "", perm))) %>%
ggplot() +
  geom_histogram(aes(x=median_sex_diff, color=perm, fill=perm), alpha=0.5, position="identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(pheno_cat~dataset, scales="free", labeller = labeller(dataset = as_labeller(dataset_names))) +
  theme_linedraw(base_size=12) +
  labs(fill='Sampling \nPermutation', color='Sampling \nPermutation', x="Male - Female Median Centile Errors", y="Number of Features") 
```

Distribution of error medians w/in each pheno category
```{r}
cent.sex.test.med <- cent.subj.sex.test.df %>%
   mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
  group_by(dataset, perm, pheno_cat) %>%
  summarise(median_of_median_sex_diff = median(median_sex_diff))

cent.sex.test.med %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_density(aes(x=median_of_median_sex_diff, fill=dataset, color=dataset), alpha=0.6, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_wrap(~pheno_cat, scales="free")
```

plot subj. with averages in extremes - try w/ averages w/in pheno categories
```{r}
#recalc subject's true mean centiles
raw_mean_cent <- perm_subj.df %>%
  dplyr::filter(dataset=="cf") %>%
  mutate(mean_centile = mean_centile - mean_cent_diff,
         mean_z = mean_z - mean_z_diff) %>%
  dplyr::select(!c(Source_File, contains("diff"))) %>%
  mutate(dataset="raw")

perm_subj.df2 <- full_join(perm_subj.df, raw_mean_cent)

high_cent.sum <- perm_subj.df2 %>%
  dplyr::filter(mean_centile > 0.75) %>%
  group_by(dataset, perm) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

high_cent.sum %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=male_ratio)) +
  geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir="center") +
  geom_hline(yintercept= high_cent.sum[high_cent.sum$dataset == "raw" & high_cent.sum$perm=="perm-001",][["male_ratio"]], linetype="dashed")

low_cent.sum <- perm_subj.df2 %>%
  dplyr::filter(mean_centile < 0.25) %>%
  group_by(dataset, perm) %>%
  summarise(
    male_ratio = sum(sex == "Male") / n(),
    female_ratio = sum(sex == "Female") / n()
  )

low_cent.sum %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot(aes(x=dataset, y=male_ratio)) +
  geom_boxplot() +
  geom_dotplot(binaxis = "y", stackdir="center")  +
  geom_hline(yintercept= low_cent.sum[low_cent.sum$dataset == "raw" & low_cent.sum$perm=="perm-001",][["male_ratio"]], linetype="dashed")

perm_subj.df %>%
  # dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  ggplot() +
  geom_histogram(aes(x=mean_cent_diff, fill=sex, color=sex), position="identity", alpha=0.6, bins=60) +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_wrap(~dataset, scales="free")

# wilcox.test(mean_cent_diff ~ sex, data=perm_subj.df[dataset=="cf.gamlss",])
# wilcox.test(mean_cent_diff ~ sex, data=perm_subj.df[dataset=="cf.gam",])
# wilcox.test(mean_cent_diff ~ sex, data=perm_subj.df[dataset=="cf.lm",])

# perm_subj.df %>%
#   mutate(centile_raw = mean_centile - mean_cent_diff)
#   arrange(participant)
```

```{r}
#one-sample tests against raw vals

one_samp_wilcox <- function(cf_method, df){
  df2 <- df %>%
    dplyr::filter(dataset == cf_method)
  raw_val <- df[df$dataset == "raw" & df$perm=="perm-001",][["male_ratio"]]
  wilcox.test(df2$male_ratio, mu=raw_val)
}

cf_test_list <- unique(perm_subj.df$dataset)

high_test <- lapply(cf_test_list, one_samp_wilcox, df=high_cent.sum)
names(high_test) <- cf_test_list

low_test <- lapply(cf_test_list, one_samp_wilcox, df=low_cent.sum)
names(low_test) <- cf_test_list

high_test
low_test
```


### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.cent.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_t_tests_all_out.RDS"))
names(noext.cent.feat.t.test) <- n_perm_list
noext.cent.feat.t.test.df <- bind_rows(noext.cent.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

noext.cent.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.cent.t.test.df2 <- noext.cent.feat.t.test.df %>%
  mutate(full_df = 0)
cent.feat.t.test.df2 <- cent.feat.t.test.df %>%
  mutate(full_df = 1)

comp.df <- full_join(noext.cent.t.test.df2, cent.feat.t.test.df2)
comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.subj.sex.test.list <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_sex_bias_tests.RDS"))
noext.subj.sex.test.df <- bind_rows(noext.subj.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
noext.subj.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_manual(values = c("lightblue", "red"))
```

## Z-SCORES

Do each feature's z-score abs. error in scores change based on combat version?

Computed using `ratio_results.R`, scp'd from cubic.

```{r}
z.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_z_t_tests_all_out.RDS"))
names(z.feat.t.test) <- n_perm_list
z.feat.t.test.df <- bind_rows(z.feat.t.test, .id="perm") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~comp)
```

look at combatGAM vs combatLS

```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE & comp =="cf.gamlss_cf.gam") %>%
ggplot(aes(x=perm, fill=bigger_group)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~pheno_cat)
```

W/in subj average plots

```{r}
z.diffs.v.plot <- perm_subj.df %>%
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_z_abs.diff, fill=perm), scale="count") +
  labs(y= "Mean Absolute Z-Score Error", x = "ComBat Configurations") +
  scale_x_discrete(labels=c(dataset_names)) +
  guides(fill=guide_legend(title="Sampling \nPermutation")) + 
  ggtitle("Within-subject mean magnitude of error in z scores across ComBat \nconfigurations replicated 10x")
z.diffs.v.plot
# ggsave(filename="figs/centile_violin.png", cent.diffs.v.plot)
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
z.subj.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_z_sex_bias_tests.RDS"))
z.subj.sex.test.df <- bind_rows(cent.subj.sex.test.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
z.subj.sex.test.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_manual(values = c("lightblue", "red"))
```

### Without Extremes

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.z.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_z_t_tests_all_out.RDS"))
names(noext.z.feat.t.test) <- n_perm_list
noext.z.feat.t.test.df <- bind_rows(noext.z.feat.t.test, .id="perm") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

noext.z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.z.t.test.df2 <- noext.z.feat.t.test.df %>%
  mutate(full_df = 0)
z.feat.t.test.df2 <- z.feat.t.test.df %>%
  mutate(full_df = 1)

z.comp.df <- full_join(noext.z.t.test.df2, z.feat.t.test.df2)
z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=perm, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Sex-Bias tests

```{r}
noext.subj.sex.test.z.list <- readRDS(paste0(data_path, "/no.ext_featurewise_z_sex_bias_tests.RDS"))
noext.subj.sex.test.z.df <- bind_rows(noext.subj.sex.test.z.list)
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
noext.subj.sex.test.z.df %>%
  mutate(sig_fdr = factor(sig_fdr, ordered=TRUE, levels=c("TRUE", "FALSE"))) %>%
  ggplot(aes(x=perm, fill=sig_fdr)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..)) +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_manual(values = c("lightblue", "red"))
```


## Supplemental Fig
```{r}
sfig <- ggarrange(cent.test.comp.plt, ct.brain.sum.plt,
                  ncol=1, nrow=2, heights = c(2, 1))
sfig
ggsave(paste0(base_path, "/figs/combat_abs_errs_supp_plt.jpg"), plot=sfig, width=11, height=7, units="in")

```
