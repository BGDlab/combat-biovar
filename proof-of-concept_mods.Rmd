---
title: "proof-of-concept_mods"
output: html_document
date: '2023-10-06'
---

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider, tidymodels, broom.mixed, ggseg)

source("./R_scripts/gamlss_helper_funs.R")
```

## Load Data

```{r}
ukb_df_totals <- read_csv(file="data/ukb_CN_data.csv")
ukb_df_age.filt <- read_csv(file="data/ukb_CN_data_agefilt.csv")

vol_list_global <- readRDS(file="R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="R_scripts/SA_list.rds")
ct_list <- readRDS(file="R_scripts/CT_list.rds")
```

Designate *basic* model formula

```{r}
basic.m1 <- gamlss(formula = GMV ~ poly(age_days, 3) + sex,
                       sigma.formula = ~ poly(age_days, 3) + sex,
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)
summary(basic.m1)
```

plot

```{r}
plot_singlestudy_centiles(basic.m1, "GMV", ukb_df_age.filt, "sex")
```

Check sex's significance in variance

```{r}
K <- drop1(basic.m1, what="sigma", scope = "sex")
class(K)
K["Pr(Chi)"]
K$"Pr(Chi)"[2]

test.mu <- drop1(basic.m1, what="mu", scope = "sex")
test.sig <- drop1(basic.m1, what="sigma", scope = "sex")

#write for testing
saveRDS(basic.m1, file="/Users/megardn/Desktop/BGD_Repos/combat_biovar/gamlss_basic_test_mod.rds")

get.and.drop1.p("/Users/megardn/Desktop/BGD_Repos/combat_biovar/gamlss_basic_test_mod.rds", moment="sigma", term="sex")

test.model.list <- c()
test.model.list[[1]] <- basic.m1
lapply(test.model.list, drop1, what="mu", scope = "sex")
```

## Significance Testing

scp'd models from cubic to parse

```{r}
read_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/ukb_basic/gamlss_objs" #path to bfp models
```

```{r}
#iterate across gamlss objects
model.files <- list.files(path = read_path, pattern = "mod.rds", full.names = TRUE)

sigma.df <- data.frame("file_path" = model.files)
sigma.df <- sigma.df %>%
  mutate(region = sub("_mod\\.rds$", "", basename(as.character(file_path))))

#test significance of sex term in sigma
sigma.df$sig.sex_drop1.p <- lapply(sigma.df$file_path, get.and.drop1.p, moment="sigma", term="sex")

#extract values of sex term from summary table
summary.list <- lapply(sigma.df$file_path, get.summary)
summary.df <- bind_rows(summary.list)
sigma.sex.df <- summary.df %>%
  dplyr::filter(parameter == "sigma" & term == "sexMale") %>%
  mutate(pheno_cat = as.factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA)),
    sig = case_when(p.value < 0.05 ~ TRUE,
                    p.value >= 0.05 ~ FALSE),
    sig_bf.corr = case_when(pheno %in% vol_list_global & p.value < (0.05/length(vol_list_global)) ~ TRUE,
                            pheno %in% vol_list_global & p.value >= (0.05/length(vol_list_global)) ~ FALSE,
                            !(pheno %in% vol_list_global) & p.value < (0.05/length(ct_list)) ~ TRUE,
                            !(pheno %in% vol_list_global) & p.value >= (0.05/length(ct_list)) ~ FALSE,
                            TRUE ~ NA),
    label = sub("_[^_]*_", "_", pheno)) #for plotting

#add more info from parcellations
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()

sigma.sex.df2 <- left_join(sigma.sex.df, dk.parc, by="label")
```

Visualize

```{r}
table(sigma.sex.df2$sig)
table(sigma.sex.df2$sig_bf.corr)
```

```{r, fig.width=11}
sigma.sex.df2 %>%
  dplyr::filter(sig_bf.corr == TRUE) %>%
  ggplot() +
  geom_col(aes(x=reorder(pheno,t_stat), y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sigma.sex.df2 %>%
  dplyr::filter(sig_bf.corr == TRUE) %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sigma.sex.df2 %>%
  dplyr::filter(sig_bf.corr == TRUE) %>%
  ggplot() +
  geom_col(aes(x=region, y=t_stat, fill=hemi)) + 
  facet_wrap(~pheno_cat) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")
```

Plot on brains!

```{r}
sigma.sex.df2 %>%
  dplyr::filter(sig_bf.corr == TRUE) %>%
  group_by(pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_wrap(~pheno_cat) +
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")
```

## Simulate Sites
Dividing each subject into 3 sites (A, B, and C) with M:F ratios of 1:1, 1:4, and 4:1

```{r}
set.seed(1010101)
sim.site.list <- c("Site_A", "Site_B", "Site_C")
n_female <- table(ukb_df_age.filt$sex)["Female"]
n_male <- table(ukb_df_age.filt$sex)["Male"]

# Sample probabilities
male_prob <- c(0.33, 0.0825, 0.5875)
female_prob <- c(0.33, 0.5875, 0.0825)

# Separate samples for males and females
sampled_males <- sample(sim.site.list, size = n_male, replace = TRUE, prob = male_prob)
sampled_females <- sample(sim.site.list, size = n_female, replace = TRUE, prob = female_prob)

ukb_df_sites <- ukb_df_age.filt %>%
  mutate(sim.site = as.factor(ifelse(sex == "Male", sampled_males, sampled_females)))

#write out
write_csv(ukb_df_sites, file="data/ukb_CN_data_simsites.csv")
```

```{r}
table(ukb_df_sites$sim.site)
table(ukb_df_sites$sim.site, ukb_df_sites$sex)
sum(is.na(ukb_df_sites$sim.site)) #all subj assigned to sites
anova(lm(age_days ~ sim.site, ukb_df_sites))
```

Need to come up with cleaner way to do this...

```{r}
site_sum_df <- ukb_df_sites %>%
  group_by(sim.site) %>%
  summarise(proportion_male = mean(sex == "Male"),
            min_age = min(age_days), max_age = max(age_days), mean_age = mean(age_days), 
            var_gmv = var(GMV), var_wmv=var(WMV), var_sgmv=var(sGMV), var_ven = var(Ventricles),
            sd_below.gmv = mean(GMV) - sd(GMV), sd_above.gmv = mean(GMV) + sd(GMV))
```

Center and visualize distributions

```{r}
ukb_sites_sex.centered <- ukb_df_sites %>%
  group_by(sex) %>%
  mutate_if(is.numeric, funs(scale(., center=TRUE, scale=FALSE))) %>%
  ungroup()
```

```{r}
# Generate histograms (mean-centered w/in sex)
global_site_plots <- plot.hist.by.sex(ukb_sites_sex.centered, vol_list_global, facet_fac = "sim.site")

# Print or display the histograms
for (pheno in vol_list_global) {
  print(global_site_plots[[pheno]])
}
```

Look at uncentered distributions across sites
```{r}
ggplot(ukb_df_sites, aes(x=GMV)) + 
 geom_histogram(aes(y=after_stat(density)))+
 geom_density(alpha=.2) +
  geom_vline(aes(xintercept=(mean(GMV)+sd(GMV)))) +
  geom_vline(aes(xintercept=(mean(GMV)-sd(GMV))))
  

ggplot(ukb_df_sites, aes(x=GMV)) + 
 geom_histogram(aes(y=after_stat(density)))+
 geom_density(alpha=.2) +
  geom_vline(aes(xintercept=(mean(GMV)+sd(GMV)))) +
  geom_vline(aes(xintercept=(mean(GMV)-sd(GMV)))) +
  facet_wrap(~sim.site)
```

```{r}
centered.site_df <- ukb_df_sites %>%
  group_by(sim.site) %>%
  mutate_if(is.numeric, funs(scale(., center=TRUE, scale=FALSE))) %>%
  ungroup()

centered.site_sum_df <- centered.site_df %>%
  group_by(sim.site) %>%
  summarise(sd_below.gmv = mean(GMV) - sd(GMV), sd_above.gmv = mean(GMV) + sd(GMV))

ggplot() + 
 #geom_histogram(aes(x=centered.site_df$GMV, y=after_stat(density), fill=centered.site_df$sim.site, color=centered.site_df$sim.site), alpha = .2)+
 geom_density(aes(x=centered.site_df$GMV, fill=centered.site_df$sim.site, color=centered.site_df$sim.site), alpha=.4) +
  geom_vline(aes(xintercept=centered.site_sum_df$sd_below.gmv, color=centered.site_sum_df$sim.site)) +
  geom_vline(aes(xintercept=centered.site_sum_df$sd_above.gmv, color=centered.site_sum_df$sim.site))
```

## ComBat

And now, to combat the data across the simulated sites!
