---
title: "proof-of-concept_mods"
output: html_document
date: '2023-10-06'
---

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider, tidymodels, broom.mixed, ggseg)

source("./R_scripts/gamlss_helper_funs.R")
```

## Load Data

```{r}
ukb_df_totals <- read_csv(file="data/ukb_CN_data.csv")
ukb_df_age.filt <- read_csv(file="data/ukb_to_model/ukb_CN_data_simsites.csv")

vol_list_global <- readRDS(file="R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="R_scripts/SA_list.rds")
ct_list <- readRDS(file="R_scripts/CT_list.rds")
pheno_list <- readRDS(file="R_scripts/pheno_list.rds")
```

Designate *basic* model formula

```{r}
basic.m1 <- gamlss(formula = GMV ~ poly(age_days, 3) + sex,
                       sigma.formula = ~ poly(age_days, 3) + sex,
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)
summary(basic.m1)
```

plot

```{r}
plot_singlestudy_centiles(basic.m1, "GMV", ukb_df_age.filt, "sex")
```

Check sex's significance in variance

```{r}
K <- drop1(basic.m1, what="sigma", scope = "sex")
class(K)
K["Pr(Chi)"]
K$"Pr(Chi)"[2]

test.mu <- drop1(basic.m1, what="mu", scope = "sex")
test.sig <- drop1(basic.m1, what="sigma", scope = "sex")

#write for testing
saveRDS(basic.m1, file="/Users/megardn/Desktop/BGD_Repos/combat_biovar/gamlss_basic_test_mod.rds")

get.and.drop1.p("/Users/megardn/Desktop/BGD_Repos/combat_biovar/gamlss_basic_test_mod.rds", moment="sigma", term="sex")

test.model.list <- c()
test.model.list[[1]] <- basic.m1
lapply(test.model.list, drop1, what="mu", scope = "sex")
```

## Review Results

scp'd csvs from cubic

```{r}
drop1.df <- fread("ukb_basic/drop1_tests.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1)
sex.df <- fread("ukb_basic/sex_summary.csv", stringsAsFactors = TRUE)%>%
  dplyr::select(-V1)
sum.df <- fread("ukb_basic/gamlss_summary.csv", stringsAsFactors = TRUE)%>%
  dplyr::select(-V1)
```

```{r}
#add more info from parcellations
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()

sex.df <- left_join(sex.df, dk.parc, by="label")
sum.df <- left_join(sum.df, dk.parc, by="label")
```

## Raw Data Results

```{r, fig.width=11}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset ==	"ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=reorder(pheno,t_stat), y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=region, y=t_stat, fill=hemi)) + 
  facet_wrap(~pheno_cat) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")
```

Plot on brains!

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  group_by(pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_wrap(~pheno_cat) +
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")
```

### Combat Effects

#### Site Effects
Loading combatted data (scp'd from cubic: `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/data/ukb_to_model/*.csv' ./data/ukb_to_model`) to see how values change with different combat methods
```{r}
data.csvs <- list.files(path = "data/ukb_to_model", pattern = ".csv", full.names = TRUE)
combined_data <- data.frame()

for (file in data.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file)))
  
  # Bind the data to the combined dataframe
  combined_data <- bind_rows(combined_data, data, .id = "File_ID")
}

table(combined_data$Source_File)
```

```{r}
var.df <- combined_data %>%
  group_by(Source_File, sim.site) %>%
  summarize(across(all_of(pheno_list), var))

var.long <- pivot_longer(var.df, cols=c(-Source_File, -sim.site), names_to = "feature", values_to = "variance")
```

```{r}
var.long %>%
  dplyr::filter(!(feature %in% vol_list_global)) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=sim.site), alpha = 0.4, position="identity") +
  facet_wrap(~Source_File)

var.long %>%
  dplyr::filter(!(feature %in% vol_list_global) & (Source_File == "cf.lm_data.csv" | Source_File == "cf.gamlss_data.csv" | Source_File == "ukb_CN_data_simsites.csv")) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=Source_File), alpha = 0.5, position="identity") +
  facet_wrap(~sim.site)
```

```{r}
var.by.sex <- combined_data %>%
  group_by(Source_File, sex) %>%
  summarize(across(all_of(pheno_list), var))

var.by.sex.long <- pivot_longer(var.by.sex, cols=c(-Source_File, -sex), names_to = "feature", values_to = "variance")
```

```{r}
var.by.sex.long %>%
  dplyr::filter(!(feature %in% vol_list_global) & (Source_File == "cf.lm_data.csv" | Source_File == "cf.gamlss_data.csv" | Source_File == "ukb_CN_data_simsites.csv")) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=sex), alpha = 0.5, position="identity") +
  facet_wrap(~Source_File)
```

#### Mu

Does the number of regions w significant age effects on mu change depending on combat version?

```{r}
drop1.df %>%
  dplyr::filter(Term=="poly(age_days, 3)" & Moment == "mu") %>%
  group_by(Dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())
```

No.

Does the number of regions w significant sex effects on mu change depending on combat version?

```{r}
drop1.df %>%
  dplyr::filter(Term=="sexMale" & Moment == "mu") %>%
  group_by(Dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())

sum.df %>%
  dplyr::filter(term=="sexMale" & parameter == "mu") %>%
  group_by(dataset) %>%
  summarize(n_sig_regions = sum(sig.sum_bf.corr),
            n_regions = n())
```

Slightly. Only combat w/o covariates or lm combat without a ref site are noticeably off. Consistent across drop1 and summary outputs

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "mu" & pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on mu")
```

#### Sigma

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=dataset)) +
  facet_wrap(~pheno_cat, scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #theme_void() +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  dplyr::filter(dataset == "cf.lm-data" | dataset == "cf.gamlss-data" | dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=dataset), position = "dodge") +
  facet_wrap(~pheno_cat, scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #theme_void() +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")
```



##Troubleshooting

Troubleshooting drop1

```{r}
model.test <- readRDS("~/Desktop/BGD_Repos/combat_biovar/ukb_basic/lh_SA_superiortemporal_ukb-CN-data-simsites_mod.rds")
drop1(model.test, what = "sigma")
model.test.drop <- gamlss(formula = lh_SA_superiortemporal ~ poly(age_days, 3) + sex,
                       sigma.formula = ~ poly(age_days, 3),
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)
drop1(model.test.drop, what = "sigma")

ukb_df_age.filt <- ukb_df_age.filt %>%
  mutate(sexMale = as.numeric(case_when(sex == "Male" ~ 1,
                                        sex == "Female" ~ 0,
                                        TRUE ~ NA)))
model.test.refit <- gamlss(formula = lh_SA_superiortemporal ~ poly(age_days, 3) + sexMale,
                       sigma.formula = ~ poly(age_days, 3) + sexMale,
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)
drop1(model.test.refit, what = "sigma", scope = "sexMale")


model.test.refit2 <- gamlss(formula = lh_SA_superiortemporal ~ poly(age_days, 3) + sex,
                       sigma.formula = ~ poly(age_days, 3) + sex,
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)


drop.test.obj<-drop1(model.test.refit2, what = "nu")
df <- drop.test.obj %>%
  as.data.frame() %>%
  mutate(what=attributes(drop.test.obj)$heading[2]) %>%
  add_rownames(var = "term")


f <- drop1_all(model.test.refit2, name="TEST")
```

```{r}
# Your input string
input_string <- "xxxx ref.batch = yyyy"

# Check if the input string contains "ref.batch =" using a regular expression
if (grepl("ref\\.batch\\s*=\\s*", input_string)) {
  # Your code for splitting the string
  # Split the string into two parts
  split_string <- unlist(strsplit(input_string, "ref.batch", fixed = TRUE))
  
  # The split_string will contain two elements
  part1 <- split_string[1]
  part2 <- gsub("=", "", split_string[2])
  
  # Trim any leading/trailing white spaces in part2
  part2 <- trimws(part2)
  
  # Output the two parts
  print(part1)
  print(part2)
} else {
  cat("The input string does not contain 'ref.batch ='\n")
}
```
