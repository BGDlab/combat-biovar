---
title: "Combat Sandbox"
output: html_document
date: '2023-10-06'
---

Playing around with different combat configs using the UKB data, which has been assigned to 3 simulated study sites (see `ukb_curation-eda.Rmd`)

## Setup


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(devtools, data.table, readr, ggplot2, tidyverse, mgcv, gamlss)
#install.packages("devtools")
devtools::install_github("andy1764/ComBatFamily", build_vignettes = FALSE) #per discussion with Andrew, sent vignettes separately
library(ComBatFamily)
```


#Prep data

Using additional instructions from J Fortin's [initial repo](https://github.com/Jfortin1/neuroCombat_Rpackage/tree/2ccab2b42c59163717f012c70a54d20e8757b1c7). 

Just using regional volume measures for now.

```{r}
ukb_df_sites <- read_csv(file="data/ukb_to_model/ukb_CN_data_simsites.csv")
pheno_list <- readRDS(file="R_scripts/pheno_list.rds")
```

```{r}
#phenotypes to harmonize
pheno.df <- ukb_df_sites %>%
  dplyr::select(all_of(pheno_list))

#fake batches
batch <- as.factor(ukb_df_sites$sim.site)

# #covariates - using model.matrix to dummycode sex as numeric - 
# covar.mat <- model.matrix( ~ age_days + sexMale, data=ukb_df_sites) 
#testing with df now that mods are being fit with sexMale
covar.mat <- ukb_df_sites %>%
  dplyr::select(age_days, sexMale)

nrow(pheno.df) == length(batch)
nrow(pheno.df) == nrow(covar.mat)
```

## ComBat

simple combat with no covariate preservation
```{r}
cf <- comfam(pheno.df, batch)
# cf$dat.combat
```

simple combat with linear model for covariates
```{r}
cf.lm <- comfam(pheno.df, batch, covar.mat, lm, formula = y ~ age_days + sexMale)
# cf.lm$dat.combat
```

Try setting site A (which has even sex distribution) as ref

```{r}
cf.lm_refA <- comfam(pheno.df, batch, covar.mat, lm, formula = y ~ age_days + sexMale, ref.batch = "Site_A")
# cf.lm_refA$dat.combat
```

combat gam with age as smooth
```{r}
cf.gam <- comfam(pheno.df, batch, covar.mat, gam, formula = y ~ s(age_days) + sexMale)
```

```{r}
cf.gam_refA <- comfam(pheno.df, batch, covar.mat, gam, ref.batch = "Site_A", formula = y ~ s(age_days) + sexMale)
```

combat gamlss!

```{r}
cf.gamlss <- comfam(pheno.df, batch, covar.mat, gamlss, y ~ age_days + sexMale,
              sigma.formula = ~ age_days + sexMale, 
              control = gamlss.control(trace = FALSE))
```

```{r}
cf.gamlss_refA <- comfam(pheno.df, batch, covar.mat, gamlss, y ~ age_days + sexMale,
              sigma.formula = ~ age_days + sexMale, 
              control = gamlss.control(trace = FALSE),
              ref.batch = "Site_A")
```

Add back batch and covariance
```{r}
cf.list <- list(cf, cf.lm, cf.lm_refA, cf.gam, cf.gam_refA, cf.gamlss, cf.gamlss_refA)
length(cf.list)

combat.df.list <- lapply(cf.list, post_combat_concat, og_df = ukb_df_sites)
names(combat.df.list) <- c("cf", "cf.lm", "cf.lm_refA", "cf.gam", "cf.gam_refA", "cf.gamlss", "cf.gamlss_refA")
```

write out
```{r}
for (i in names(combat.df.list)){
  df <- combat.df.list[[i]]
  write_csv(df, file=paste0("data/ukb_to_model/ukb_", i, "_data.csv"))
}
```

## Compare Variances

Randomly picked `lh_Vol_superiorparietal` to compare

Get variances
```{r}
#raw data
sum_df <- ukb_df_sites %>%
  group_by(sim.site) %>%
  summarise(sd_below.lh_v_sp = mean(lh_Vol_superiorparietal) - sd(lh_Vol_superiorparietal), sd_above.lh_v_sp = mean(lh_Vol_superiorparietal) + sd(lh_Vol_superiorparietal),
            var.lh_v_sp = var(lh_Vol_superiorparietal))

for (i in names(combat.df.list)){
  df <- combat.df.list[[i]] %>%
  group_by(sim.site) %>%
  summarise(sd_below.lh_v_sp = mean(lh_Vol_superiorparietal) - sd(lh_Vol_superiorparietal), sd_above.lh_v_sp = mean(lh_Vol_superiorparietal) + sd(lh_Vol_superiorparietal), var.lh_v_sp = var(lh_Vol_superiorparietal))
  assign(paste0(i, "_summary"), df)
}
```

compile

```{r}
var_comp_df <- data.frame(sim.site = c("Site_A", "Site_B", "Site_C"),
                          raw_data = sum_df$var.lh_v_sp,
                          cf = cf_summary$var.lh_v_sp,
                          cf.lm = cf.lm_summary$var.lh_v_sp,
                          cf.lm_refA = cf.lm_refA_summary$var.lh_v_sp,
                          cf.gam = cf.gam_summary$var.lh_v_sp,
                          cf.gam_refA = cf.gam_refA_summary$var.lh_v_sp,
                          cf.gamlss = cf.gamlss_summary$var.lh_v_sp,
                          cf.gamlss_refA = cf.gamlss_refA_summary$var.lh_v_sp)

var_comp_long <- var_comp_df %>%
  pivot_longer(!sim.site, names_to="type", values_to = "variance")

ggplot(var_comp_long) +
  geom_col(aes(x=type, y=variance, fill=sim.site, color=sim.site), position = "dodge")

ggplot(var_comp_long) +
  geom_col(aes(x=type, y=variance), position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~sim.site)
```
