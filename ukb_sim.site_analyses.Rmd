---
title: "proof-of-concept_mods"
output: html_document
date: '2023-10-06'
---

## QUESTIONS
- effect size for poly(age_days, 3) in gam/gamlss
- Fix age -> diff in male and female variance/intercept

## Setup

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(gamlss, gamlss.cens, gamlss.dist, gamlss.mx, gamlss.tr, ggplot2, tidyverse, ggpubr, skimr, gamlss.data, data.table, nlme, devtools, slider, tidymodels, broom.mixed, ggseg, cowplot, lsr, paletteer, ggsegExtra, ggseg3d)

source("./R_scripts/gamlss_helper_funs.R")
# 
# # Enable this universe
# options(repos = c(
#   ggseg = 'https://ggseg.r-universe.dev',
#   CRAN = 'https://cloud.r-project.org'))
# 
# # Install some packages
# install.packages('ggsegExtra')
```

# Analysis Outline
## Load Data

```{r}
ukb_df_totals <- read_csv(file="data/ukb_CN_data.csv")
ukb_df_age.filt <- read_csv(file="data/ukb_to_model/ukb_CN_data_simsites.csv")

vol_list_global <- readRDS(file="R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="R_scripts/SA_list.rds")
ct_list <- readRDS(file="R_scripts/CT_list.rds")
pheno_list <- readRDS(file="R_scripts/pheno_list.rds")
```

## Basic Models
Designate *basic* model formula

```{r}
basic.m1 <- gamlss(formula = GMV ~ poly(age_days, 3) + sexMale,
                       sigma.formula = ~ poly(age_days, 3) + sexMale,
                       nu.formula = ~ 1,
                       family = BCCG, data=ukb_df_age.filt, trace = FALSE)
summary(basic.m1)
```

plot

```{r}
#plot_singlestudy_centiles(basic.m1, "GMV", ukb_df_age.filt, "sexMale")
```

# Review Results

scp'd csvs from cubic (`scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/*.csv' ./ukb_basic`)

```{r}
drop1.df <- fread("ukb_basic/drop1_tests.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1)
sex.df <- fread("ukb_basic/sex_summary.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1)
sum.df <- fread("ukb_basic/gamlss_summary.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1) %>%
  mutate(dataset = gsub("-data", "", dataset)) %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb-CN-simsites"))
```

```{r}
#add more info from parcellations
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()

sex.df <- left_join(sex.df, dk.parc, by="label")
sum.df <- left_join(sum.df, dk.parc, by="label")
```

### Raw Data Results

```{r, fig.width=11}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset ==	"ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=reorder(pheno,t_stat), y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=pheno_cat)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=region, y=t_stat, fill=hemi)) + 
  facet_wrap(~pheno_cat) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Significant effects of male sex on sigma across phenotype-specific brain charts")
```

Plot on brains!

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & dataset == "ukb-CN-data-simsites") %>%
  group_by(pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_wrap(~pheno_cat) +
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")
```

Simple bar plot of sites
```{r}
ggplot(ukb_df_age.filt) +
  geom_bar(aes(x=sim.site, fill=sex), color="black", alpha=0.6) +
  theme_linedraw(base_size=12)
```

### Combat Effects

#### Site Effects
Loading combatted data (scp'd from cubic: `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/data/ukb_to_model/*.csv' ./data/ukb_to_model`) to see how values change with different combat methods
```{r}
data.csvs <- list.files(path = "data/ukb_to_model", pattern = ".csv", full.names = TRUE)
combined_data <- data.frame()

for (file in data.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file)))
  
  # Bind the data to the combined dataframe
  combined_data <- bind_rows(combined_data, data, .id = "File_ID")
}

table(combined_data$Source_File)
```

```{r}
var.df <- combined_data %>%
  group_by(Source_File, sim.site) %>%
  summarize(across(all_of(pheno_list), var))

var.long <- pivot_longer(var.df, cols=c(-Source_File, -sim.site), names_to = "feature", values_to = "variance")
```

```{r}
var.long %>%
  dplyr::filter(!(feature %in% vol_list_global)) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=Source_File), alpha = 0.4, position="identity") +
  facet_wrap(~sim.site)

var.long %>%
  dplyr::filter(!(feature %in% vol_list_global) & (Source_File == "cf.gam_data.csv" |Source_File == "ukb_CN_data_simsites.csv" |  Source_File == "cf.gamlss_data.csv" )) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=Source_File), alpha = 0.5, position="identity") +
  facet_wrap(~sim.site)

#Source_File == "cf.lm_data.csv" | 
```

```{r}
var.by.sex <- combined_data %>%
  group_by(Source_File, sex) %>%
  summarize(across(all_of(pheno_list), var))

var.by.sex.long <- pivot_longer(var.by.sex, cols=c(-Source_File, -sex), names_to = "feature", values_to = "variance")
```

```{r}
var.by.sex.long %>%
  dplyr::filter(!(feature %in% vol_list_global) & (Source_File == "cf.gam_data.csv" | Source_File == "cf.gamlss_data.csv" | Source_File == "ukb_CN_data_simsites.csv")) %>%
  ggplot() +
  geom_density(aes(x=variance, fill=sex), alpha = 0.5, position="identity") +
  facet_wrap(~Source_File)
```

Simple t test for sex effects across combat types
```{r}
sex_ttest_df <- data.frame("Source_File" = levels(combined_data$Source_File))

for(pheno in pheno_list){
  # New column name
  new_col_name <- paste0(pheno, ".p")
  
  #run t-tests
  out <- lapply(split(combined_data, factor(combined_data$Source_File)), function(x)t.test(x[[pheno]] ~ x[["sex"]], paired=FALSE)$p.value)
  stopifnot(names(out) == levels(combined_data$Source_File)) #make sure results are in correct order
  
  #append to dataframe
  sex_ttest_df[[new_col_name]] <- unlist(unname(out))
}
```

```{r}
sex_ttest_long <- sex_ttest_df %>% pivot_longer(!Source_File, values_to="p.value", names_to="pheno") %>%
  mutate(pheno = sub(".p$", "", pheno),
         sig_bfcor = case_when(pheno %in% vol_list_global & p.value < (0.05/length(vol_list_global)) ~ TRUE,
                            pheno %in% vol_list_global & p.value >= (0.05/length(vol_list_global)) ~ FALSE,
                            !(pheno %in% vol_list_global) & p.value < (0.05/length(ct_list)) ~ TRUE,
                            !(pheno %in% vol_list_global) & p.value >= (0.05/length(ct_list)) ~ FALSE,
                            TRUE ~ NA))
sex_ttest_long %>%
  group_by(Source_File) %>%
  summarize(n_sig_regions = sum(sig_bfcor),
            n_regions = n())
```

Basically same results gam/gamlss

#### Mu

Does the number of regions w significant age effects on mu change depending on combat version?

```{r}
drop1.df %>%
  dplyr::filter(Term=="poly(age_days, 3)" & Moment == "mu") %>%
  group_by(Dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())
```

No.

Does the number of regions w significant sex effects on mu change depending on combat version?

```{r}
drop1.df %>%
  dplyr::filter(Term=="sexMale" & Moment == "mu") %>%
  group_by(Dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())

sum.df %>%
  dplyr::filter(term=="sexMale" & parameter == "mu") %>%
  group_by(dataset) %>%
  summarize(n_sig_regions = sum(sig.sum_bf.corr),
            n_regions = n())
```

Slightly. Only combat w/o covariates or lm combat without a ref site are noticeably off. Consistent across drop1 and summary outputs

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "mu" & pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on mu")
```

Trying with ultra-strict threshold to see if results change:

```{r}
drop1.df <- drop1.df %>%
  mutate(sig.sum.strict = case_when(drop1.pval < (0.05/length(pheno_list)) ~ TRUE,
                            drop1.pval >= (0.05/length(pheno_list)) ~ FALSE,
                            TRUE ~ NA))

drop1.df %>%
  dplyr::filter(Term=="poly(age_days, 3)" & Moment == "mu") %>%
  group_by(Dataset) %>%
  summarize(n_sig_regions = sum(sig.sum.strict),
            n_regions = n())
```

No difference

#### Sigma

```{r}
sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=dataset)) +
  facet_wrap(~pheno_cat, scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #theme_void() +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  dplyr::filter(dataset == "cf.lm-data" | dataset == "cf.gamlss-data" | dataset == "ukb-CN-data-simsites") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=dataset), position = "dodge") +
  facet_wrap(~pheno_cat, scales = "free_x") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #theme_void() +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")

sex.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & parameter == "sigma" & pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t_stat)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on sigma")
```
Check number of regions w significant sex effects in sigma
```{r}
sex.sigma.counts <- sex.df %>%
  dplyr::filter(term=="sexMale" & parameter == "sigma") %>%
  group_by(dataset, pheno_cat) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())
sex.sigma.counts
```

More variation
```{r}
ggplot(sex.sigma.counts) +
  geom_col(aes(x=dataset, y=n_sig_regions, fill=dataset)) +
  facet_wrap(~pheno_cat) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

##### Variance
Convert sigma to variance by correcting for log-link function (sex's effect on variance = exp(sigma) - exp(log(sigma) - beta sex)) -> exp(beta_sex).
Also getting mean variance.

```{r}
sigma.df <- sum.df %>%
  dplyr::filter(parameter == "sigma") %>%
  mutate(var_est = exp(estimate),
         var_mean = exp(moment.mean),
         beta_ratio = var_est/var_mean)

skim(sigma.df$var_est)

sigma.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & term =="sexMale") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_histogram(aes(x=var_est, fill = dataset), color="black", alpha=0.5, position = "identity") +
  theme_linedraw() +
  facet_wrap(~pheno_cat, scales= "free")
```

```{r, fig.height=10, fig.width=8}
proportion_beta_plot <- sigma.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume" & term =="sexMale") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = beta_ratio)) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_bw(base_size=15) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Proportion of effect of male sex on variance")
```

```{r, fig.height=15, fig.width=12}
beta.plot <- sigma.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume" & term =="sexMale") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = var_est)) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Beta weight for effect of male sex on variance")

ggsave("male_variance_beta.jpeg", beta.plot, width=12, height=15)
```

```{r, fig.height=5, fig.widt=5}
sigma.df %>%
  dplyr::filter(pheno_cat == "Global Volume" & term =="sexMale") %>%
  mutate(var_est.sig = case_when(sig.sum_bf.corr == TRUE ~ var_est,
                                 sig.sum_bf.corr == FALSE ~ 0)) %>%
  #group_by(dataset) %>%
  ggplot() +
  geom_col(aes(x=dataset, y = var_est.sig, fill=dataset), position="dodge") +
  #scale_fill_gradient2() +
  facet_grid(~pheno) + 
  theme_bw(base_size=12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(legend.position="none") +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  ggtitle("Beta weight for effect of male sex on global volumes' variance")

sigma.df.glob <- sigma.df %>%
  dplyr::filter(pheno_cat == "Global Volume" & term =="sexMale")
table(sigma.df.glob$dataset, sigma.df.glob$sig.sum_bf.corr)
```

fix age, get diff between male and female pred. variance
```{r}
pred.csvs <- list.files(path = "ukb_basic", pattern = "_variance.csv", full.names = TRUE)
combined_var <- data.frame()

for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = sub("_data_variance.csv", "", Source_File))
  
  # Bind the data to the combined dataframe
  combined_var <- bind_rows(combined_var, data, .id = "File_ID")
}

table(combined_var$dataset)
#skim(combined_preds)
```

```{r}
combined_var <- combined_var %>%
  mutate(sex_std = sex_effect/f.var)

summary(sigma.df$var_est)
summary(combined_var$sex_effect)

summary(sigma.df$beta_ratio)
summary(combined_var$sex_std)
```

```{r}
plot.info <- sigma.df %>%
  dplyr::filter(term == "sexMale") %>%
  dplyr::select(mod_name, pheno, dataset, pheno_cat, label, hemi, region, sig.sum_bf.corr) %>%
  unique() %>%
  mutate(dataset = gsub("-", "_", dataset),
         dataset = gsub("_simsites", "", dataset))
combined_var <- inner_join(combined_var, plot.info)
table(combined_var$dataset)
```

plot

```{r, fig.height=5, fig.widt=5}
combined_var %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = sex_std)) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_bw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Standardized effect of male sex on variance")
```

using aseg 

```{r}
plot(aseg)
```

#### Centiles

Do centile scores change based on combat version?
```{r}
pred.csvs <- list.files(path = "ukb_basic", pattern = "_predictions.csv", full.names = TRUE)
combined_preds <- data.frame()

for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = sub("_data_predictions.csv", "", Source_File))
  
  # Bind the data to the combined dataframe
  combined_preds <- bind_rows(combined_preds, data, .id = "File_ID")
}

table(combined_preds$dataset)
#skim(combined_preds)
```
calc how much centiles change
```{r}
cent_diffs <- combined_preds %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb_CN")) %>%
  arrange(dataset) %>%
  group_by(participant) %>%
  mutate(across(all_of(pheno_list), ~ abs(. - first(.)), .names = "abs.diff_{.col}")) %>%
  ungroup()

diff_vol_glob <- sapply(vol_list_global, function(x) paste0("abs.diff_", x))

mean.cent.diffs <- cent_diffs %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup()

max.cent.diffs <- cent_diffs %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), max)) %>%
  ungroup()
#names(max.cent.diffs)
```

Plot average differences in centiles
```{r}
mean.diffs.long <- mean.cent.diffs %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
mean.diffs.long <- left_join(mean.diffs.long, dk.parc, by="label")
```

```{r}
mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
ggplot() +
  geom_density(aes(x=centile_abs.diff, fill=dataset), alpha=0.5) +
  facet_grid(dataset~pheno_cat)

mean.diffs.long %>%
  dplyr::filter(dataset== "cf.gam" | dataset == "cf.gam_refA" | dataset == "cf.gamlss" | dataset == "cf.gamlss_refA") %>%
  ggplot() +
  geom_density(aes(x=centile_abs.diff, fill=dataset), alpha=0.5) +
  scale_x_continuous(labels = label_comma())

mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visualization purposes
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset), color="black", binwidth=0.1, alpha=0.5, position="identity") +
  theme_linedraw() +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_continuous(labels = label_comma()) +
  ggtitle("Mean absolute differences in centile scores across ComBat \nprocessing pipelines for each phenotype")

cent.diffs.plot <- mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 12) +
  scale_x_continuous(labels = label_comma()) + facet_wrap(~pheno_cat) +
  paletteer::scale_fill_paletteer_d("Polychrome::light") +
  ggtitle("Mean absolute differences in centile scores across \nComBat processing pipelines for each phenotype")
ggsave("mean_centile_diffs.jpeg", cent.diffs.plot)
```

```{r, fig.height=15, fig.width=12}
mean.diffs.long %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "ukb_CN") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = centile_abs.diff)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("Mean difference in centiles across ComBat configurations")
```

Look at max difference per phenotype
```{r, fig.height=6, fig.width=7}
max.diffs.long <- max.cent.diffs %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="max_centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

max.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(max_centile_abs.diff = max_centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=max_centile_abs.diff, fill=dataset), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 12) +
  scale_x_continuous(labels = label_comma()) + facet_wrap(~pheno_cat) +
  paletteer::scale_fill_paletteer_d("Polychrome::light") +
  ggtitle("Maximum absolute differences in centile scores across \nComBat processing pipelines for each phenotype")
```

```{r}
max.diffs.long %>%
  mutate(max_centile_abs.diff = max_centile_abs.diff*100) %>% #for visuals
  dplyr::filter(dataset != "ukb_CN") %>%
  ggplot() +
  geom_histogram(aes(x=max_centile_abs.diff, fill=dataset), color="black", alpha=0.5, position="identity", binwidth = 0.5) +
  theme_linedraw(base_size = 12) +
  scale_x_continuous(labels = label_comma())+
  ggtitle("Maximum absolute differences in centile scores across \nComBat processing pipelines for each phenotype")
```

Test for differences in distribution
```{r}
#get centile errors for each subject
cent.diffs2 <- combined_preds %>%
  dplyr::filter(!str_detect(dataset, "_refA")) %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb_CN")) %>%
  arrange(dataset) %>%
  group_by(participant) %>%
  mutate(across(all_of(pheno_list), ~ abs(. - first(.)), .names = "diff_{.col}")) %>%
  ungroup() %>%
  dplyr::filter(dataset != "ukb_CN") #drop ref

# cf.gmvdiff <- cent.diffs2 %>%
#   dplyr::filter(dataset == "cf") %>%
#   dplyr::select(diff_GMV)
# cf.lm.gmvdiff <- cent.diffs2 %>%
#   dplyr::filter(dataset == "cf.lm") %>%
#   dplyr::select(diff_GMV) 
# 
# t.test(cf.gmvdiff, cf.lm.gmvdiff, paired=TRUE)
```

NOTE: "missing" paired comparisons between cf and cf.lm diffs are because diff values are identical between the two methods (i.e. there is literally no difference in accuracy of centile scores between the two)

```{r, warning=FALSE, message=FALSE}
#within each phenotype, iterate paired t test between each combo of combat dfs 

#initalize empty dfs to store outputs
sum.df <- data.frame(pheno = character(),
                     term = character(),
                     df = double(),
                     sumsq = double(),
                     meansq = double(),
                     statistic = double(),
                     p.value = double())
t.df <- data.frame("pheno" = character(),
                   "group1" = character(),
                   "group2" = character(),
                   "p.value" = double())
pheno_diff.list <- paste0("diff_", pheno_list)

#run tests
attach(cent.diffs2)
for (pheno in pheno_diff.list) {
  df.aov <- tidy(aov(cent.diffs2[[pheno]] ~ cent.diffs2[["dataset"]]))
  df.aov$pheno <- pheno
  sum.df <- rbind(sum.df, df.aov)

  df.pairwise.t <- tidy(pairwise.t.test(x=cent.diffs2[[pheno]], g=cent.diffs2[["dataset"]], paired = TRUE, p.adj = "none"))
  df.pairwise.t$pheno <- pheno
  t.df <- rbind(t.df, df.pairwise.t)
}
detach()
```

```{r}
#apply fdr correction
sum.df <- sum.df %>%
  dplyr::filter(term != "Residuals") %>%
  mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno_list)))

summary(sum.df$p.val_fdr)

t.df <- t.df %>%
  mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno)),
         sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                             p.val_fdr >= 0.05 ~ FALSE),
         pheno = sub("diff_", "", pheno)) %>%
  unite(comp, c("group1", "group2")) %>%
  mutate(comp = as.factor(comp))
table(t.df$comp)

t.df %>%
  group_by(comp) %>%
   summarize(n_sig_regions = sum(sig_fdr),
            n_compare = n(),
            min_pval = min(p.val_fdr),
            max_pval = max(p.val_fdr))
```

##### Sex-Biases

Do the different combat methods introduce any kind of bias in centile scores?

```{r}
mean.cent.diffs.by.sex <- cent_diffs %>%
  group_by(dataset, sex) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

mean.cent.diffs.by.sex %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(centile_diff = centile_diff *100) %>%
ggplot() +
  geom_density(aes(x=centile_diff, fill=sex), alpha=0.5) +
  facet_wrap(~dataset, scales = "free_y")


max.cent.diffs.by.sex <- cent_diffs %>%
  group_by(dataset, sex) %>%
  summarize(across(starts_with("abs.diff_"), max)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="max_centile_diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

max.cent.diffs.by.sex %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(max_centile_diff = max_centile_diff *100) %>%
ggplot() +
  geom_density(aes(x=max_centile_diff, fill=sex), alpha=0.5) +
  facet_wrap(~dataset, scales = "free_y")
```

No shift in abs. differences, looking at overall diff.
```{r}
#get centile errors for each subject - not abs val
cent.diffs3 <- combined_preds %>%
  dplyr::filter(!str_detect(dataset, "_refA")) %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb_CN")) %>%
  arrange(dataset) %>%
  group_by(participant) %>%
  mutate(across(all_of(pheno_list), ~ . - first(.), .names = "diff_{.col}")) %>%
  ungroup() %>%
  dplyr::filter(dataset != "ukb_CN") #drop ref
saveRDS(cent.diffs3, file="ukb_basic/cent_diffs.RDS")
```

```{r, eval=FALSE}
cent.diffs3 %>%
  #dplyr::filter(dataset == "cf.gamlss") %>%
  pivot_longer(starts_with("diff_"), names_to="pheno", values_to="diff", names_prefix = "diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
  ggplot() +
  geom_density(aes(x=diff, fill=dataset), alpha=0.4) +
  facet_wrap(~pheno_cat) +
  theme(legend.position="none")
```

```{r}
max.cent.diffs.by.sex2 <- cent.diffs3 %>%
  group_by(dataset, sex) %>%
  summarize_at(vars(starts_with("diff")), list(max_value = ~.[which.max(abs(.))])) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("diff_"), values_to="max_centile_diff", names_to = "pheno", names_prefix = "diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

max.cent.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(max_centile_diff = max_centile_diff *100) %>%
ggplot() +
  geom_density(aes(x=max_centile_diff, fill=sex), alpha=0.5) +
  facet_wrap(~dataset, scales="free")
```

Other methods are fairly consistently underestimating male centiles and overestimating female centiles.

```{r}
mean.cent.diffs.by.sex2 <- cent.diffs3 %>%
  group_by(dataset, sex) %>%
  summarize(across(starts_with("diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("diff_"), values_to="centile_diff", names_to = "pheno", names_prefix = "diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

mean.cent.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(centile_diff = centile_diff *100) %>%
ggplot() +
  geom_density(aes(x=centile_diff, fill=sex), alpha=0.5) +
  facet_wrap(~dataset, scales="free")
```

T test of mean diff. between sex w/in each dataset
```{r}
t.test.by.sex <- mean.cent.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  group_by(dataset) %>%
  summarise(t_statistic = t.test(centile_diff ~ sex)$statistic,
            p_value = t.test(centile_diff ~ sex)$p.value) %>%
  mutate(p_val_fdr.corr = p.adjust(p_value, method="fdr", n = length(dataset)),
         fdr_sig = case_when(p_val_fdr.corr < 0.05 ~ TRUE,
                             p_val_fdr.corr >= 0.05 ~ FALSE))

t.test.by.sex
```

Both gam methods and lm combat with ref both end up inducing a bias in how males and females centiles are shifted.

```{r, warning=FALSE, message=FALSE}
# within each df, within each phenotype, t-test between male and female diffs

#initalize empty dfs to store outputs
t.df.sex <- data.frame("pheno" = character(),
                   "dataset" = character(),
                   "p_value" = double()
                   )

for (pheno in pheno_diff.list){
    df.sex.test <- cent.diffs3 %>%
        group_by(dataset) %>%
        summarize(p_value = t.test(.data[[pheno]][sex == "Male"], .data[[pheno]][sex == "Female"])$p.value) %>%
        ungroup()
    df.sex.test$pheno <- pheno
    t.df.sex <- rbind(t.df.sex, df.sex.test)
}
```

```{r}
#apply fdr correction
t.df.sex <- t.df.sex %>%
  mutate(p.val_fdr = p.adjust(p_value, method="fdr", n = length(p_value)),
         sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                             p.val_fdr >= 0.05 ~ FALSE),
         pheno = sub("diff_", "", pheno))

t.df.sex %>%
  group_by(dataset) %>%
   summarize(n_sig_regions = sum(sig_fdr),
            n_compare = n())
```

#### Z-Score
calc how much z-scores change

```{r}
z_diffs <- combined_preds %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref = "ukb_CN")) %>%
  arrange(dataset) %>%
  group_by(participant) %>%
  mutate(across(ends_with(".z"), ~ abs(. - first(.)), .names = "abs.diff_{.col}")) %>%
  ungroup()
```

```{r}
#mean
mean.z.diffs <- z_diffs %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup()
mean.z.long <- mean.z.diffs %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="z_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
mean.z.long <- left_join(mean.z.long, dk.parc, by="label")

#max
max.z.diffs <- z_diffs %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), max)) %>%
  ungroup()
max.z.long <- max.z.diffs %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="max_z_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))
```

```{r}
mean.z.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  ggplot() +
  geom_histogram(aes(x=z_abs.diff, fill=dataset), color="black", alpha=0.5, position="identity") +
  theme_linedraw() +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_continuous(labels = label_comma()) +
  ggtitle("Mean absolute differences in Z-scores across ComBat \nprocessing pipelines for each phenotype")
```

```{r, fig.height=15, fig.width=12}
mean.z.long %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "ukb_CN") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = z_abs.diff)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("Mean difference in z scores across ComBat configurations")
```

```{r}
max.z.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  ggplot() +
  geom_histogram(aes(x=max_z_abs.diff, fill=dataset), color="black", binwidth = 0.025, alpha=0.5, position="identity") +
  theme_linedraw() +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_continuous(labels = label_comma()) +
  ggtitle("Mean absolute differences in Z-scores across ComBat \nprocessing pipelines for each phenotype")
```

```{r, fig.height=15, fig.width=12}
max.z.long %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "ukb_CN") %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = max_z_abs.diff)) +
  scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_void() +
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("Maximum difference in z scores across ComBat configurations")
```


Test for differences in distribution

```{r, warning=FALSE, message=FALSE}
#within each phenotype, iterate paired t test between each combo of combat dfs 

z_diffs.filt <- z_diffs %>%
  dplyr::filter(!str_detect(dataset, "_refA")) %>%
  dplyr::filter(dataset != "ukb_CN")

#initalize empty dfs to store outputs
z.sum.df <- data.frame(pheno = character(),
                     term = character(),
                     df = double(),
                     sumsq = double(),
                     meansq = double(),
                     statistic = double(),
                     p.value = double())
z.t.df <- data.frame("pheno" = character(),
                   "group1" = character(),
                   "group2" = character(),
                   "p.value" = double())

z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#run tests
attach(z_diffs.filt)
for (pheno in z.pheno_abs.diff.list) {
  df.aov <- tidy(aov(z_diffs.filt[[pheno]] ~ z_diffs.filt[["dataset"]]))
  df.aov$pheno <- pheno
  z.sum.df <- rbind(z.sum.df, df.aov)

  df.pairwise.t <- tidy(pairwise.t.test(x=z_diffs.filt[[pheno]], g=z_diffs.filt[["dataset"]], paired = TRUE, p.adj = "none"))
  df.pairwise.t$pheno <- pheno
  z.t.df <- rbind(z.t.df, df.pairwise.t)
}
detach()
```

```{r}
#apply fdr correction
z.sum.df <- z.sum.df %>%
  dplyr::filter(term != "Residuals") %>%
  mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno_list)))

summary(z.sum.df$p.val_fdr)

z.t.df <- z.t.df %>%
  mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno)),
         sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                             p.val_fdr >= 0.05 ~ FALSE),
         pheno = sub("abs.diff_", "", pheno),
         pheno = sub(".z", "", pheno)) %>%
  unite(comp, c("group1", "group2")) %>%
  mutate(comp = as.factor(comp))

z.t.df %>%
  group_by(comp) %>%
   summarize(n_sig_regions = sum(sig_fdr),
            n_compare = n(),
            min.pval = min(p.val_fdr),
            max.pval = max(p.val_fdr))
```

##### Sex-Biases

Test for sex-specific differences in mean z-score offset

```{r}
z_diffs2 <- combined_preds %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb_CN")) %>%
  arrange(dataset) %>%
  group_by(participant) %>%
  mutate(across(ends_with(".z"), ~ . - first(.), .names = "diff_{.col}")) %>%
  ungroup()
#write out
saveRDS(z_diffs2, file = "ukb_basic/z_diffs.RDS")

mean.z.diffs.by.sex2 <- z_diffs2 %>%
  group_by(dataset, sex) %>%
  summarize(across(starts_with("diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("diff_"), values_to="z_diff", names_to = "pheno", names_prefix = "diff_") %>%
  mutate(pheno = gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))
```
t-test
```{r}
t.test.by.sex_z <- mean.z.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  group_by(dataset) %>%
  summarise(t_statistic = t.test(z_diff ~ sex)$statistic,
            p_value = t.test(z_diff ~ sex)$p.value) %>%
  mutate(p_val_fdr.corr = p.adjust(p_value, method="fdr", n = length(dataset)),
         fdr_sig = case_when(p_val_fdr.corr < 0.05 ~ TRUE,
                             p_val_fdr.corr >= 0.05 ~ FALSE))

t.test.by.sex_z
```

Same results as centiles.

#### GAMs
scp'd csvs from cubic (`scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/*.csv' ./ukb_basic`)

```{r}
anova.gam <- fread("ukb_basic/anova_gam_tests.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1)
gam.sex.df <- fread("ukb_basic/sex_summary_gam.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1)
gam.sum.df <- fread("ukb_basic/gam_summary.csv", stringsAsFactors = TRUE)%>%
  dplyr::select(-V1)
```

Does the number of regions w significant age effects on mean change depending on combat version?

```{r}
anova.gam %>%
  dplyr::filter(term=="poly(age_days, 3)") %>%
  group_by(dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())
```

No.


```{r, fig.height=10, fig.width=15}
anova.gam %>%
  dplyr::filter(term=="poly(age_days, 3)") %>%
  rename(f_val = "F") %>%
  ggplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_col(aes(x=phenotype, y=f_val, fill=dataset), position = "dodge")
```

```{r}
anova.gam_wide.f <- anova.gam %>%
  dplyr::filter(term=="poly(age_days, 3)") %>%
  rename(f_val = "F") %>%
  pivot_wider(id_cols= phenotype, names_from=dataset, values_from=f_val)

anova.gam.f_diff <- anova.gam_wide.f %>%
  rename_all(~ gsub("-", "_", .)) %>%
  mutate(across(starts_with("cf"), ~ . - ukb_CN_data_simsites)) %>%
  dplyr::select(!ukb_CN_data_simsites)%>%
  pivot_longer(!phenotype, names_to = "dataset", values_to = "f_diff") %>%
  mutate(dataset = as.factor(dataset))

summary(aov(f_diff ~ dataset, data=anova.gam.f_diff))

attach(anova.gam.f_diff)
pairwise.t.test(x=f_diff, g=dataset, p.adj = "bonf")
detach()

ggplot(anova.gam.f_diff) + 
  geom_density(aes(x=f_diff, fill=dataset), alpha=0.5)

anova.gam.f_diff %>%
  dplyr::filter(dataset == "cf.gamlss_data" | dataset == "cf.gam_data" | dataset == "cf.gam_refA_data" | dataset == "cf.gamlss_refA_data") %>%
ggplot() + 
  geom_density(aes(x=f_diff, fill=dataset), alpha=0.5)
```

So the effect sizes (if this F is the correct F to use as effect size) are closer to the "ground truth" for gamlss than non-gamlss combat methods. However, similar to other results, only combat w/o covariates and combat with linear covariates are significantly worse.

Does the number of regions w significant sex effects on mean change depending on combat version?

```{r}
anova.gam %>%
  dplyr::filter(term=="sexMale") %>%
  group_by(dataset) %>%
  summarize(n_sig_regions = sum(sig.drop_bf.corr),
            n_regions = n())
```

Not much, only for combat w/out covariates or linear covariates

```{r, fig.heigt=15}
gam.sum.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & term == "sexMale") %>%
  dplyr::filter(dataset == "cf.lm-data" | dataset == "cf.gamlss-data" | dataset == "ukb-CN-data-simsites"| dataset == "cf.lm-refA-data") %>%
  ggplot() +
  geom_col(aes(x=label, y=t_stat, fill=dataset), position="dodge") +
  facet_wrap(~pheno_cat, scales = "free_x") + 
  #theme_cowplot()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  #theme_void() +
  #theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  ggtitle("t-statistic for effect of male sex on mean")

gam.sum.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & term == "sexMale") %>%
  ggplot() +
    geom_density(aes(x=t_stat, fill=dataset), alpha=0.4) +
  facet_wrap(~dataset)
```

#### OHBM Abstract

rerunning stats above w/o ref-site combat versions (to account for different FDR correction) per Andrew's suggestion

Test

Test for differences in centile offset distributions
```{r}
mean.diffs.long_filt <- mean.diffs.long %>%
  filter(!str_detect(dataset, "_refA")) %>%
  filter(dataset != "ukb_CN")

summary(aov(centile_abs.diff ~ dataset, data=mean.diffs.long_filt))

attach(mean.diffs.long_filt)
pairwise.t.test(x=centile_abs.diff, g=dataset, p.adj = "bonferroni")
detach()
```

Testing for differences in Z offset distributions

```{r}
mean.z.long_filt <- mean.z.long %>%
  filter(!str_detect(dataset, "_refA"))

summary(aov(z_abs.diff ~ dataset, data=mean.z.long_filt))

attach(mean.z.long_filt)
pairwise.t.test(x=z_abs.diff, g=dataset, p.adj = "fdr")
detach()
```

Test for sex-biases in centile offsets

Test for sex-biases

```{r}
mean.z.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  filter(!str_detect(dataset, "_refA")) %>%
  group_by(dataset) %>%
  summarise(t_statistic = t.test(z_diff ~ sex)$statistic,
            p_value = t.test(z_diff ~ sex)$p.value) %>%
  mutate(p_val_fdr.corr = p.adjust(p_value, method="fdr", n = length(dataset)),
         fdr_sig = case_when(p_val_fdr.corr < 0.05 ~ TRUE,
                             p_val_fdr.corr >= 0.05 ~ FALSE))

mean.cent.diffs.by.sex2 %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  filter(!str_detect(dataset, "_refA")) %>%
  group_by(dataset) %>%
  summarise(t_statistic = t.test(centile_diff ~ sex)$statistic,
            p_value = t.test(centile_diff ~ sex)$p.value) %>%
  mutate(p_val_fdr.corr = p.adjust(p_value, method="fdr", n = length(dataset)),
         fdr_sig = case_when(p_val_fdr.corr < 0.05 ~ TRUE,
                             p_val_fdr.corr >= 0.05 ~ FALSE))
```

##### Plots

Beta weight? or proportion?

```{r}
beta.plot2 <- sigma.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume" & term =="sexMale") %>%
  filter(!str_detect(dataset, "-refA")) %>%
  mutate(dataset = factor(dataset, levels = c("ukb-CN-simsites", "cf", "cf.lm", "cf.gam", "cf.gamlss"))) %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = var_est)) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Beta weight for effect of male sex on variance")

beta.plot2

ggsave("male_variance_beta2.jpeg", beta.plot2, width=10, height=10)
```

```{r}
sigma.aseg_all <- sigma.df %>%
  dplyr::filter(pheno_cat == "Global Volume" & term =="sexMale") %>%
  filter(!str_detect(dataset, "-refA")) %>%
  dplyr::select(!label) %>%
  mutate(dataset = factor(dataset, levels = c("ukb-CN-simsites", "cf", "cf.lm", "cf.gam", "cf.gamlss")),
         tissue_class = as.factor(case_when(pheno == "GMV" ~ "cGM",
                                            pheno == "Ventricles" ~ "CSF",
                                            pheno == "WMV" ~ "White Matter",
                                            pheno == "sGMV" ~ "sGM",
                                            TRUE ~ NA)),
         var_est = case_when(sig.sum_bf.corr == TRUE ~ var_est,
                             TRUE ~ NA)) #just keep significant regions

sigma.aseg_all <- left_join(sigma.aseg_all, aseg_cerebrum$data, by = c("tissue_class"))

sigma.aseg_all %>%
  group_by(dataset) %>%
  ggplot() +
  geom_brain(atlas = aseg_cerebrum, 
             #position = position_brain(hemi ~ side),
             aes(fill = var_est),
             alpha=0.8) +
  #scale_fill_gradient2() +
  facet_wrap(~dataset) + 
  theme_bw(base_size=20) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Beta weight for effect of male sex on variance")
```


```{r}
proportion_beta_plot2 <- sigma.df %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume" & term =="sexMale") %>%
  filter(!str_detect(dataset, "-refA")) %>%
  mutate(dataset = factor(dataset, levels = c("ukb-CN-simsites", "cf", "cf.lm", "cf.gam", "cf.gamlss"))) %>%
  group_by(dataset, pheno_cat) %>%
  ggplot() +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = beta_ratio)) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_bw(base_size=15) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA)) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo") +
  ggtitle("Proportion of effect of male sex on variance")

proportion_beta_plot2
ggsave("male_variance_prop.beta2.jpeg", proportion_beta_plot2, width=10, height=10)
```

Centile plot

```{r}
#Define scales
scales_y <- list(
  `Global Volume` = scale_y_continuous(limits = c(0, 4)),
  `Regional CT` = scale_y_continuous(limits = c(0, 70)),
  `Regional SA` = scale_y_continuous(limits = c(0, 70)),
  `Regional Volume` = scale_y_continuous(limits = c(0, 70))
)

cent.diffs.plot2 <- mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  filter(!str_detect(dataset, "_refA")) %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset), color="black", alpha=0.4, position="identity") +
  theme_linedraw(base_size = 12) +
  scale_x_continuous(labels = label_comma()) + 
  facet_wrap(~pheno_cat) +
  #facetscales::facet_grid_sc(pheno_cat~.,
                #scales = list(y = scales_y)) +
  #paletteer::scale_fill_paletteer_d("Polychrome::light") +
  ggtitle("Mean absolute differences in centile scores across \nComBat processing pipelines for each phenotype")

cent.diffs.plot2
#ggsave("mean_centile_diffs2.jpeg", cent.diffs.plot2, width=10, height=10)
```
