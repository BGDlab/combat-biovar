---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

Rmd to show and get feedback on planned for results & figures for the combatLS paper. Currently thinking I'll have centile score results be the focus of the paper and keep z-scores for the supplement.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
```

single script to parse outputs & get results (condensed from `ukb_sim.site_analyses.Rmd`)

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives"

pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

pheno_list.z <- paste0(pheno_list, ".z")
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)
z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#also load raw data
ukb_cn_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/ukb_CN_data_simsites.csv")

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
```


# Define Functions

Pairwise T tests: within each feature, run paired t tests (welch's test on ranks) pairwise on each possible pairing of combat configs and return as a single dataframe, with FDR correction for all feature + cf pair combos. Currently runs on magnitude (abs val) of centile diffs, but can be run on other metrics by redefining `feature_list` Recommended for use with mclapply across list of dataframes. Optional argument to correct for more comparisons (e.g. fdr-correct across an entire list of dataframes) using `comp_multiplier` arg.

```{r}
#define function
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)

centile.t.tests <- function(df, feature_list=pheno_abs.diff.list, comp_multiplier=1){
  #initialize empty dfs to store outputs
  t.df <- data.frame("pheno" = character(),
                     "group1" = character(),
                     "group2" = character(),
                     "p.value" = double())
  #run tests
  attach(df)
  for (pheno in feature_list) {
    df.pairwise.t <- tidy(pairwise.rank.welch.t.test(x=df[[pheno]], g=df[["dataset"]], paired = TRUE, p.adj = "none"))
    df.pairwise.t$pheno <- pheno
    t.df <- rbind(t.df, df.pairwise.t)
  }
  n_comp <- nrow(t.df)

  #apply fdr correction
  t.df <- t.df %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)),
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE),
           pheno = sub("abs.diff_", "", pheno)) %>%
    unite(comp, c("group1", "group2")) %>%
   dplyr::mutate(comp = as.factor(comp))

  t.df.sum <- t.df %>%
    group_by(comp) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
  return(t.df.sum)
  #detach()
}

### EXAMPLE:
# perm_t.tests <- mclapply(perm_diffs, centile.t.tests, mc.preschedule = FALSE)
# names(perm_t.tests) <- n_perm_list
# cent_t.tests.p <- bind_rows(perm_t.tests, .id = "column_label")
```

Within each combat config, test if there are significant differences in M and F subject's mean abs. centile error. Can test mean (not abs) centile errors, Z errors, etc, using `to_test` arg. FDR corrects for number of datasets tested

```{r}
sex.bias.t.tests <- function(df, to_test = "mean_cent_abs.diff", comp_multiplier=1){

  #conduct t test
  df.sex.t <- df %>%
    group_by(dataset) %>%
    summarise(p.value = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$p.value,
              sex_diff = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$estimate,
              t.stat = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$statistic,
              df = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$parameter) %>%
    ungroup()

  #apply fdr correction
  n_comp=length(unique(df$dataset))
  df.sex.t <- df.sex.t %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)), #use comp_multiplier if using fun with lapply
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE))
  return(df.sex.t)
  #detach()
}

# tidy(rank.welch.t.test.formula(formula=mean_cent_abs.diff ~ sex, data= ratio_subj_list[[1]], paired = FALSE, p.adj = "none"))
# rank.welch.t.test.formula(formula=mean_cent_abs.diff ~ sex, data= ratio_subj_list[[1]], paired = FALSE, p.adj = "none")
```

modifying to test for sex-biases w/in feature rather than mean centiles

```{r}
pheno_diff_list <- paste0("diff_", pheno_list)
sex.bias.feat.t.tests <- function(df, feature_list=pheno_diff_list, comp_multiplier=1){
  
  #initialize empty df to store outputs
  t.df <- data.frame("dataset" = character(),
                     "pheno" = character(),
                     "p.value" = double(),
                     "sex_diff" = double(),
                     "t.stat" = double(),
                     "df" = double())
  attach(df)
  for (pheno in feature_list) {
  #print(paste("t-test:", pheno))

  #conduct t test
  df.sex.t <- df %>%
    group_by(dataset) %>%
    summarise(p.value = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$p.value,
              sex_diff = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$estimate,
              t.stat = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$statistic,
              df = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$parameter) %>%
    ungroup()

  df.sex.t$pheno <- sub("diff_", "", pheno)

  #append to full df
  t.df <- rbind(t.df, df.sex.t)
  }
  detach(df)

  #also get medians for m and f
  med_df <- df %>%
  dplyr::group_by(dataset, sex) %>%
    summarise_at(feature_list, median) %>%
    ungroup() %>%
    pivot_longer(cols = starts_with("diff_"), names_to="pheno", names_prefix="diff_") %>%
    pivot_wider(names_from = sex, values_from=value, names_glue = "med_{sex}") %>%
    mutate(median_sex_diff = (med_Male - med_Female)) %>%
    ungroup()

  #combine feature dfs
  result_df <- left_join(t.df, med_df)  
  
  #apply fdr correction
  n_comp=length(unique(df$dataset))*length(feature_list)
  result_df <- result_df %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)), #use comp_multiplier if using fun with lapply
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE),
           dataset=as.factor(dataset))

  # #summarize
  # df.sex.t.sum <- df.sex.t %>%
  #   group_by(dataset) %>%
  #   dplyr::summarize(n_sig_regions = sum(sig_fdr),
  #             min_pval = min(p.val_fdr),
  #             max_pval = max(p.val_fdr)) %>%
  #   ungroup() %>%
  #   as.data.frame()
  
  return(result_df)

}
# sex.bias.feat.t.tests(diffs.df, feature_list = global.diff)
```


Test for linear relationships between subject's actual centile score (calculated from raw data) and how much that score is affected by different combat methods.

```{r}
extremeness.lm <- function(df, f, comp_multiplier=1){

  #conduct t test
  df.lm <- df %>%
    group_by(dataset) %>%
    #returns values for last (highest order) predictor
    summarise(p.value = tail(tidy(lm(as.formula(f)))$p.value, n=1),
              estimate = tail(tidy(lm(as.formula(f)))$estimate, n=1),
              t.stat = tail(tidy(lm(as.formula(f)))$statistic[2], n=1),
              std.error = tail(tidy(lm(as.formula(f)))$std.error[2]), n=1) %>%
    ungroup()
  n_comp=length(unique(df$dataset))

  #apply fdr correction
  df.lm <- df.lm %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)),
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE))
  return(df.lm)
  #detach()
}

# tidy(lm(mean_centile ~ mean_cent_diff, data= ratio_subj_list[[1]]))
# summary(lm(mean_centile ~ mean_cent_diff, data= ratio_subj_list[[1]]))
```

plot w/in feature average centile errors

```{r}
#define plotting
plot.cent.diffs <- function(df){
mean.diffs.long <- df %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  dplyr::summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  dplyr::select(-ends_with(".z")) %>% #drop z-score cols
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))

cent.diffs.plot <- mean.diffs.long %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y= "Percent Features", x = "Mean Absolute Centile Error") +
  ggtitle("Absolute errors in centile scores across ComBat processing pipelines")

print(cent.diffs.plot)
}
```


# Secondary: Vary M:F

```{r}
n_prop_list <- c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F")
```

## Load Data

pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/*_diffs.csv' .`

pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/subject-wise/*.csv' .`

Read in centile/z-score errors

```{r}
ratio_data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/ukb_ratio"
raw_files <- list.files(path = ratio_data_path, pattern = "_diffs.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  print(paste("reading file", file))
  # Read each CSV file
    data <- fread(file)
    
    data <- data %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list[[file]] <- as.data.frame(data)
    assign("ratio_list", df_list)
}
length(ratio_list)
ratio.df <- bind_rows(ratio_list)

# #sum(is.na(ratio.df))
# na.df <- ratio.df[rowSums(is.na(ratio.df)) > 0,]
# skimr::skim(na.df)
# 
# names(ratio.df)
ratio.df[is.na(ratio.df$diff_lh_CT_cuneus.z),] %>%
  dplyr::select(contains("_cuneus"), "participant", "dataset")
```

Read in subject-wise summary stats

```{r}
raw_files <- list.files(path = ratio_data_path, pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("ratio_subj_list", df_list)
}
length(ratio_subj_list)
ratio_subj.df <- bind_rows(ratio_subj_list)

max(ratio_subj.df$mean_centile)
min(ratio_subj.df$mean_centile)
max(ratio_subj.df$mean_z)
min(ratio_subj.df$mean_z)
```

```{r}
for (l in unique(ratio_subj.df$dataset)){
plot <- ratio_subj.df %>%
  dplyr::filter(dataset == l) %>%
  ggplot(aes(x=mean_centile, y=mean_cent_diff, color=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  facet_grid(sim.site ~ prop) +
  ggtitle(l)
print(plot)
}
```

Do centile scores change based on combat version?

need to look and see what happens for subjects who aren't in all samples?

Plot boxplots to compare across prop.

```{r, eval=FALSE}
#too much memory to run!
ratio.df %>%
  dplyr::select(sim.site, prop, dataset, starts_with("abs.diff"), !ends_with(".z")) %>%
  pivot_longer(cols= starts_with("abs.diff"), names_to="pheno", nammes_prefix="abs.diff_", values_to="cent_abs.diff") %>%
  mutate(cent_abs.diff = cent_abs.diff * 100) %>%
  ggplot() +
    geom_boxplot(aes(x=prop, y=cent_abs.diff, fill=dataset)) +
  labs(y= "Magnitude Centile Error", x = "M:F Ratio in Site B") +
  ggtitle("Error in centile scores across ComBat \nconfigurations as sex imbalance changes")
```

Plot w/in subj means

```{r}
ratio_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff * 100) %>%
  ggplot() +
    geom_boxplot(aes(x=prop, y=mean_cent_abs.diff, fill=dataset)) +
  labs(y= "Magnitude Centile Error", x = "M:F Ratio in Site B") +
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat \nconfigurations as sex imbalance changes")

ratio_subj.df %>%
  ggplot() +
    geom_boxplot(aes(x=prop, y=mean_z_abs.diff, fill=dataset)) +
  labs(y= "Magnitude Z-score Error", x = "M:F Ratio in Site B") +
  ggtitle("Within-subject mean magnitude of error in z-scores across ComBat \nconfigurations as sex imbalance changes")
```

W/in subj average plots

```{r}
cent.diffs.v.plot.r <- ratio_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=prop, y=mean_cent_abs.diff, fill=dataset), scale="width") +
  labs(y= "Magnitude Centile Error", x = "ComBat Configurations") +
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat \nconfigurations while varying M:F")
cent.diffs.v.plot.r
ggsave(filename="figs/ratio_centile_violin.png", cent.diffs.v.plot.r)
```

**Stats Tests**
Within each M:F proportion simulated, is the magnitude of subjects' mean centile errors differ significantly by combat configuration?

```{r}
prop_abs.cent_t.tests <- mclapply(ratio_list, centile.t.tests, comp_multiplier=11, mc.preschedule = FALSE) #FDR correction across 11 M:F permutations
names(prop_abs.cent_t.tests) <- n_prop_list
prop_abs.cent_t.tests_df <- bind_rows(prop_abs.cent_t.tests, .id = "column_label")
```

Visalize
```{r}
ggplot(prop_abs.cent_t.tests_df) +
  geom_col(aes(x=column_label, y=n_sig_regions, fill=column_label)) +
  geom_hline(yintercept = 208, linetype='longdash') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position="none") +
  facet_wrap(~comp)
```

## Sex-Biases

```{r}
ratio_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=prop, y=mean_cent_abs.diff, fill=sex), scale="width") +
  facet_wrap(~dataset) +
  labs(y= "Magnitude Centile Error", x = "ComBat Configurations") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat \nconfigurations while varying M:F")
```

```{r}
cent.diffs.v.boxplot.r_sex_free <- ratio_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_boxplot(aes(x=prop, y=mean_cent_abs.diff, fill=sex)) +
  facet_wrap(~dataset, scale="free_y") +
  labs(y= "Magnitude Centile Error", x = "ComBat Configurations") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat \nconfigurations while varying M:F")
cent.diffs.v.boxplot.r_sex_free
ggsave(filename="figs/ratio_centile_box_sex_free.png", cent.diffs.v.boxplot.r_sex_free)
```


```{r}
#trying to add significance testing
abs.cent.diffs.by.sex.stat.test <- ratio_subj.df %>%
  dplyr::filter(dataset != "cf") %>% #because it's the same as cf.lm
  group_by(dataset, prop) %>%
  wilcox_test(mean_cent_abs.diff ~ sex) %>%
  adjust_pvalue(method = "fdr") %>%
  add_significance() %>%
  add_xy_position(x = "prop")

abs.cent.diffs.v.boxplot.r_sex <- ratio_subj.df %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  dplyr::filter(dataset != "cf") %>% #because it's the same as cf.lm
  droplevels() %>%
  ggplot() +
  geom_boxplot(aes(x=prop, y=mean_cent_abs.diff, fill=sex)) +
  facet_wrap(~dataset) +
  labs(y= "Mean Magnitude Centile Error", x = "Site B M:F") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  stat_pvalue_manual(
    cent.diffs.by.sex.stat.test, label = "p.adj.signif", tip.length = 0, bracket.shorten=0.005,
    #hide.ns = TRUE
    bracket.nudge.y = -0.5
    ) +
  ggtitle("Within-subject error in centile scores across ComBat configurations while varying M:F")
cent.diffs.v.boxplot.r_sex
ggsave(filename="figs/ratio_abs.centile_box_sex.png", abs.cent.diffs.v.boxplot.r_sex, width = 25, height = 12, units = "cm")
```

eval diffs (not abs. diffs)

```{r}
#trying to add significance testing
cent.diffs.by.sex.stat.test <- ratio_subj.df %>%
  dplyr::filter(dataset != "cf") %>% #because it's the same as cf.lm
  group_by(dataset, prop) %>%
  wilcox_test(mean_cent_diff ~ sex) %>%
  adjust_pvalue(method = "fdr") %>%
  add_significance() %>%
  add_xy_position(x = "prop")

cent.diffs.v.boxplot.r_sex <- ratio_subj.df %>%
  mutate(mean_cent_diff = mean_cent_diff*100) %>% #for visuals
  dplyr::filter(dataset != "cf") %>% #because it's the same as cf.lm
  droplevels() %>%
  ggplot() +
  geom_boxplot(aes(x=prop, y=mean_cent_diff, fill=sex)) +
  facet_wrap(~dataset) +
  labs(y= "Mean Magnitude Centile Error", x = "Site B M:F") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  stat_pvalue_manual(
    cent.diffs.by.sex.stat.test, label = "p.adj.signif", tip.length = 0, bracket.shorten=0.005,
    #hide.ns = TRUE
    bracket.nudge.y = 4.5
    ) +
  ggtitle("Within-subject error in centile scores across ComBat configurations while varying M:F")
cent.diffs.v.boxplot.r_sex
ggsave(filename="figs/ratio_centile_box_sex.png", cent.diffs.v.boxplot.r_sex, width = 25, height = 12, units = "cm")
```

### Significance Testing

#### CENTILES
within each M:F prop, test male vs female subject's mean abs. centile diff
```{r}
sex_bias_ratio_abs.tests <- mclapply(ratio_subj_list, sex.bias.t.tests, mc.preschedule = FALSE, comp_multiplier = 11)
names(sex_bias_ratio_abs.tests) <- n_prop_list
sex_bias_ratio_abs.tests_df <- bind_rows(sex_bias_ratio_abs.tests, .id = "prop")
```

Visualize
```{r}
sex_bias_ratio_abs.tests_df %>%
  dplyr::filter(sig_fdr == TRUE) %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         prop = factor(prop, levels=n_prop_list, ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=prop, fill=sex_diff)) + 
    geom_raster() +
    paletteer::scale_fill_paletteer_c("ggthemes::Classic Green-Blue") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    coord_fixed()
```

test actual (not abs. val) centile errors

```{r}
sex_bias_ratio_tests <- mclapply(ratio_subj_list, sex.bias.t.tests, to_test = "mean_cent_diff", mc.preschedule = FALSE, comp_multiplier = 11)
names(sex_bias_ratio_tests) <- n_prop_list
sex_bias_ratio_tests_df <- bind_rows(sex_bias_ratio_tests, .id = "prop")
```

Visualize
```{r}
sex_bias_ratio_tests_df %>%
  dplyr::filter(sig_fdr == TRUE) %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         prop = factor(prop, levels=n_prop_list, ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=prop, fill=sex_diff)) + 
    geom_raster() +
    paletteer::scale_fill_paletteer_c("ggthemes::Classic Green-Blue") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    coord_fixed()
```

#### Z-SCORES

```{r}
sex_bias_ratio_abs.tests.z <- mclapply(ratio_subj_list, sex.bias.t.tests, to_test ="mean_z_abs.diff", mc.preschedule = FALSE, comp_multiplier = 11)
names(sex_bias_ratio_abs.tests.z) <- n_prop_list
sex_bias_ratio_abs.tests.z_df <- bind_rows(sex_bias_ratio_abs.tests.z, .id = "prop")
```

Visualize
```{r}
sex_bias_ratio_abs.tests.z_df %>%
  dplyr::filter(sig_fdr == TRUE) %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         prop = factor(prop, levels=n_prop_list, ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=prop, fill=sex_diff)) + 
    geom_raster() +
    paletteer::scale_fill_paletteer_c("ggthemes::Classic Green-Blue") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    coord_fixed()
```


```{r}
sex_bias_ratio_tests.z <- mclapply(ratio_subj_list, sex.bias.t.tests, to_test ="mean_z_diff", mc.preschedule = FALSE, comp_multiplier = 11)
names(sex_bias_ratio_tests.z) <- n_prop_list
sex_bias_ratio_tests.z_df <- bind_rows(sex_bias_ratio_tests.z, .id = "prop")
```

Visualize
```{r}
sex_bias_ratio_tests.z_df %>%
  dplyr::filter(sig_fdr == TRUE) %>%
  mutate(dataset = factor(dataset, levels = c("cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         prop = factor(prop, levels=n_prop_list, ordered=TRUE)) %>%
  ggplot(aes(x=dataset, y=prop, fill=sex_diff)) + 
    geom_raster() +
    paletteer::scale_fill_paletteer_c("ggthemes::Classic Green-Blue") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    coord_fixed()
```

## Extremeness-Biases
Does a person's centile error depend on their true centile value (e.g., very low or very high centiles more or less likely to have errors)

#### CENTILES

test w/in subj avg centile ~ w/in subj avg centile error

```{r}
#testing
test.lm <- lm(mean_cent_diff ~ mean_centile*as.factor(dataset), data=ratio_subj_list[[1]])
tidy(test.lm)
interactions::interact_plot(test.lm, pred = mean_centile, modx = dataset)

ggplot(ratio_subj_list[[4]], aes(x=mean_centile, y=mean_cent_diff, color=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  facet_wrap(~dataset, scales="free_y")
```

```{r}
ext.bias_test.ln <- mclapply(ratio_subj_list, extremeness.lm, f="mean_centile ~ mean_cent_diff", comp_multiplier= 33, mc.preschedule=FALSE)
names(ext.bias_test.ln) <- n_prop_list
linear <- as.data.frame(bind_rows(ext.bias_test.ln, .id = "prop"))

ext.bias_test.sq <- mclapply(ratio_subj_list, extremeness.lm, f="mean_centile ~ poly(mean_cent_diff, 2)", comp_multiplier= 33, mc.preschedule=FALSE)
names(ext.bias_test.sq) <- n_prop_list
square <- as.data.frame(bind_rows(ext.bias_test.sq, .id = "prop"))

ext.bias_test.cb <- mclapply(ratio_subj_list, extremeness.lm, f="mean_centile ~ poly(mean_cent_diff, 3)", comp_multiplier= 33, mc.preschedule=FALSE)
names(ext.bias_test.cb) <- n_prop_list
cubic <- as.data.frame(bind_rows(ext.bias_test.cb, .id = "prop"))

#one big dataframe
ext.bias_test.df <- bind_rows(linear, square, cubic, .id = "model")
```

summarize across modeling options

```{r}
ext.bias_test.df %>%
  group_by(dataset, prop) %>%
  dplyr::arrange(p.val_fdr) %>%
  slice(1) %>% #get lowest p-val
  ungroup()
```

#### Z-SCORES
```{r}
ext.bias_test.z.ln <- mclapply(ratio_subj_list, extremeness.lm, f="mean_z ~ mean_z_diff", comp_multiplier=33, mc.preschedule=FALSE)
names(ext.bias_test.z.ln) <- n_prop_list
linear <- as.data.frame(bind_rows(ext.bias_test.z.ln, .id = "prop"))

ext.bias_test.z.sq <- mclapply(ratio_subj_list, extremeness.lm, f="mean_z ~ poly(mean_z_diff, 2)", comp_multiplier= 33, mc.preschedule=FALSE)
names(ext.bias_test.z.sq) <- n_prop_list
square <- as.data.frame(bind_rows(ext.bias_test.z.sq, .id = "prop"))

extremeness.lm(ratio_subj_list[[2]], f="mean_z ~ poly(mean_z_diff, 2)")


ext.bias_test.z.cb <- mclapply(ratio_subj_list, extremeness.lm, f="mean_z ~ poly(mean_z_diff, 3)", comp_multiplier= 33, mc.preschedule=FALSE)
names(ext.bias_test.z.cb) <- n_prop_list
cubic <- as.data.frame(bind_rows(ext.bias_test.z.cb, .id = "prop"))

#one big dataframe
ext.bias_test.z.df <- bind_rows(linear, square, cubic, .id = "model")
```

summarize across modeling options

```{r}
ext.bias_test.z.df %>%
  group_by(dataset, prop) %>%
  dplyr::arrange(p.val_fdr) %>%
  slice(1) %>% #get lowest p-val
  ungroup()
```

## Scale Effects of Sex

sex-diff in variance as function of M:F!

fix age, get diff between male and female pred. variance
```{r}
# combined_preds.p <- data.frame()
get.var <- function(x){
  df <- data.frame() #new empty dataframe
  var.csvs.p <- list.files(path = permutation_path, pattern = paste0(x, ".+_variance.csv"), full.names = TRUE)
  for (file in var.csvs.p) {
    # Read each CSV file
    data <- fread(file)

    # Add a "Source_File" column with the file name
    data <- data %>%
      mutate(Source_File = as.factor(basename(file)),
             perm = as.factor(x)) %>%
      mutate(dataset = gsub("_data|_variance.csv|perm-|[0-9]|-", "", Source_File),
             sex_standard = sex_effect/f.var,
             pheno = as.character(pheno))

    # Bind the data to the combined dataframe
    df <- bind_rows(df, data, .id = "File_ID")
  }
  return(df)
}

perm_var <- mclapply(n_perm_list, get.var, mc.preschedule = FALSE)
perm_var.all <- bind_rows(perm_var, .id = "column_label")
```

maybe better to get sex_summary.csv - just need signifigance

```{r}
#get summary df for p vals, plotting
sigma.sex.df <- fread("ukb_perm_csvs/sex_summary.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1) %>%
  mutate(perm = gsub("ukb-CN-data-agefilt-|-raw|-cf|.lm|.gam|.gamlss|-data", "", dataset),
         dataset = gsub("-data", "", dataset),
         dataset = gsub("simsites|ukb-CN-agefilt-|perm-|[0-9]", "", dataset),
         dataset = gsub("-", "", dataset),
         #dataset = as.character(dataset),
         pheno = as.character(pheno)) %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE),
         perm = factor(perm, levels = unique(perm), ordered=FALSE)) %>%
  #mutate(dataset = relevel(dataset, ref= "raw")) %>%
  dplyr::filter(parameter == "sigma" & term == "sexMale") %>%
  dplyr::select(mod_name, pheno, dataset, pheno_cat, label, sig.sum_bf.corr, perm, sig.drop_bf.corr)

perm_var_info <- inner_join(perm_var.all, sigma.sex.df)
```

```{r}
  sex_effect_plot <- perm_var_info %>%
    mutate(sex_standard = case_when(sig.drop_bf.corr == TRUE ~ sex_standard,
                                    sig.drop_bf.corr == FALSE ~ 0)) %>% #only significant effects
    ggplot() +
    geom_col(aes(x=pheno, y=sex_standard, fill=dataset)) +
    facet_wrap(~perm, ncol=5) +
    ggtitle(paste("Standardized effect of male sex on variance")) +
    theme(axis.text.x = element_blank())
  
    ggsave(paste0("figs/male_variance_perms.jpeg"), sex_effect_plot)
    print(sex_effect_plot)
```


