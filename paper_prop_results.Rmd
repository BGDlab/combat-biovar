---
title: "ComBatLS Varying-Ratio Results"
output: html_document
date: '2023-11-12'
---

Rmd to compile and visualize tests of ComBatLS against other harmonization methods when varying the M:F ratios of each simulated site. 

Relies on outputs derived/functions from:

1. `ukb_curation-eda.Rmd`
2. `run_varying_ratios_pipeline.sh`
   - `R_scripts/permute_sites_varying_ratio.R`
   - `R_scripts/combat_apply.R`
   - `R_scripts/fit_perm_basic_mod.R`
   - `R_scripts/fit_centiles.R`
   - `R_scripts/summarise_cent_subj-wise.R`
3. `run_varying_ratios_stats.sh`
   - `R_scripts/summarise_cent_subj-wise.R`
   - `R_scripts/ratio_results.R`
   - `R_scripts/featurewise_sex_bias_test.R`
   - `R_scripts/remove_extremes_single.R`
4. `pull_stats.sh`
   
# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, ggh4x, purrr)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")
```

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives/ukb_ratio"

#pheno lists
pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

#diff lists
pheno_diff_list <- paste0("diff_", pheno_list)
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)


#z lists
pheno_list.z <- paste0(pheno_list, ".z")
z.pheno_diff_list <- paste0(pheno_diff_list, ".z")
z.pheno_abs.diff.list <- paste0(pheno_abs.diff.list, ".z")
```

```{r}
remotes::install_github("BGDlab/ggsegTissue")
library(ggsegTissue)
#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
#plotting info from dk atlas
dk.parc <- dk_nomed$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
```


```{r}
dataset_names <- c('raw' = "Raw Data",  cf = "ComBat w/o cov", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
n_prop_list <- c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F")
```

## Load Data

pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/*_diffs.csv' .`

pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/subject-wise/*.csv' .`

Read in centile/z-score errors


```{r}
raw_files <- list.files(path = data_path, pattern = "_diffs.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  print(paste("reading file", file))
  # Read each CSV file
    data <- fread(file)
    
    data <- data %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list[[file]] <- as.data.frame(data)
    assign("ratio_list", df_list)
}
length(ratio_list)
ratio.df <- bind_rows(ratio_list)

# #sum(is.na(ratio.df))
# na.df <- ratio.df[rowSums(is.na(ratio.df)) > 0,]
# skimr::skim(na.df)
# 
# names(ratio.df)
```

Read in subject-wise summary stats

```{r}
raw_files <- list.files(path = data_path, pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("ratio_subj_list", df_list)
}
length(ratio_subj_list)
ratio_subj.df <- bind_rows(ratio_subj_list)

max(ratio_subj.df$mean_centile)
min(ratio_subj.df$mean_centile)
max(ratio_subj.df$mean_z)
min(ratio_subj.df$mean_z)
```
some quick eda

```{r}
ratio.df %>%
  ggplot() +
  geom_violin(aes(y=diff_GMV, x= sex, fill=sim.site)) +
  facet_grid(dataset~prop, scales="free_y")

ratio.df %>%
  ggplot() +
  geom_violin(aes(y=abs.diff_GMV, x= sex, fill=sim.site)) +
  facet_grid(dataset~prop, scales="free_y")
```

Visualize sex-distribution across sites/proportions

```{r}
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio.df$prop))

sampling.plt <- ratio.df %>%
  dplyr::filter(dataset=="cf") %>%
  # mutate(sim.site = case_when(sim.site == "Balanced" ~ "A",
  #                             sim.site == "Imbalanced" ~ "B")) %>%
ggplot() +
  geom_bar(aes(x=sim.site, fill=sex)) +
  theme_linedraw() +
  theme(axis.ticks.x = element_blank(), axis.text.x=element_blank(), panel.spacing.x = unit(.1, "lines"), legend.position = "bottom") +
  xlab("Simulated Site") +
  ylab("Subjects") +
  labs(fill="Sex") +
  facet_wrap(~prop, nrow=1, labeller = as_labeller(percent_f))
sampling.plt
```

## CENTILES

Do centile score absolute errors change based on combat version? Tested by `ratio_results.R`, results written to `full_featurewise_cent_t_tests.csv`

```{r}
cent.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_cent_t_tests_all_out.RDS"))
# names(cent.feat.t.test) <- n_perm_list
cent.t.test.df <- bind_rows(cent.feat.t.test, .id="prop") %>%
  mutate(prop = factor(prop, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         comp = as.factor(comp),
         pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
      separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

cent.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio.df$prop))
comp_names <- c(cf.gam_cf = "ComBat-GAM v. \nComBat w/o Covar", cf.gamlss_cf = "ComBatLS v. ComBat w/o Covar", cf.gamlss_cf.gam = "ComBatLS v. ComBat-GAM", cf.lm_cf.gam ="ComBat-GAM v. linear ComBat", cf.lm_cf.gamlss = "ComBatLS v. linear ComBat", cf.lm_cf = "linear ComBat v. \nComBat w/o Covar")

cent.t.test.plt <- cent.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=smaller_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(pheno_cat ~ comp, labeller = labeller(comp = as_labeller(comp_names)), scales="free_y") +
  theme_linedraw() +
  scale_fill_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Feature Count", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
ggsave("figs/ratio_cent.t.test.plt.jpg", cent.t.test.plt, width=13, height=8, units="in")

cent.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(pheno_cat~comp, scales="free_y")
```

Plot errors for global phenotypes

add significance testing
```{r}
cent.t.test.list <- readRDS(paste0(data_path, "/full_featurewise_cent_t_tests_all_out.RDS"))

cent.t.test.list_global <- lapply(cent.t.test.list, function(x) filter(x, pheno %in% vol_list_global))
cent.t.test_global <- bind_rows(cent.t.test.list_global, .id = "prop") %>%
  dplyr::mutate(prop = case_when(prop == "0M:10F" ~ "prop-01", 
                                 prop == "1M:9F" ~ "prop-02", 
                                 prop == "2M:8F" ~ "prop-03", 
                                 prop == "3M:7F" ~ "prop-04", 
                                 prop == "4M:6F" ~ "prop-05", 
                                 prop == "5M:5F" ~ "prop-06", 
                                 prop == "6M:4F" ~ "prop-07", 
                                 prop == "7M:3F" ~ "prop-08", 
                                 prop == "8M:2F" ~ "prop-09", 
                                 prop == "9M:1F" ~ "prop-10", 
                                 prop == "10M:0F" ~ "prop-11",
                                 TRUE ~ NA_character_), 
                 comp = factor(comp, ordered=TRUE, levels=c("cf.gam_cf", "cf.gamlss_cf", "cf.gamlss_cf.gam", "cf.lm_cf", "cf.lm_cf.gam", "cf.lm_cf.gamlss")))
```

```{r}
prop.global_abs.diffs <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("abs.diff_", vol_list_global)) %>%
  #dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff") %>%
  mutate(abs.diff=abs.diff*100) %>%
  arrange(pheno, prop) %>%
  as.data.frame()

#wilcox test for visualizing significance - just going to use it for positioning info & setting up dataframe, will use actual tests run on CUBIC for signfificance
mean_comp_tbl_calc <- prop.global_abs.diffs %>%
  group_by(pheno, prop) %>%
  pairwise_wilcox_test(abs.diff ~ dataset, comparisons=list(c("cf.lm", "cf.gam"), c("cf.gam", "cf.gamlss"), c("cf.lm", "cf.gamlss")),
                       p.adjust.method = "fdr")
```

```{r}
mean_comp_tbl <- mean_comp_tbl_calc %>%
  mutate(comp = factor(paste(group2, group1, sep="_"), ordered=TRUE, levels=c("cf.gam_cf", "cf.gamlss_cf", "cf.gamlss_cf.gam", "cf.lm_cf", "cf.lm_cf.gam", "cf.lm_cf.gamlss"))) %>%
  arrange(prop, comp) %>%
  add_xy_position(x="prop", fun="max", comparisons=list(c("cf.lm", "cf.gam"), c("cf.gam", "cf.gamlss"), c("cf.lm", "cf.gamlss"), c("cf.lm", "cf"), c("cf", "cf.gam"), c("cf", "cf.gamlss")))

mean_comp_tbl2 <- inner_join(mean_comp_tbl, cent.t.test_global) %>%
  add_significance("p.val_fdr", cutpoints = c(0, 0.001, 0.01, 0.05, 1),
  symbols = c("***", "**", "*", "ns"))

#get max w/in each pheno, prop & dataset for placement
max_abs.errs <- prop.global_abs.diffs %>%
  group_by(pheno, prop, dataset) %>%
  summarize(max_err = max(abs.diff)) %>%
  ungroup() %>%
  pivot_wider(id_cols=c(pheno, prop), names_from=dataset, values_from=max_err, names_prefix="max_")
  
stats_centile_for_plot <- full_join(mean_comp_tbl2, max_abs.errs)

#kinda hacky way of fixing positions
stats_centile_for_plot.corrected <- stats_centile_for_plot %>%
  mutate(xmax=case_when(group1=="cf.gamlss" | group2== "cf.gamlss" ~ (x+.266667),
                        TRUE ~  x),
         xmin=case_when(group2=="cf.lm" ~ (x-.266667),
                        TRUE ~  x),
         y.position=case_when(comp == "cf.lm_cf.gamlss" ~ max_cf.lm + 1,
                              comp == "cf.lm_cf.gam" ~ max_cf.lm + .5,
                              TRUE ~ max_cf.gam + 0.4))

stats_centile_for_plot.corrected %>%
  dplyr::select(prop, comp, pheno, sig_fdr, p.val_fdr.signif) %>%
  dplyr::filter(sig_fdr == FALSE)
```


```{r}
prop.global_cent_errs_plot <- prop.global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV", "GMV", "sGMV", "Ventricles"), ordered = TRUE)) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Absolute Centile Error", x = "% Females in Imbalanced Site") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom") +
  scale_x_discrete(labels=percent_f) +
  stat_pvalue_manual(stats_centile_for_plot.corrected, label = "p.val_fdr.signif", label.size = 2, tip.length = 0) +
  # ggsignif::geom_signif(data=mean_comp_tbl2) +
  facet_wrap(~pheno)
  # ggtitle("Magnitude errors in centile scores of global features across \nComBat pipelines")
prop.global_cent_errs_plot
#ggsave("figs/global_centile_errors.jpeg", global_cent_errs_plot)
```

Visualize by sex

```{r}
prop.global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV", "GMV", "sGMV", "Ventricles"), ordered = TRUE)) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Absolute Centile Error", x = "% Females in Imbalanced Site") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom") +
  scale_x_discrete(labels=percent_f) +
  facet_grid(sex ~ pheno)
```

### Sex-Biases

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
cent.feat.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_cent_sex_bias_tests.RDS"))

cent.feat.sex.test.df <- bind_rows(cent.feat.sex.test.list) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      sig_uncor = ifelse(p.value<0.05, TRUE, FALSE)) %>%
  mutate(significant = case_when(sig_fdr == TRUE ~ "Survives FDR Correction",
                                 sig_uncor == TRUE & sig_fdr == FALSE ~ "Uncorrected Only",
                                 sig_uncor == FALSE & sig_fdr == FALSE ~ "Not Significant")) %>%
  mutate(significant = factor(significant, ordered=TRUE, levels=c("Survives FDR Correction", "Uncorrected Only", "Not Significant")))
```

simple bar-plot to count regions w significant sex-differences in errors

```{r}
cent.feat.sex.test.df %>%
  ggplot() +
  geom_bar(aes(x=prop, fill=significant)) +
  facet_wrap(~dataset) +
  scale_x_discrete(labels=percent_f) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

sig.sex_diff.violin <- cent.feat.sex.test.df %>%
  dplyr::filter(sig_uncor == TRUE) %>%
  mutate(median_sex_diff = median_sex_diff*100) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=median_sex_diff, fill=dataset, color=dataset)) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  scale_fill_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)

ggsave("figs/sig.sex_diff.violin.jpeg", sig.sex_diff.violin, width=7, height=5, units="in")
```

visualize actual (not ABSOLUTE) errors for global phenos by sex

add significance testing

```{r}
#wilcox test for visualizing significance
cent.sex_comp_tbl_calc <- ratio.df %>%
  dplyr::select(participant, sex, prop, dataset, paste0("diff_", vol_list_global)) %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  pivot_longer(cols=starts_with("diff_"), names_to="pheno", names_prefix="diff_", values_to = "diff") %>%
  group_by(dataset, pheno, prop) %>%
  wilcox_test(diff ~ sex) 
```

```{r}
cent.sex_comp_tbl <- cent.sex_comp_tbl_calc %>%
  arrange(prop) %>%
  add_xy_position(x="prop", fun="max") %>%
  add_significance("p")

#get max w/in each pheno, prop & dataset for placement
max_errs <- ratio.df %>%
  dplyr::select(participant, sex, prop, dataset, paste0("diff_", vol_list_global)) %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  pivot_longer(cols=starts_with("diff_"), names_to="pheno", names_prefix="diff_", values_to = "diff") %>%
  group_by(pheno, prop, dataset) %>%
  summarize(max_diff = max(diff)) %>%
  ungroup() %>%
  pivot_wider(id_cols=c(pheno, prop), names_from=dataset, values_from=max_diff, names_prefix="max_")
  
cent.sex_comp_tbl2 <- full_join(cent.sex_comp_tbl, max_errs)

#just use significance from actual stats tests
cent.feat.test_global <- cent.feat.sex.test.df %>%
  dplyr::filter(pheno_cat == "Global Volume" & (dataset == "cf.gam" | dataset =="cf.gamlss"))

stats_sex.centile_for_plot <- inner_join(cent.sex_comp_tbl2, cent.feat.test_global)
table(stats_sex.centile_for_plot$significant)

#kinda hacky way of fixing positions
stats_sex.centile_for_plot.corrected <- stats_sex.centile_for_plot %>%
  mutate(p.signif = ifelse(sig_uncor == "FALSE", "ns", "*"),
         y.position=case_when(dataset=="cf.gam" ~ max_cf.gam*100+0.5,
                           dataset=="cf.gamlss" ~ max_cf.gamlss*100+0.5,
                           TRUE ~ NA))

sex_err_ratio.plt <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("diff_", vol_list_global)) %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  pivot_longer(cols=starts_with("diff_"), names_to="pheno", names_prefix="diff_", values_to = "diff") %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("GMV", "sGMV", "Ventricles", "WMV"), ordered = TRUE),
         diff = diff*100,
         pheno_prop = paste(pheno, prop, sep="&")) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=prop, y=diff, fill=sex, color=sex)) +
  theme_linedraw(base_size = 11) +
  labs(y="Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f) +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position = "bottom") +
  labs(fill="Sex", color="Sex")+
  stat_pvalue_manual(stats_sex.centile_for_plot.corrected, label = "p.signif", label.size = 2, tip.length = 0) +
  facet_grid(dataset ~ pheno, labeller=labeller(dataset=dataset_names), scales="free_x")
sex_err_ratio.plt
```

```{r}
t.test.cent.sex.diff <- cent.feat.sex.test.df %>%
  #dplyr::filter(sig_fdr == TRUE) %>%
  group_by(dataset, prop) %>%
  summarise(w.test.p = tidy(wilcox.test(median_sex_diff, mu=0))$p.value,
            max_val = max(median_sex_diff)*100) %>% #test median of each distribution against 0, then scale to centiles
  mutate(p.val_fdr = p.adjust(w.test.p, method="fdr", n = (11)),
         y_pos = max_val + 0.25) %>%
  add_significance("p.val_fdr", cutpoints = c(0, 0.001, 0.01, 0.05, 1),
  symbols = c("***", "**", "*", "ns")) %>%
  add_significance("w.test.p", cutpoints = c(0, 0.001, 0.01, 0.05, 1),
  symbols = c("***", "**", "*", "ns"))

cortical_cent_sex_diff.plt <- cent.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "cf") %>%
  mutate(median_sex_diff = median_sex_diff*100) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
    facet_wrap(~dataset, labeller=labeller(dataset=dataset_names)) + 
  geom_text(aes(label = p.val_fdr.signif, y = y_pos),
              data = t.test.cent.sex.diff[which(t.test.cent.sex.diff$dataset != "cf"),]) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)

cortical_cent_sex_diff.plt

#w/ fdr correction
cent.feat.sex.test.df %>%
  #dplyr::filter(sig_uncor == TRUE) %>%
  mutate(median_sex_diff = median_sex_diff*100) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
  geom_jitter(size=0.4, alpha=0.1) +
  facet_wrap(~dataset, labeller=labeller(dataset=dataset_names)) + 
  geom_text(aes(label = p.val_fdr.signif, y = y_pos),
              data = t.test.cent.sex.diff) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)

cent_sex_diff.plt2 <- cent.feat.sex.test.df %>%
  #dplyr::filter(sig_uncor == TRUE) %>%
  mutate(median_sex_diff = median_sex_diff*100) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
  geom_jitter(size=0.4, alpha=0.1) +
  facet_wrap(~dataset, labeller=labeller(dataset=dataset_names), scales="free_y") + 
  geom_text(aes(label = w.test.p.signif, y = y_pos),
              data = t.test.cent.sex.diff) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
cent_sex_diff.plt2

ggsave("figs/cent_sex_diff.plt2.jpeg", cent_sex_diff.plt2)
sfig13 <- ggarrange(sex_err_ratio.plt, cent_sex_diff.plt2,
          nrow=2,
          heights = c(.7, 1),
          labels = "AUTO")
ggsave("figs/sfig13.jpeg", sfig13, height=9, width=7)
```

### W/o extremes
Are extreme centiles (<5% and >95%) driving observed results?

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.cent.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_t_tests_all_out.RDS"))
noext.cent.t.test.df <- bind_rows(noext.cent.feat.t.test, .id="prop") %>%
  mutate(prop = factor(prop, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         comp = as.factor(comp),
         pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))
noext.cent.t.test.df
```

compare results
```{r}
noext.cent.t.test.df2 <- noext.cent.t.test.df %>%
  mutate(full_df = "reduced")
cent.t.test.df2 <- cent.t.test.df %>%
  mutate(full_df = "full")

comp.df <- full_join(noext.cent.t.test.df2, cent.t.test.df2)
comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```

Test sex-differences in centile errors w/in each feature
```{r}
noext_cent.subj.sex.test.list <- readRDS(paste0(data_path, "/no.ext_featurewise_cent_sex_bias_tests.RDS"))
noext_cent.feat.sex.test.df <- bind_rows(noext_cent.subj.sex.test.list) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      sig_uncor = ifelse(p.value<0.05, TRUE, FALSE)) %>%
  mutate(significant = case_when(sig_fdr == TRUE ~ "Survives FDR Correction",
                                 sig_uncor == TRUE & sig_fdr == FALSE ~ "Uncorrected Only",
                                 sig_uncor == FALSE & sig_fdr == FALSE ~ "Not Significant")) %>%
  mutate(significant = factor(significant, ordered=TRUE, levels=c("Survives FDR Correction", "Uncorrected Only", "Not Significant")))
```

simple bar-plot to count regions w significant sex-differences

```{r}
noext_cent.feat.sex.test.df %>%
  ggplot() +
  geom_bar(aes(x=prop, fill=significant)) +
  facet_wrap(~dataset) +
  scale_x_discrete(labels=percent_f) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

visualize magnitude of sex-biases (directional magnitude of errors within pheno cat)

```{r}
noext_cent.feat.sex.test.df <- noext_cent.feat.sex.test.df %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)))

noext_cent.feat.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_uncor == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  ggplot() +
  geom_histogram(aes(x=median_sex_diff, fill= pheno_cat, color=pheno_cat), alpha=0.4, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(prop~dataset, scales="free")

noext_t.test.cent.sex.diff <- noext_cent.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat, prop) %>%
  summarise(t.test.p = tidy(t.test(median_sex_diff, mu=0))$p.value,
            max_val = max(median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = (3*4*11)), #not testing global vols, too few data points
                  sig_fdr_tf = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE),
         sig_uncor = case_when(t.test.p < 0.05 ~ "*",
                               t.test.p >= 0.05 ~ ""),
         y_pos = ifelse(max_val < 0, ((max_val*100)*0.5), (max_val*100)+0.8))

noext_cent.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "cf") %>%
  mutate(median_sex_diff = median_sex_diff*100) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
    facet_grid(dataset~pheno_cat, labeller=labeller(dataset=dataset_names)) + 
  geom_text(aes(label = sig_uncor, y = y_pos),
              data = noext_t.test.cent.sex.diff[which(noext_t.test.cent.sex.diff$dataset != "cf"),]) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Centile Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)

#compare with full dataset
cortical_cent_sex_diff.plt
```

similar overall pattern

## Z-SCORES

Do z score errors change based on combat version?

compare abs(z errors) w/in features - Tested by `ratio_results.R`, results written to `full_featurewise_z_t_tests.csv`

```{r}
z.feat.t.test <- readRDS(paste0(data_path, "/full_featurewise_z_t_tests_all_out.RDS"))

z.feat.t.test.df <- bind_rows(z.feat.t.test, .id="prop") %>%
  mutate(pheno = sub(".z", "", pheno)) %>%
  mutate(prop = factor(prop, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
                pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_))) %>%
      separate_wider_delim(cols=comp, delim="_", names=c("group1", "group2"), cols_remove=FALSE) %>%
  mutate(smaller_group=ifelse(bigger_group==group1, group2, group1))

z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

```{r}
z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~comp)

z.feat.t.test.plt <- z.feat.t.test.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=smaller_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(pheno_cat ~ comp, labeller = labeller(comp = as_labeller(comp_names)), scales="free_y") +
  theme_linedraw() +
  scale_fill_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "Better ComBat \nConfiguration", labels=dataset_names) +
  theme(legend.position = "bottom", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Feature Count", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
ggsave("figs/ratio_z.t.test.plt.jpg", z.feat.t.test.plt, width=13, height=8, units="in")
```

Plot errors for global phenotypes

add significance testing
```{r}
z.t.test.list <- readRDS(paste0(data_path, "/full_featurewise_z_t_tests_all_out.RDS"))

z.t.test.list_global <- lapply(z.t.test.list, function(x) filter(x, pheno %in% paste0(vol_list_global, ".z")))
z.t.test_global <- bind_rows(z.t.test.list_global, .id = "prop") %>%
  dplyr::mutate(prop = case_when(prop == "0M:10F" ~ "prop-01", 
                                 prop == "1M:9F" ~ "prop-02", 
                                 prop == "2M:8F" ~ "prop-03", 
                                 prop == "3M:7F" ~ "prop-04", 
                                 prop == "4M:6F" ~ "prop-05", 
                                 prop == "5M:5F" ~ "prop-06", 
                                 prop == "6M:4F" ~ "prop-07", 
                                 prop == "7M:3F" ~ "prop-08", 
                                 prop == "8M:2F" ~ "prop-09", 
                                 prop == "9M:1F" ~ "prop-10", 
                                 prop == "10M:0F" ~ "prop-11",
                                 TRUE ~ NA_character_))

z.t.test.df_global_filt <- z.t.test_global %>%
  dplyr::filter(comp %in% c("cf.gamlss_cf.gam", "cf.lm_cf.gam", "cf.lm_cf.gamlss")) %>%
  dplyr::mutate(comp = factor(comp, ordered=TRUE, levels=c("cf.lm_cf.gam", "cf.lm_cf.gamlss", "cf.gamlss_cf.gam")))
```

```{r}
z.prop.global_abs.diffs <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("abs.diff_", vol_list_global, ".z")) %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff") %>%
  arrange(pheno, prop) %>%
  as.data.frame()

#wilcox test for visualizing significance
z.mean_comp_tbl_calc <- z.prop.global_abs.diffs %>%
  group_by(pheno, prop) %>%
  pairwise_wilcox_test(abs.diff ~ dataset, comparisons=list(c("cf.lm", "cf.gam"), c("cf.gam", "cf.gamlss"), c("cf.lm", "cf.gamlss")),
                       p.adjust.method = "fdr") 
```

```{r}
z.mean_comp_tbl <- z.mean_comp_tbl_calc %>%
  mutate(comp = factor(paste(group2, group1, sep="_"), ordered=TRUE, levels=c("cf.lm_cf.gam", "cf.lm_cf.gamlss", "cf.gamlss_cf.gam"))) %>%
  arrange(prop, comp) %>%
  add_xy_position(x="prop", fun="max", comparisons=list(c("cf.lm", "cf.gam"), c("cf.gam", "cf.gamlss"), c("cf.lm", "cf.gamlss"))) %>%
  add_significance("p.adj")


#get max w/in each pheno, prop & dataset for placement
z.max_abs.errs <- z.prop.global_abs.diffs %>%
  group_by(pheno, prop, dataset) %>%
  summarize(max_err = max(abs.diff)) %>%
  ungroup() %>%
  pivot_wider(id_cols=c(pheno, prop), names_from=dataset, values_from=max_err, names_prefix="max_")
  
z.mean_comp_tbl2 <- full_join(z.mean_comp_tbl, z.max_abs.errs)

#just use significance from actual stats tests

stats_z_for_plot <- inner_join(z.mean_comp_tbl2, z.t.test.df_global_filt)
#kinda hacky way of fixing positions
stats_z_for_plot.corrected <- stats_z_for_plot %>%
  mutate(p.adj.signif = ifelse(sig_fdr == "FALSE", "ns", "*"),
         xmax=case_when(group1=="cf.gamlss" | group2== "cf.gamlss" ~ (x+.266667),
                        TRUE ~  x),
         xmin=case_when(group2=="cf.lm" ~ (x-.266667),
                        TRUE ~  x),
         y.position=case_when(comp == "cf.lm_cf.gamlss" ~ max_cf.lm + .16,
                              comp == "cf.lm_cf.gam" ~ max_cf.lm + .1,
                              TRUE ~ max_cf.gam + 0.05))

z.t.test.df_global_filt %>%
  dplyr::select(prop, comp, pheno, sig_fdr) %>%
  dplyr::filter(sig_fdr == FALSE)
```


```{r}
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio.df$prop))

z.prop.global_abs.diffs <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("abs.diff_", vol_list_global, ".z")) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff")

prop.global_z_errs_plot <- z.prop.global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV.z", "GMV.z", "sGMV.z", "Ventricles.z"), ordered = TRUE)) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Magnitude Z Error", x = "% Females in Imbalanced Study Site") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  stat_pvalue_manual(stats_z_for_plot.corrected, label = "p.adj.signif", label.size = 2, tip.length = 0) +
  scale_x_discrete(labels=percent_f) +
  facet_wrap(~pheno) +
  ggtitle("Magnitude errors in z scores of global features across ComBat pipelines")
prop.global_z_errs_plot
ggsave("figs/global_z_errors.jpeg", prop.global_z_errs_plot)
```


### Sex-Biases

Test w/in feature sex-differences in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`

```{r}
z.sex.test.list <- readRDS(paste0(data_path, "/full_featurewise_z_sex_bias_tests.RDS"))
z.feat.sex.test.df <- bind_rows(z.sex.test.list) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      sig_uncor = ifelse(p.value<0.05, TRUE, FALSE)) %>%
  mutate(significant = case_when(sig_fdr == TRUE ~ "Survives FDR Correction",
                                 sig_uncor == TRUE & sig_fdr == FALSE ~ "Uncorrected Only",
                                 sig_uncor == FALSE & sig_fdr == FALSE ~ "Not Significant")) %>%
  mutate(significant = factor(significant, ordered=TRUE, levels=c("Survives FDR Correction", "Uncorrected Only", "Not Significant")))
```

simple bar-plot to count regions w significant sex-differences

```{r}
z.feat.sex.test.df %>%
  ggplot() +
  geom_bar(aes(x=prop, fill=significant)) +
  facet_wrap(~dataset) +
  scale_x_discrete(labels=percent_f) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

z.sig.sex_diff.violin <- z.feat.sex.test.df %>%
  dplyr::filter(sig_uncor == TRUE) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=median_sex_diff, fill=dataset, color=dataset)) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  scale_fill_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Z-Score Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)

ggsave("figs/sig.sex_diff.violin.z.jpeg", z.sig.sex_diff.violin, width=7, height=5, units="in")
```

visualize magnitude of sex-biases (directional magnitude of errors within pheno cat)

```{r}
z.feat.sex.test.df <- z.feat.sex.test.df %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)))

z.feat.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_uncor == FALSE ~ NA,
                              TRUE ~ median_sex_diff)) %>%
  ggplot() +
  geom_histogram(aes(x=median_sex_diff, fill= pheno_cat, color=pheno_cat), alpha=0.4, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(prop~dataset, scales="free")

z.feat.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff)) %>%
  ggplot() +
  geom_histogram(aes(x=median_sex_diff, fill= pheno_cat, color=pheno_cat), alpha=0.4, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(prop~dataset, scales="free")

t.test.z.sex.diff <- z.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat, prop) %>%
  summarise(t.test.p = tidy(t.test(median_sex_diff, mu=0))$p.value,
            max_val = max(median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = (3*4*11)), #not testing global vols, too few data points
                  # sig_fdr_tf = case_when(p.val_fdr < 0.05 ~ TRUE,
                  #                     p.val_fdr >= 0.05 ~ FALSE),
         sig_uncor = case_when(p.val_fdr < 0.05 ~ "*",
                            p.val_fdr >= 0.05 ~ ""),
         y_pos = max_val+0.005)

z.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "cf") %>%
  mutate(median_sex_diff = median_sex_diff) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
    facet_grid(dataset~pheno_cat, labeller=labeller(dataset=dataset_names)) + 
  geom_text(aes(label = sig_uncor, y = y_pos),
              data = t.test.z.sex.diff[which(t.test.z.sex.diff$dataset != "cf"),]) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Z Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
```

```{r}
z.t.test.cent.sex.diff <- z.feat.sex.test.df %>%
  dplyr::filter(sig_uncor == TRUE) %>%
  group_by(dataset, prop) %>%
  summarise(w.test.p = tidy(wilcox.test(median_sex_diff, mu=0))$p.value,
            max_val = max(median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(w.test.p, method="fdr", n = (11)), 
         y_pos = max_val*1.3) %>%
  add_significance("w.test.p", cutpoints = c(0, 0.001, 0.01, 0.05, 1),
  symbols = c("***", "**", "*", "ns"))

z.cent_sex_diff.plt <- z.feat.sex.test.df %>%
  dplyr::filter(sig_uncor == TRUE) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
  geom_jitter(size=0.4, alpha=0.1) +
  facet_wrap(~dataset, labeller=labeller(dataset=dataset_names), scales="free_y") + 
  geom_text(aes(label = w.test.p.signif, y = y_pos),
              data = z.t.test.cent.sex.diff) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Z-Score Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
z.cent_sex_diff.plt

ggsave("figs/z_sex_diff.plt.jpeg", z.cent_sex_diff.plt)
```


### W/o extremes

Are extreme z-scores (<2 and >2) driving observed results?

Test differences in abs. magnitude of z errors w/in each feature

```{r}
noext.z.feat.t.test <- readRDS(paste0(data_path, "/no.ext_featurewise_z_t_tests_all_out.RDS"))
noext.z.feat.t.test.df <- bind_rows(noext.z.feat.t.test, .id="prop") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

noext.z.feat.t.test.df %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig=sum(sig_fdr))
```

compare results
```{r}
noext.z.t.test.df2 <- noext.z.feat.t.test.df %>%
  mutate(full_df = "reduced")
z.feat.t.test.df2 <- z.feat.t.test.df %>%
  mutate(full_df = "full")

z.comp.df <- full_join(noext.z.t.test.df2, z.feat.t.test.df2)
z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=prop, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(comp ~ full_df)

z.comp.df %>%
  dplyr::filter(sig_fdr==TRUE) %>%
ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap( ~ full_df)
```


Test sex-diffs in z errors w/in each feature

```{r}
noext_z.feat.sex.test.list <- readRDS(paste0(data_path, "/no.ext_featurewise_z_sex_bias_tests.RDS"))
noext_z.feat.sex.test.df <- bind_rows(noext_z.feat.sex.test.list) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      sig_uncor = ifelse(p.value<0.05, TRUE, FALSE)) %>%
  mutate(significant = case_when(sig_fdr == TRUE ~ "Survives FDR Correction",
                                 sig_uncor == TRUE & sig_fdr == FALSE ~ "Uncorrected Only",
                                 sig_uncor == FALSE & sig_fdr == FALSE ~ "Not Significant")) %>%
  mutate(significant = factor(significant, ordered=TRUE, levels=c("Survives FDR Correction", "Uncorrected Only", "Not Significant")))
```

simple bar-plot to count regions w sigificant sex-biases

```{r}
noext_z.feat.sex.test.df %>%
  ggplot() +
  geom_bar(aes(x=prop, fill=significant)) +
  facet_wrap(~dataset) +
  scale_x_discrete(labels=percent_f) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

visualize magnitude of sex-biases (directional magnitude of errors within pheno cat)

```{r}
noext_z.feat.sex.test.df <- noext_z.feat.sex.test.df %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)))

noext_z.feat.sex.test.df %>%
  mutate(median_sex_diff = case_when(sig_uncor == FALSE ~ NA,
                              TRUE ~ median_sex_diff)) %>%
  ggplot() +
  geom_histogram(aes(x=median_sex_diff, fill= pheno_cat, color=pheno_cat), alpha=0.4, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(prop~dataset, scales="free")

noext_t.test.z.sex.diff <- noext_z.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  group_by(dataset, pheno_cat, prop) %>%
  summarise(t.test.p = tidy(t.test(median_sex_diff, mu=0))$p.value,
            max_val = max(median_sex_diff)) %>% #test median of each distribution against 0
  mutate(p.val_fdr = p.adjust(t.test.p, method="fdr", n = (3*4*11)), #not testing global vols, too few data points
                  sig_fdr_tf = case_when(p.val_fdr < 0.05 ~ TRUE,
                                      p.val_fdr >= 0.05 ~ FALSE),
         sig_uncor = case_when(
           # p.val_fdr < 0.001 ~ "***",
           #                     p.val_fdr >= 0.001 & p.val_fdr < 0.01 ~ "**",
           #                     p.val_fdr >= 0.01 & 
                               t.test.p < 0.05 ~ "*",
                               t.test.p >= 0.05 ~ ""),
         y_pos = (max_val+0.01))

noext_z.feat.sex.test.df %>%
  dplyr::filter(pheno_cat != "Global Volume" & dataset != "cf") %>%
  mutate(median_sex_diff = median_sex_diff) %>%
  ggplot(aes(x=prop, y=median_sex_diff)) +
  geom_boxplot(aes(color=dataset)) +
    facet_grid(dataset~pheno_cat, labeller=labeller(dataset=dataset_names)) + 
  geom_text(aes(label = sig_uncor, y = y_pos),
              data = noext_t.test.z.sex.diff[which(noext_t.test.z.sex.diff$dataset != "cf"),]) +
  theme_linedraw() +
  scale_color_manual(values=c(cf= "#440D54", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) +
  theme(legend.position="none", plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y="Median Male - Female Z Error", x = "% Females in Imbalanced Site") +
  scale_x_discrete(labels=percent_f)
```


## FIGURE 4
```{r}
fig_4.alt <- ggarrange(ggarrange(sampling.plt, sex_err_ratio.plt, 
                             nrow = 2, labels = c("A", "C"),
                             heights=c(1,2)), #nest 1st col
          prop.global_cent_errs_plot,
          ncol = 2,
          widths=c(1, 1.3),
          labels = c(NA, "B")                                    
) 

fig_4 <- ggarrange(sampling.plt, prop.global_cent_errs_plot, 
                             nrow = 2, labels = c("A", "B"),
                             heights=c(1,3))

ggsave("figs/figure_4.jpeg", fig_4)
```

