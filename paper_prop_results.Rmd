---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

Rmd to show and get feedback on planned for results & figures for the combatLS paper. Currently thinking I'll have centile score results be the focus of the paper and keep z-scores for the supplement.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, ggh4x, purrr)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/stats_tests.R")
#aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
```

```{r}
der_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives"

#pheno lists
pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

#diff lists
pheno_diff_list <- paste0("diff_", pheno_list)
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)


#z lists
pheno_list.z <- paste0(pheno_list, ".z")
z.pheno_diff_list <- paste0(pheno_diff_list, ".z")
z.pheno_abs.diff.list <- paste0(pheno_abs.diff.list, ".z")

#years for plotting
ukb_cn_df <- ukb_cn_df %>%
  mutate(age_years = age_days/365.25)

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
```


```{r}
dataset_names <- c('ukb-CN-simsites' = "Raw Data", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
n_prop_list <- c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F")
```

## Load Data

pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/*_diffs.csv' .`

pulled within-subj summaries from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_ratios/perm_centile_csvs/subject-wise/*.csv' .`

Read in centile/z-score errors

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_ratio"), pattern = "_diffs.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  print(paste("reading file", file))
  # Read each CSV file
    data <- fread(file)
    
    data <- data %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list[[file]] <- as.data.frame(data)
    assign("ratio_list", df_list)
}
length(ratio_list)
ratio.df <- bind_rows(ratio_list)

# #sum(is.na(ratio.df))
# na.df <- ratio.df[rowSums(is.na(ratio.df)) > 0,]
# skimr::skim(na.df)
# 
# names(ratio.df)
```

Read in subject-wise summary stats

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_ratio"), pattern = "_subj_pred.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  # Read each CSV file
    data <- fread(file)

    data <- data %>%
      mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("ratio_subj_list", df_list)
}
length(ratio_subj_list)
ratio_subj.df <- bind_rows(ratio_subj_list)

max(ratio_subj.df$mean_centile)
min(ratio_subj.df$mean_centile)
max(ratio_subj.df$mean_z)
min(ratio_subj.df$mean_z)
```
some quick eda

```{r}
ratio.df %>%
  ggplot() +
  geom_violin(aes(y=diff_GMV, x= sex, fill=sim.site)) +
  facet_grid(dataset~prop, scales="free_y")

ratio.df %>%
  ggplot() +
  geom_violin(aes(y=abs.diff_GMV, x= sex, fill=sim.site)) +
  facet_grid(dataset~prop, scales="free_y")
```

Read in predicted centiles & z scores FROM RAW DATA ONLY (to save memory)
```{r, eval=FALSE}
pred.csvs <- list.files(path = paste0(data_path, "/ukb_ratio"), pattern = "raw_predictions.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = gsub("_data|_predictions.csv|prop-|[0-9]|-", "", Source_File),
           prop=gsub("-raw_predictions.csv", "", Source_File))
  
    # Bind the data to the combined dataframe
    df_list <- c(df_list, list(data))
    assign("ratio_raw_pred_list", df_list)
}
length(ratio_raw_pred_list)

#merge into single df
ratio_raw_pred.df <- bind_rows(ratio_raw_pred_list)
dim(ratio_raw_pred.df)
```

Visualize sex-distribution across sites/proportions

```{r, eval=FALSE}
ratio.df %>%
  dplyr::filter(dataset=="cf") %>%
ggplot() +
  geom_bar(aes(x=prop, fill=sex)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~ sim.site)
```

## CENTILES

Do centile score absolute errors change based on combat version? Tested by `ratio_results.R`, results written to `full_featurewise_cent_t_tests.csv`
*need to look and see what happens for subjects who aren't in all samples?*

```{r}
cent.t.test.df <- fread(paste0(data_path, "/ukb_ratio/full_featurewise_cent_t_tests.csv"))
cent.t.test.df <- cent.t.test.df %>%
  mutate(prop = factor(column_label, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         comp = as.factor(comp))
```

```{r}
cent.t.test.df %>%
  # filter(comp=="cf.gamlss_cf.gam") %>%
  ggplot() +
  geom_col(aes(x=prop, y=n_sig_regions, fill=comp), position="dodge") +
  facet_wrap(~comp) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position="none")
```

Plot errors for global phenotypes
```{r}
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio.df$prop))

prop.global_abs.diffs <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("abs.diff_", vol_list_global)) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff")

prop.global_cent_errs_plot <- prop.global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV", "GMV", "sGMV", "Ventricles"), ordered = TRUE),
         abs.diff = abs.diff*100) %>% #for visuals
  ggplot() +
  geom_violin(aes(x=prop, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Magnitude Centile Error", x = "% Females in Imbalanced Study Site") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_discrete(labels=percent_f) +
  facet_wrap(~ pheno) +
  ggtitle("Magnitude errors in centile scores of global features across ComBat pipelines")
prop.global_cent_errs_plot
#ggsave("figs/global_centile_errors.jpeg", global_cent_errs_plot)
```
*need to add stat tests to plot*

### Sex-Biases

Test subj. mean abs errors (mean_cent_abs.diff) using `ratio_subject-wise_results.R`, saved as `subj.abs.mean_sex_bias_cent_t_tests.csv`

```{r}
cent.subj.mean.test.df <- fread(paste0(data_path, "/ukb_ratio/subj.abs.mean_sex_bias_cent_t_tests.csv"))
cent.subj.mean.test.df <- cent.subj.mean.test.df %>%
  mutate(prop = factor(prop, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         dataset = as.factor(dataset))
cent.subj.mean.test.df
```

```{r}
cent.subj.mean.test.df %>%
  # filter(comp=="cf.gamlss_cf.gam") %>%
  ggplot() +
  geom_col(aes(x=prop, y=sig_fdr, fill=dataset), position="dodge") +
  facet_wrap(~dataset) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position="none")
```

Test w/in feature sex-biases in errors (diff_list) using `featurewise_sex_bias_test.R`, saved as `full_featurewise_cent_sex_bias_tests.RDS`
**RERUNNING TO KEEP PROP VALS AS EXPLICIT NAMES, COME BACK TO THIS**

```{r}
cent.subj.sex.test.list <- readRDS(paste0(data_path, "/ukb_ratio/full_featurewise_cent_sex_bias_tests.RDS"))
```

### W/o extremes
Are extreme centiles (<5% and >95%) driving observed results?

Test differences in abs. magnitude of centile errors w/in each feature

```{r}
noext.cent.t.test.df <- fread(paste0(data_path, "/ukb_ratio/no.ext_featurewise_cent_t_tests.csv"))
noext.cent.t.test.df <- noext.cent.t.test.df %>%
  mutate(prop = factor(column_label, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         comp = as.factor(comp))
noext.cent.t.test.df
```

compare results
```{r}
noext.cent.t.test.df_reduced <- noext.cent.t.test.df %>%
  mutate(full_df = 0) %>%
  dplyr::select(comp, prop, n_sig_regions, full_df)
cent.t.test.df_reduced <- cent.t.test.df %>%
  mutate(full_df = 1) %>%
  dplyr::select(comp, prop, n_sig_regions, full_df)

full_join(noext.cent.t.test.df_reduced, cent.t.test.df_reduced) %>%
  ggplot() +
  geom_col(aes(x=prop, y=n_sig_regions, fill=as.factor(full_df)), position="dodge") +
  facet_wrap(~comp) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
Test sex-biases in centile errors w/in each feature
**COME BACK TO THIS**

## Z-SCORES

Do z score errors change based on combat version?

compare abs(z errors) w/in features - Tested by `ratio_results.R`, results written to `full_featurewise_z_t_tests.csv`

```{r}
z.t.test.df <- fread(paste0(data_path, "/ukb_ratio/full_featurewise_z_t_tests.csv"))
z.t.test.df <- z.t.test.df %>%
  mutate(prop = factor(column_label, levels=c("0M:10F", "1M:9F", "2M:8F", "3M:7F", "4M:6F", "5M:5F", "6M:4F", "7M:3F", "8M:2F", "9M:1F", "10M:0F"), ordered=TRUE),
         comp = as.factor(comp))
```

```{r}
z.t.test.df %>%
  # filter(comp=="cf.gamlss_cf.gam") %>%
  ggplot() +
  geom_col(aes(x=prop, y=n_sig_regions, fill=comp), position="dodge") +
  facet_wrap(~comp) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), legend.position="none")
```

Plot errors for global phenotypes
```{r}
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio.df$prop))

z.prop.global_abs.diffs <- ratio.df %>%
  dplyr::select(participant, sex, age_days, sim.site, prop, dataset, paste0("abs.diff_", vol_list_global, ".z")) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff")

prop.global_z_errs_plot <- z.prop.global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV", "GMV", "sGMV", "Ventricles"), ordered = TRUE)) %>%
  ggplot() +
  geom_violin(aes(x=prop, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Magnitude Z Error", x = "% Females in Imbalanced Study Site") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_discrete(labels=percent_f) +
  facet_wrap(~ pheno) +
  ggtitle("Magnitude errors in z scores of global features across ComBat pipelines")
prop.global_z_errs_plot
#ggsave("figs/global_z_errors.jpeg", prop.global_z_errs_plot)
```
*need to add stat tests to plot*

### Sex-Biases

Test subj. mean averages
```{r}
prop.sex.bias.test <- mclapply(ratio_subj_list, sex.bias.t.tests, mc.preschedule = FALSE, to_test = "mean_cent_abs.diff", comp_multiplier=11)
names(prop.sex.bias.test) <- n_prop_list
sex_bias_ratio_tests_df <- bind_rows(prop.sex.bias.test, .id = "prop")
```


```{r}
for (l in unique(ratio_subj.df$dataset)){
plot <- ratio_subj.df %>%
  dplyr::filter(dataset == l) %>%
  ggplot(aes(x=mean_centile, y=mean_cent_diff, color=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth(method="lm") +
  facet_grid(sim.site ~ prop) +
  ggtitle(l)
print(plot)
}
```

```{r}
ratio_subj.df %>%
  dplyr::filter(dataset == "cf.lm" |dataset == "cf.gam" | dataset=="cf.gamlss") %>%
  ggplot(aes(x=mean_centile*100, y=mean_cent_diff*100, color=sex)) +
  geom_point(alpha=0.2) +
  #geom_smooth(method="lm") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_nested(dataset + sim.site ~ prop) 

ratio_subj.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset=="cf.gamlss") %>%
  ggplot(aes(x=sim.site, y=mean_cent_diff*100)) +
  geom_violin() +
  #geom_smooth(method="lm") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_nested(dataset ~ prop)
```


```{r}
prop_sex_mean_cent.plot <- ratio_subj.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset=="cf.gamlss") %>%
  ggplot(aes(x=sim.site, y=mean_cent_diff*100, fill=sex)) +
  geom_violin() +
  #geom_smooth(method="lm") +
  theme_linedraw(base_size=12) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(dataset ~ prop, labeller = labeller(dataset = as_labeller(dataset_names), prop=as_labeller(percent_f))) +
  xlab("Site") + ylab("Mean Centile Error")
prop_sex_mean_cent.plot
```

```{r}
dataset_names <- c('ukb-CN-simsites' = "Raw Data", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
percent_f <- setNames(paste0(seq(from=100, to=0, by=-10), "% F"), unique(ratio_subj.df$prop))

prop_sex_mean_cent.plot2 <- ratio_subj.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset=="cf.gamlss") %>%
  ggplot(aes(x=sex, y=mean_cent_diff*100, fill=sex)) +
  geom_violin() +
  #geom_smooth(method="lm") +
  theme_linedraw(base_size=12) +
  theme(axis.text.x = element_blank()) +
  facet_grid(dataset ~ prop, labeller = labeller(dataset = as_labeller(dataset_names), prop=as_labeller(percent_f))) +
  xlab("Site") + ylab("Mean Centile Error")
prop_sex_mean_cent.plot2
```

```{r}
prop_sex_mean_cent.plot.abs <- ratio_subj.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset=="cf.gamlss") %>%
  ggplot(aes(x=sex, y=mean_cent_abs.diff*100, fill=sex)) +
  geom_violin() +
  #geom_smooth(method="lm") +
  theme_linedraw(base_size=12) +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), legend.position="bottom") +
  facet_grid(dataset ~ prop, labeller = labeller(dataset = as_labeller(dataset_names), prop=as_labeller(percent_f))) +
  ylab("Mean Absolute Centile Error")
prop_sex_mean_cent.plot.abs
saveRDS(prop_sex_mean_cent.plot.abs, file="figs/mean_subj_cent_err.RDS")
```

*need to add w/in feature sex-bias testing*

### W/o extremes
Are extreme centiles (<5% and >95%) driving observed results?

Get raw centiles and merge with centile differences

```{r}
ratio.no_ext_cent <- fread(file=paste0(data_path, "/ukb_ratio/no_ext_cent.csv"))
```

split back into separate dataframes for each proportion

```{r}
ratio.no_ext_cent_list <- c()
for (p in unique(ratio.no_ext_cent$prop)){
  df <- ratio.no_ext_cent %>%
    dplyr::filter(prop == p)
  ratio.no_ext_cent_list <- c(ratio.no_ext_cent_list, list(df))
}
rm(ratio.no_ext_cent)
length(ratio.no_ext_cent_list)
dim(ratio.no_ext_cent_list[[1]]) == dim(ratio.no_ext_cent_list[[9]]) #expect TRUE
sum(unique(ratio.no_ext_cent_list[[1]]$participant) == unique(ratio.no_ext_cent_list[[9]]$participant)) #expect low # matches
```

Test between-combat abs. centile diffs - probably faster if i just run this back on cubic

```{r}
noext.prop_abs.cent_t.tests <- mclapply(ratio.no_ext_cent_list, centile.t.tests, feature_list=pheno_abs.diff.list, comp_multiplier=11, mc.preschedule = FALSE) #FDR correction across 11 M:F permutations
names(noext.prop_abs.cent_t.tests) <- n_prop_list
noext.prop_abs.cent_t.tests_df <- bind_rows(noext.prop_abs.cent_t.tests, .id = "column_label")
noext.prop_abs.cent_t.tests_df
```

*need to add w/in feature sex-bias testing*

## Scale Effects of Sex

sex-diff in variance as function of M:F!

fix age, get diff between male and female pred. variance
```{r}
# combined_preds.p <- data.frame()
get.var <- function(x){
  df <- data.frame() #new empty dataframe
  var.csvs.p <- list.files(path = permutation_path, pattern = paste0(x, ".+_variance.csv"), full.names = TRUE)
  for (file in var.csvs.p) {
    # Read each CSV file
    data <- fread(file)

    # Add a "Source_File" column with the file name
    data <- data %>%
      mutate(Source_File = as.factor(basename(file)),
             perm = as.factor(x)) %>%
      mutate(dataset = gsub("_data|_variance.csv|perm-|[0-9]|-", "", Source_File),
             sex_standard = sex_effect/f.var,
             pheno = as.character(pheno))

    # Bind the data to the combined dataframe
    df <- bind_rows(df, data, .id = "File_ID")
  }
  return(df)
}

perm_var <- mclapply(n_perm_list, get.var, mc.preschedule = FALSE)
perm_var.all <- bind_rows(perm_var, .id = "column_label")
```

maybe better to get sex_summary.csv - just need signifigance

```{r}
#get summary df for p vals, plotting
sigma.sex.df <- fread("ukb_perm_csvs/sex_summary.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1) %>%
  mutate(perm = gsub("ukb-CN-data-agefilt-|-raw|-cf|.lm|.gam|.gamlss|-data", "", dataset),
         dataset = gsub("-data", "", dataset),
         dataset = gsub("simsites|ukb-CN-agefilt-|perm-|[0-9]", "", dataset),
         dataset = gsub("-", "", dataset),
         #dataset = as.character(dataset),
         pheno = as.character(pheno)) %>%
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE),
         perm = factor(perm, levels = unique(perm), ordered=FALSE)) %>%
  #mutate(dataset = relevel(dataset, ref= "raw")) %>%
  dplyr::filter(parameter == "sigma" & term == "sexMale") %>%
  dplyr::select(mod_name, pheno, dataset, pheno_cat, label, sig.sum_bf.corr, perm, sig.drop_bf.corr)

perm_var_info <- inner_join(perm_var.all, sigma.sex.df)
```

```{r}
  sex_effect_plot <- perm_var_info %>%
    mutate(sex_standard = case_when(sig.drop_bf.corr == TRUE ~ sex_standard,
                                    sig.drop_bf.corr == FALSE ~ 0)) %>% #only significant effects
    ggplot() +
    geom_col(aes(x=pheno, y=sex_standard, fill=dataset)) +
    facet_wrap(~perm, ncol=5) +
    ggtitle(paste("Standardized effect of male sex on variance")) +
    theme(axis.text.x = element_blank())
  
    ggsave(paste0("figs/male_variance_perms.jpeg"), sex_effect_plot)
    print(sex_effect_plot)
```


