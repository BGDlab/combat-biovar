---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

Rmd to show and get feedback on planned for results & figures for the combatLS paper. Currently thinking I'll have centile score results be the focus of the paper and keep z-scores for the supplement.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain)
#Sys.setenv("MC_CORES"=10L)
options("mc.cores")

source("./cubic_scripts/R_scripts/gamlss_helper_funs.R")
source("./cubic_scripts/R_scripts/ranked_welch_tests.R")
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
```

single script to parse outputs & get results (condensed from `ukb_sim.site_analyses.Rmd`)

```{r}
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives"

pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

pheno_list.z <- paste0(pheno_list, ".z")
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)
z.pheno_abs.diff.list <- paste0("abs.diff_", pheno_list, ".z")

#also load raw data
ukb_cn_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/ukb_CN_data_simsites.csv")

#plotting info from dk atlas
dk.parc <- dk$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
```


# Define Functions

Pairwise T tests: within each feature, run paired t tests (welch's test on ranks) pairwise on each possible pairing of combat configs and return as a single dataframe, with FDR correction for all feature + cf pair combos. Currently runs on magnitude (abs val) of centile diffs, but can be run on other metrics by redefining `feature_list` Recommended for use with mclapply across list of dataframes. Optional argument to correct for more comparisons (e.g. fdr-correct across an entire list of dataframes) using `comp_multiplier` arg.

```{r}
#define function
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)

centile.t.tests <- function(df, feature_list=pheno_abs.diff.list, comp_multiplier=1){
  #initialize empty dfs to store outputs
  t.df <- data.frame("pheno" = character(),
                     "group1" = character(),
                     "group2" = character(),
                     "p.value" = double())
  #run tests
  attach(df)
  for (pheno in feature_list) {
    df.pairwise.t <- tidy(pairwise.rank.welch.t.test(x=df[[pheno]], g=df[["dataset"]], paired = TRUE, p.adj = "none"))
    df.pairwise.t$pheno <- pheno
    t.df <- rbind(t.df, df.pairwise.t)
  }
  n_comp <- nrow(t.df)

  #apply fdr correction
  t.df <- t.df %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)),
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE),
           pheno = sub("abs.diff_", "", pheno)) %>%
    unite(comp, c("group1", "group2")) %>%
   dplyr::mutate(comp = as.factor(comp))

  t.df.sum <- t.df %>%
    group_by(comp) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
  return(t.df.sum)
  #detach()
}

### EXAMPLE:
# perm_t.tests <- mclapply(perm_diffs, centile.t.tests, mc.preschedule = FALSE)
# names(perm_t.tests) <- n_perm_list
# cent_t.tests.p <- bind_rows(perm_t.tests, .id = "column_label")
```

Within each combat config, test if there are significant differences in M and F subject's mean abs. centile error. Can test mean (not abs) centile errors, Z errors, etc, using `to_test` arg. FDR corrects for number of datasets tested

```{r}
sex.bias.t.tests <- function(df, to_test = "mean_cent_abs.diff", comp_multiplier=1){

  #conduct t test
  df.sex.t <- df %>%
    group_by(dataset) %>%
    summarise(p.value = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$p.value,
              sex_diff = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$estimate,
              t.stat = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$statistic,
              df = tidy(rank.welch.t.test.formula(formula=as.formula(paste(to_test, "~ sex")), paired = FALSE, p.adj = "none"))$parameter) %>%
    ungroup()

  #apply fdr correction
  n_comp=length(unique(df$dataset))
  df.sex.t <- df.sex.t %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)), #use comp_multiplier if using fun with lapply
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE))
  return(df.sex.t)
  #detach()
}

# tidy(rank.welch.t.test.formula(formula=mean_cent_abs.diff ~ sex, data= ratio_subj_list[[1]], paired = FALSE, p.adj = "none"))
# rank.welch.t.test.formula(formula=mean_cent_abs.diff ~ sex, data= ratio_subj_list[[1]], paired = FALSE, p.adj = "none")
```

modifying to test for sex-biases w/in feature rather than mean centiles

```{r}
pheno_diff_list <- paste0("diff_", pheno_list)
sex.bias.feat.t.tests <- function(df, feature_list=pheno_diff_list, comp_multiplier=1){
  
  #initialize empty df to store outputs
  t.df <- data.frame("dataset" = character(),
                     "pheno" = character(),
                     "p.value" = double(),
                     "sex_diff" = double(),
                     "t.stat" = double(),
                     "df" = double())
  attach(df)
  for (pheno in feature_list) {
  #print(paste("t-test:", pheno))

  #conduct t test
  df.sex.t <- df %>%
    group_by(dataset) %>%
    summarise(p.value = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$p.value,
              sex_diff = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$estimate,
              t.stat = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$statistic,
              df = tidy(rank.welch.t.test.formula(formula=as.formula(paste(pheno, "~ sex")), paired = FALSE, p.adj = "none"))$parameter) %>%
    ungroup()

  df.sex.t$pheno <- sub("diff_", "", pheno)

  #append to full df
  t.df <- rbind(t.df, df.sex.t)
  }
  detach(df)

  #also get medians for m and f
  med_df <- df %>%
  dplyr::group_by(dataset, sex) %>%
    summarise_at(feature_list, median) %>%
    ungroup() %>%
    pivot_longer(cols = starts_with("diff_"), names_to="pheno", names_prefix="diff_") %>%
    pivot_wider(names_from = sex, values_from=value, names_glue = "med_{sex}") %>%
    mutate(median_sex_diff = (med_Male - med_Female)) %>%
    ungroup()

  #combine feature dfs
  result_df <- left_join(t.df, med_df)  
  
  #apply fdr correction
  n_comp=length(unique(df$dataset))*length(feature_list)
  result_df <- result_df %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)), #use comp_multiplier if using fun with lapply
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE),
           dataset=as.factor(dataset))

  # #summarize
  # df.sex.t.sum <- df.sex.t %>%
  #   group_by(dataset) %>%
  #   dplyr::summarize(n_sig_regions = sum(sig_fdr),
  #             min_pval = min(p.val_fdr),
  #             max_pval = max(p.val_fdr)) %>%
  #   ungroup() %>%
  #   as.data.frame()
  
  return(result_df)

}
# sex.bias.feat.t.tests(diffs.df, feature_list = global.diff)
```


Test for linear relationships between subject's actual centile score (calculated from raw data) and how much that score is affected by different combat methods.

```{r}
extremeness.lm <- function(df, f, comp_multiplier=1){

  #conduct t test
  df.lm <- df %>%
    group_by(dataset) %>%
    #returns values for last (highest order) predictor
    summarise(p.value = tail(tidy(lm(as.formula(f)))$p.value, n=1),
              estimate = tail(tidy(lm(as.formula(f)))$estimate, n=1),
              t.stat = tail(tidy(lm(as.formula(f)))$statistic[2], n=1),
              std.error = tail(tidy(lm(as.formula(f)))$std.error[2]), n=1) %>%
    ungroup()
  n_comp=length(unique(df$dataset))

  #apply fdr correction
  df.lm <- df.lm %>%
    dplyr::mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = (n_comp*comp_multiplier)),
           sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                               p.val_fdr >= 0.05 ~ FALSE))
  return(df.lm)
  #detach()
}

# tidy(lm(mean_centile ~ mean_cent_diff, data= ratio_subj_list[[1]]))
# summary(lm(mean_centile ~ mean_cent_diff, data= ratio_subj_list[[1]]))
```

plot w/in feature average centile errors

```{r}
#define plotting
plot.cent.diffs <- function(df){
mean.diffs.long <- df %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  dplyr::summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  dplyr::select(-ends_with(".z")) %>% #drop z-score cols
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))

cent.diffs.plot <- mean.diffs.long %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y= "Percent Features", x = "Mean Absolute Centile Error") +
  ggtitle("Absolute errors in centile scores across ComBat processing pipelines")

print(cent.diffs.plot)
}
```


# Main Analyses

## Load Data

pulled variance from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_variance.csv' .`

Get predicted centiles
- pulled from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_predictions.csv' .`

```{r}
pred.csvs <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_predictions.csv", full.names = TRUE)
combined_preds <- data.frame()

for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = sub("_data_predictions.csv", "", Source_File))
  
  # Bind the data to the combined dataframe
  combined_preds <- bind_rows(combined_preds, data)
}
```

**qc - find ppts with centiles at 1 or 0**

```{r}
combined_preds %>% 
  filter_at(vars(pheno_list), any_vars(. %in% c(1, 0))) %>%
  dplyr::select(participant) %>%
  unique()

combined_preds %>% 
  filter_at(vars(pheno_list.z), any_vars(. %in% c(NA, Inf, -Inf))) %>%
  dplyr::select(participant) %>%
  unique()

# test.df <- combined_preds %>% 
#   dplyr::select(pheno_list)
# 
# test.df[test.df==1] <- 0
# 
# format(round(max(do.call(pmax, test.df)), 20), nsmall = 20)
```

saving out csv forces some centile scores to round up to 1, BUT it appears z scores are still being calculated correctly so just going to proceed!

Get errors
- pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_diffs.csv' .`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_diffs.csv", full.names = TRUE) %>% unlist()

diffs.df <- fread(file = raw_files, sep=",") %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))
```

Get subject-wise summaries
- pulled from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/subject-wise/*.csv' .`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_subj_pred.csv", full.names = TRUE) %>% unlist()

subj_sum.df <- fread(file = raw_files, sep=",") %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))
```

Get differences in male vs female predicted variances at mean sample age

```{r}
pred.csvs <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_variance.csv", full.names = TRUE)
combined_var <- data.frame()

for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = sub("_data_variance.csv", "", Source_File),
           sex_standard = sex_effect/f.var)
  
  # Bind the data to the combined dataframe
  combined_var <- bind_rows(combined_var, data, .id = "File_ID")
}

#get summary df for p vals, plotting
sigma.sex.df <- fread("ukb_basic/gamlss_summary.csv", stringsAsFactors = TRUE) %>%
  dplyr::select(-V1) %>%
  mutate(dataset = gsub("-data", "", dataset),
         dataset = gsub("-", "_", dataset),
         dataset = gsub("_simsites", "", dataset)) %>% #clean up dataset naming
  mutate(dataset = factor(dataset, levels = unique(dataset), ordered = FALSE)) %>%
  mutate(dataset = relevel(dataset, ref= "ukb_CN")) %>%
  dplyr::filter(parameter == "sigma" & term == "sexMale") %>%
  dplyr::select(mod_name, pheno, dataset, pheno_cat, label, sig.sum_bf.corr)

sigma.sex.df <- left_join(sigma.sex.df, dk.parc, by="label")

plot.info <- sigma.sex.df %>%
  dplyr::select(mod_name, pheno, dataset, pheno_cat, label, hemi, region, sig.sum_bf.corr) %>%
  unique() %>%
  mutate(dataset = gsub("-", "_", dataset),
         dataset = gsub("_simsites", "", dataset))

combined_var <- inner_join(combined_var, plot.info)
```

## SCALE EFFECTS OF SEX

```{r}
#var plot
var.plot.df <- combined_var %>%
  dplyr::filter(sig.sum_bf.corr == TRUE & pheno_cat != "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset, pheno_cat)

tp <- unique(var.plot.df[,c('dataset','pheno_cat')]) %>%
  dplyr::filter(dataset=="ukb_CN")
tp$sex_standard <- 1

var.plot <- ggplot(var.plot.df) +
  geom_rect(data = tp, fill="gray", xmin = -Inf,xmax = Inf,
            ymin = -Inf, ymax = Inf, alpha = 0.4) +
  ggseg::geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = sex_standard)) +
  #scale_fill_gradient2() +
  facet_grid(dataset ~ pheno_cat, labeller = labeller(dataset = as_labeller(dataset_names))) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=2/3, plot.margin = margin(1,1,1,1, 'pt')) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", name = "Sex Effect", limits = c(-0.12, 0.12), breaks = c(-0.1, 0,0.1))
#var.plot

#ggsave("figs/male_variance_ohbm.jpeg", var.plot, width=10, height=10)
```

```{r}
#plot global
var.plot.global.df <- combined_var %>%
  dplyr::filter(pheno_cat == "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  dplyr::select(!c(label, region, hemi)) %>% #drop cols corresponding to dk regions
  mutate(tissue_class = as.factor(case_when(pheno == "GMV" ~ "cGM",
                                            pheno == "Ventricles" ~ "CSF",
                                            pheno == "WMV" ~ "WM",
                                            pheno == "sGMV" ~ "sGM",
                                            TRUE ~ NA)),
         sex_standard = ifelse(sig.sum_bf.corr == TRUE, sex_standard, NA)) %>% #drop NS values
  group_by(dataset)

tp <- unique(var.plot.global.df[,c('dataset','pheno_cat')]) %>%
  dplyr::filter(dataset=="ukb_CN")
tp$sex_standard <- 1

var.plot.global <- ggplot(var.plot.global.df) +
  geom_rect(data = tp, fill="gray", xmin = -Inf,xmax = Inf,
            ymin = -Inf, ymax = Inf, alpha = 0.4) +
  ggseg::geom_brain(atlas = aseg_cerebrum, 
             aes(fill = sex_standard),
             side = c("coronal")) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", name = "Sex Effect", limits = c(-0.12, 0.12), breaks = c(-0.1, 0,0.1))
#var.plot.global
```

Combine plots
```{r}
p <- ggarrange(
  var.plot.global, var.plot,
  ncol=2, nrow=1, 
  widths = c(1, 3.1),
  #labels=c("A", "B"),
  #hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

p_annotate <- annotate_figure(p, top = text_grob("Figure 1B. Standardized effect of male sex on feature variance", 
               color = "black", size = 14, hjust=.65))
p_annotate
ggsave("figs/male_variance_ohbm_big.jpeg", p_annotate, width=7, height=8)
```


## CENTILES

Do centile scores change based on combat version?
Foregoing anova based on emails with andrew (anova violates assumtptions of no equal variance but there's no option for kruskall-wallace with paired samples - which these are, since it's the same subjects)

Within each phenotype, iterate paired t test of ranks between each combo of combat dfs (nonparametric per discussion with Andrew). (see Zimmerman & Zumbo, 1993). Using custom functions from `ranked_welch_tests.R`.

```{r}
centile.t.tests(diffs.df)
```

Little plot
```{r, eval=FALSE}
#get means w/in feature 
mean.diffs.long <- diffs.df %>%
  dplyr::select(sex, dataset, pheno, pheno_abs.diff.list) %>%
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))

dataset_names <- c(ukb_CN = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
dataset_colors <- c(cf = "#3D5983FF", cf.lm = "#5A8A54FF", cf.gam ="#262626FF", cf.gamlss ="#CFB023FF")

cent.diffs.plot <- mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Percent Features", x = "Mean Absolute Centile Error") +
  ggtitle("Absolute errors in centile scores of brain structure features across ComBat processing pipelines")
cent.diffs.plot

ggsave("figs/win_feature_mean_cent_abs.diffs.jpeg", cent.diffs.plot)
```

### Sex-Biases

Playing with different ways to visualize each subject's average centile error (i.e., raw data centile - combatted data centile) and magnitude centile error (absolute value)

```{r}
subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_boxplot(aes(x=sex, y=mean_cent_abs.diff, fill=sex)) +
  labs(y= "Magnitude Centile Error", x = "ComBat Configurations") +
  facet_wrap(~dataset) +
  theme(legend.position="none") +
  ggtitle("Within-subject mean magnitude of error in centile scores across ComBat configurations")

subj_sum.df %>%
  mutate(mean_cent_diff = mean_cent_diff*100) %>% #for visuals
  ggplot(aes(x=dataset, y=mean_cent_diff, fill=sex)) +
  geom_violin(trim=FALSE, scale="width") +
  labs(y="Centile Error", x = "ComBat Configurations") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean error in centile scores across ComBat configurations")

subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  mutate(mean_cent_abs.diff = mean_cent_abs.diff*100) %>% #for visuals
  ggplot(aes(x=sim.site, y=mean_cent_abs.diff, fill=sex)) +
  geom_violin(trim=FALSE) +
  facet_wrap(~dataset) +
  labs(y="Magnitude Centile Error", x = "Simulated Site") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean magnitude error in centile scores across \nComBat configurations")

#look at sex distributions of ppts across sites
subj_sum.df %>%
  ggplot() +
  geom_bar(aes(x=sim.site, fill=sex))+
  ggtitle("Distributions of male and female subjects across simulated sites")
```

Significance testing (w/in sub. mean abs centile error) *ask about this - might be better to use wilcox since variances are ~= across sexes*

```{r}
sex.bias.t.tests(subj_sum.df)
sex.bias.t.tests(subj_sum.df, to_test="mean_cent_diff")
```

Keeping these analyses in case I want to use one of the above violin/boxplots that show w/in subject averages (across features). However, while these results I think are good to have from a "be aware of how biological variables are distributed across your study sites" perspective, it doesnt really say anything interesting froma "combat methods" perspective.

Testing for significant M:F differences in centile erros WITHIN each feature!

check for skew (welch t.test vs ranked welch t test)
```{r, eval=FALSE}
for (pheno in pheno_list){
  val <- paste0("diff_", pheno)
  p <- ggplot(diffs.df, aes(x = diffs.df[[val]], fill= sex, color=sex)) +
      geom_histogram(alpha=0.5, position="identity") +
    ggtitle(val) +
    facet_wrap(~dataset, scales="free")
print(p)
}
```

not normally distributed, use nonparametric t test of ranks with welch correction for different variances. Also calculating the median centile errors of males and females, since this seems like a more intuitive thing to plot than effect size (since the effect size is in units of rank, not actually centiles)

```{r, warning=FALSE}
sex_t_tests_in_feat.df <- sex.bias.feat.t.tests(diffs.df)

#also get summary
sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
```

```{r}
sex_t_tests_in_feat.df2 <- sex_t_tests_in_feat.df %>%
  mutate(pheno_cat = as.factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    label = sub("_[^_]*_", "_", pheno)) #for plotting
sex_t_tests_to_plot <- left_join(sex_t_tests_in_feat.df2, dk.parc, by="label")

# max(sex_t_tests_to_plot$median_sex_diff)*100
# min(sex_t_tests_to_plot$median_sex_diff)*100
```


plot w/in feature t tests

```{r}
#var plot
sex.var.plot.df <- sex_t_tests_to_plot %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset, pheno_cat)

tp <- unique(sex.var.plot.df[,c('dataset','pheno_cat')]) %>%
  dplyr::filter(dataset=="ukb_CN")
tp$sex_diff <- 1

sex.var.plot <- ggplot(sex.var.plot.df) +
  geom_rect(data = tp, fill="gray", xmin = -Inf, xmax = Inf,
            ymin = -Inf, ymax = Inf, alpha = 0.4) +
  ggseg::geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = median_sex_diff)) +
  #scale_fill_gradient2() +
  facet_grid(dataset ~ pheno_cat, labeller = labeller(dataset = as_labeller(dataset_names))) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=2/3, plot.margin = margin(1,1,1,1, 'pt')) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", name = "Sex Effect", limits = c(-6, 6), breaks = c(-5, -2, 0, 2, 5))
# sex.var.plot
```

```{r}
#plot global
sex.var.plot.global.df <- sex_t_tests_to_plot %>%
  dplyr::filter(pheno_cat == "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  dplyr::select(!c(label, region, hemi)) %>% #drop cols corresponding to dk regions
  mutate(tissue_class = as.factor(case_when(pheno == "GMV" ~ "cGM",
                                            pheno == "Ventricles" ~ "CSF",
                                            pheno == "WMV" ~ "WM",
                                            pheno == "sGMV" ~ "sGM",
                                            TRUE ~ NA)),
        median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>% #drop NS values
  group_by(dataset)

tp <- unique(sex.var.plot.global.df[,c('dataset','pheno_cat')]) %>%
  dplyr::filter(dataset=="ukb_CN")
tp$sex_standard <- 1

sex.var.plot.global <- ggplot(sex.var.plot.global.df) +
  geom_rect(data = tp, fill="gray", xmin = -Inf,xmax = Inf,
            ymin = -Inf, ymax = Inf, alpha = 0.4) +
  ggseg::geom_brain(atlas = aseg_cerebrum, 
             aes(fill = median_sex_diff),
             side = c("coronal")) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", name = "Sex Effect", limits = c(-6, 6), breaks = c(-5, -2, 0, 2, 5))
# sex.var.plot.global
```

Combine plots - need to keep playing around to make the spacing pretty when it saves out
```{r}
p_sex <- ggarrange(
  sex.var.plot.global, sex.var.plot,
  ncol=2, nrow=1, 
  widths = c(1, 3.1),
  #labels=c("A", "B"),
  #hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

p_sexannotate <- annotate_figure(p_sex, top = text_grob("Figure 2A. Sex-biases in centile score errors across combat configurations", 
               color = "black", size = 14, hjust=.65))
p_sexannotate
ggsave("figs/sex_diff_win_feat.jpeg", p_sexannotate, width=7, height=8)
```

Sex Effect is the median male centile error - median female centile error (i.e. units are in centiles). Therefore, + sex effect (blue) means female scores tend to have more positive errors (TRUE centile > calculated centile) and - sex effect (green) means females have more negative errors (TRUE centile < calculated centile)? Honestly, not the most straightforward interpretation, i know - may make more sense to just plot the median errors separately in males and females than to plot the differences between the two.


### Extremeness-Biases

Group at 0-0.25, >0.25 - .75 <, 0.75-1

```{r}
subj_sum.df <- subj_sum.df %>%
  mutate(cent_cat = factor(case_when(mean_centile <= 0.25 ~ "low",
                              mean_centile > 0.25 & mean_centile < 0.75 ~ "mid",
                              mean_centile >= 0.75 ~ "high"), levels= c("low", "mid", "high"), ordered=TRUE),
         z_cat = as.factor(case_when(mean_z <= -1 ~ "low",
                              mean_z > -1 & mean_z < 1 ~ "mid",
                              mean_z >= 1 ~ "high")))
``` 



```{r}
subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  ggplot(aes(x=mean_centile, y=mean_cent_diff, color=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  facet_grid(~dataset, scales="free_y")

subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  ggplot(aes(x=mean_centile, y=mean_cent_diff, color=sex)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  facet_grid(dataset ~ sim.site, scales="free_y")
```

test to see if slope of non-dominant group is nonzero!!!

```{r}
subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  ggplot(aes(x=cent_cat, y=mean_cent_diff, color=sex)) +
  geom_violin() +
  facet_wrap(~dataset, scales="free_y")

subj_sum.df %>%
  #dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  ggplot(aes(x=cent_cat, y=mean_cent_diff)) +
  geom_violin() +
  facet_wrap(~dataset, scales="free_y")
```

The relationship between subjects' centile score and how much their centile score is altered by combat is complex and depends on sex and site. I think that rather than trying to investigate this directly, it'll be more interesting/effective to show visually with the secondary analyses where I vary M:F ratios.

## Z-SCORES

*come back to this*

look for skew in distribution

significance testing

```{r}
#initalize empty dfs to store outputs
# z.sum.df <- data.frame(pheno = character(),
#                        term = character(),
#                        df = double(),
#                        sumsq = double(),
#                        meansq = double(),
#                        statistic = double(),
#                        p.value = double())
z.t.df <- data.frame("pheno" = character(),
                     "group1" = character(),
                     "group2" = character(),
                     "p.value" = double())

#run tests
attach(diffs.df)
for (pheno in z.pheno_abs.diff.list) {
  # df.aov <- tidy(kruskal.test(diffs.df[[pheno]] ~ diffs.df[["dataset"]]))
  # df.aov$pheno <- pheno
  # z.sum.df <- rbind(z.sum.df, df.aov)
  
  df.pairwise.t <- tidy(pairwise.rank.welch.t.test(x=diffs.df[[pheno]], g=diffs.df[["dataset"]], paired = TRUE, p.adj = "none"))
  df.pairwise.t$pheno <- pheno
  z.t.df <- rbind(z.t.df, df.pairwise.t)
}
detach()

#apply fdr correction
# z.sum.df <- z.sum.df %>%
#   dplyr::filter(term != "Residuals") %>%
#   mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno_list)))

z.t.df <- z.t.df %>%
  mutate(p.val_fdr = p.adjust(p.value, method="fdr", n = length(pheno)),
         sig_fdr = case_when(p.val_fdr < 0.05 ~ TRUE,
                             p.val_fdr >= 0.05 ~ FALSE),
         pheno = sub("abs.diff_", "", pheno),
         pheno = sub(".z", "", pheno)) %>%
  unite(comp, c("group1", "group2")) %>%
  mutate(comp = as.factor(comp))

sum_z.t.df <- z.t.df %>%
  group_by(comp) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            n_compare = n(),
            min.pval = min(p.val_fdr),
            max.pval = max(p.val_fdr))

sum_z.t.df
```

Little plot
```{r}
#get means w/in feature 
z.mean.diffs.long <- diffs.df %>%
  dplyr::select(sex, dataset, pheno, z.pheno_abs.diff.list) %>%
  mutate(dataset = factor(dataset, levels = c("ukb_CN", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="z_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno = gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
```

```{r}
z.diffs.plot <- z.mean.diffs.long %>%
  dplyr::filter(dataset != "ukb_CN") %>%
  ggplot() +
  geom_histogram(aes(x=z_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Percent Features", x = "Mean Absolute Z-Score Error") +
  ggtitle("Figure 2. Absolute errors in z-scores of brain structure features across ComBat processing pipelines")
z.diffs.plot

ggsave("figs/win_feature_mean_z_abs.diffs.jpeg", z.diffs.plot)
```

### Sex-Biases

Visualize magnitude mean w/in subj error

```{r}
subj_sum.df %>%
  ggplot() +
  geom_violin(aes(x=dataset, y=mean_z_abs.diff, fill=sex)) +
  labs(y= "Magnitude Z-Score Error", x = "ComBat Configurations") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean magnitude error in z-scores across ComBat configurations")

subj_sum.df %>%
  ggplot(aes(x=sex, y=mean_z_diff, fill=sex)) +
  geom_boxplot(trim=FALSE, scale="width") +
  facet_wrap(~dataset, scale="free_y") +
  labs(y="Z-Score Error", x = "ComBat Configurations") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean error in z-scores across ComBat configurations")

subj_sum.df %>%
  dplyr::filter(dataset == "cf.gamlss" | dataset == "cf.gam" | dataset == "cf.lm") %>%
  ggplot(aes(x=sim.site, y=mean_z_abs.diff, fill=sex)) +
  geom_violin(trim=FALSE) +
  facet_wrap(~dataset) +
  labs(y="Magnitude Z Error", x = "Simulated Site") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Within-subject mean magnitude error in z-scores across ComBat configurations")

subj_sum.df %>%
  ggplot() +
  geom_bar(aes(x=sim.site, fill=sex))
```

Significance testing (w/in sub. mean abs z error) *ask about this - might be better to use wilcox since variances are ~= across sexes*

```{r}
sex.bias.t.tests(subj_sum.df, to_test="mean_z_abs.diff")
sex.bias.t.tests(subj_sum.df, to_test="mean_z_diff")
```

## CENTILE FANS

pulled predicted centiles from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_centiles.csv' .`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_centiles.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  print(paste("reading file", file))
  # Read each CSV file
    data <- fread(file)
    
    data <- data %>%
     mutate(dataset = gsub("-data", "", dataset))

    # Bind the data to the combined dataframe
    df_list[[file]] <- as.data.frame(data)
    assign("basic_centiles", df_list)
}
# length(basic_centiles)
centiles.df <- bind_rows(basic_centiles)
#skimr::skim(centiles.df)
# names(centiles.df)
```

just work with global volumes to visualize for now

```{r}
#get raw data points for visualization
global.df.long <- ukb_cn_df %>%
  dplyr::select(participant, age_days, sex, vol_list_global) %>%
  pivot_longer(cols = vol_list_global, values_to = "value", names_to="pheno")
```


```{r}
global.cent.df <- centiles.df %>%
  dplyr::filter(pheno_cat == "Global Volume") %>%
  dplyr::filter(!grepl('-refA', dataset))


for (feature in unique(global.cent.df$pheno)) {

  df <- global.cent.df %>%
    dplyr::filter(pheno == feature)
  
 plot <- ggplot() +
      #geom_point(aes(x=ukb_cn_df$age_days, y=ukb_cn_df[[feature]]), alpha=0.5) +
      #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
      geom_line(aes(x=df$age_days, y=df$M_centile_1, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_2, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_3, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_4, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_5, color=df$dataset), linewidth=1.5) +
      geom_line(aes(x=df$age_days, y=df$M_centile_6, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_7, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_8, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$M_centile_9, color=df$dataset)) +
      labs(title=paste("Male", feature, "brain chart"))
 
 print(plot)
 
 plot <- ggplot() +
      #geom_point(aes(x=ukb_cn_df$age_days, y=ukb_cn_df[[feature]]), alpha=0.5) +
      #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
      geom_line(aes(x=df$age_days, y=df$F_centile_1, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_2, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_3, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_4, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_5, color=df$dataset), linewidth=1.5) +
      geom_line(aes(x=df$age_days, y=df$F_centile_6, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_7, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_8, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$F_centile_9, color=df$dataset)) +
      labs(title=paste("Female", feature, "brain chart"))
 
 print(plot)
 
 plot <- ggplot() +
      geom_point(aes(x=ukb_cn_df$age_days, y=ukb_cn_df[[feature]]), alpha=0.5) +
      #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
      geom_line(aes(x=df$age_days, y=df$centile_1, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_2, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_3, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_4, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_5, color=df$dataset), linewidth=1.5) +
      geom_line(aes(x=df$age_days, y=df$centile_6, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_7, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_8, color=df$dataset)) +
      geom_line(aes(x=df$age_days, y=df$centile_9, color=df$dataset)) +
      labs(title=paste(feature, "brain chart"))
 
 print(plot)
  
}
```

Looking at WMV more specifically for visualizations
```{r}
#wm centile lines
wmv.df <- centiles.df %>%
  dplyr::filter(pheno == "WMV") %>%
  dplyr::filter(dataset == "ukb-CN-simsites" | dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "ukb-CN-simsites", after = Inf ))
```

adding jitter to age (x-axis) because otherwise frankly it's hard to look at

```{r}
dataset_names <- c('ukb-CN-simsites' = "Raw Data", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")

ggplot(wmv.df) +
  geom_jitter(data = ukb_cn_df, aes(x=ukb_cn_df$age_days, y=ukb_cn_df$WMV), alpha=0.4, width=150, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_days, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_3, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  geom_line(aes(x=age_days, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('ukb-CN-simsites'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  theme_minimal() +
  xlab("Age (days)") + ylab("Volume (mm3)") +
  geom_text_repel(aes(x = max(ukb_cn_df$age_days), y = min(centile_1)),
                  label="test",
                  nudge_x = 1,
                  na.rm = TRUE) + 
  labs(title="Fig 2A. WM volume brain charts")
```

*need to add labeling of % lines - ask Ayan how he did it*
also not sure how much i should worry about the super big female outlier

Look at other phenotypes

```{r}
#looking at other phenotypes
ven.df <- centiles.df %>%
  dplyr::filter(pheno == "Ventricles") %>%
  dplyr::filter(dataset == "ukb-CN-simsites" | dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "ukb-CN-simsites", after = Inf ))

ggplot(ven.df) +
  geom_jitter(data = ukb_cn_df, aes(x=ukb_cn_df$age_days, y=ukb_cn_df$Ventricles), alpha=0.7, width=150, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_days, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_3, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  geom_line(aes(x=age_days, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('ukb-CN-simsites'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  theme_minimal() +
  xlab("Age (days)") + ylab("Volume (mm3)") +
  theme_minimal() +
  labs(title="sGMV brain charts")
```
Random cortical feature

```{r}
r.sa.pc.df <- centiles.df %>%
  dplyr::filter(pheno == "rh_SA_postcentral") %>%
  dplyr::filter(dataset == "ukb-CN-simsites" | dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "ukb-CN-simsites", after = Inf ))

ggplot(r.sa.pc.df) +
  geom_jitter(data = ukb_cn_df, aes(x=ukb_cn_df$age_days, y=ukb_cn_df$rh_SA_postcentral), alpha=0.7, width=150, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_days, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_3, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  geom_line(aes(x=age_days, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('ukb-CN-simsites'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  theme_minimal() +
  xlab("Age (days)") + ylab("Volume (mm3)") +
  theme_minimal() +
  labs(title="SA of right postcentral brain charts")
```

