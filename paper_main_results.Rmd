---
title: "hbm_paper_results"
output: html_document
date: '2023-11-12'
---

Main analyses of ComBatLS paper.

Relies on outputs derived/functions from:

* `./cubic_scripts/R_scripts/stats_tests.R`
1. `ukb_curation-eda.Rmd`
2. `qsub_combat.sh` -> `/cubic_scripts/R_scripts/combat_apply.R`
3. `qsub_basic_gamlss.sh` -> `/cubic_scripts/R_scripts/fit_basic_mod.R`
4. `qsub_centiles.sh` -> `/cubic_scripts/R_scripts/fit_centiles.R`
5. `gamlss_parse.sh` -> `/cubic_scripts/R_scripts/gamlss_parser.R`
6. `qsub_summarize_subj_centiles.sh` -> `/cubic_scripts/R_scripts/summarise_cent_subj-wise.R`

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(data.table, ggplot2, tidyverse, ggseg, ggsegExtra, paletteer, ggpubr, gridExtra, lemon, parallel, rstatix, lme4, interactions, ggrepel, ggrain, ggh4x)
```
```{r}
source("./cubic_scripts/R_scripts/stats_tests.R")
```


```{r}
aseg_cerebrum <- readRDS(file="/Users/megardn/Desktop/BGD_Repos/ggseg_atlas/aseg_cerebrum_atlas.RDS")
data_path <- "/Users/megardn/Desktop/BGD_Repos/combat_biovar/derivatives"

#pheno lists
pheno_list <- readRDS(file="cubic_scripts/R_scripts/pheno_list.rds")
vol_list_global <- readRDS(file="cubic_scripts/R_scripts/vol_list_global.rds")
vol_list_regions <- readRDS(file="cubic_scripts/R_scripts/Vol_list_regions.rds")
sa_list <- readRDS(file="cubic_scripts/R_scripts/SA_list.rds")
ct_list <- readRDS(file="cubic_scripts/R_scripts/CT_list.rds")

#diff lists
pheno_diff_list <- paste0("diff_", pheno_list)
pheno_abs.diff.list <- paste0("abs.diff_", pheno_list)


#z lists
pheno_list.z <- paste0(pheno_list, ".z")
z.pheno_diff_list <- paste0(pheno_diff_list, ".z")
z.pheno_abs.diff.list <- paste0(pheno_abs.diff.list, ".z")

#also load raw data
raw_df <- fread("/Users/megardn/Desktop/BGD_Repos/combat_biovar/data/ukb_to_model/UKB_CN_data_simsites.csv")

#years for plotting
raw_df <- raw_df %>%
  mutate(age_years = age_days/365.25)

#write out new dk atlas w/o medial wall
dk_nomed <- dk
dk_nomed$data <- dk_nomed$data %>%
  dplyr::filter(!is.na(region) & region !="corpus callosum")
#plotting info from dk atlas
dk.parc <- dk_nomed$data %>%
  as.data.frame() %>%
  na.omit() %>%
  dplyr::select(c(hemi, region, label)) %>%
  distinct()
```


# Load Data

pulled variance from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_variance.csv' ./derivatives/ukb_basic`

Get predicted centiles
- pulled from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_predictions.csv' ./derivatives/ukb_basic`

```{r}
pred.csvs <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_predictions.csv", full.names = TRUE)
combined_preds <- data.frame()

for (file in pred.csvs) {
  # Read each CSV file
  data <- fread(file)
  
  # Add a "Source_File" column with the file name
  data <- data %>%
    mutate(Source_File = as.factor(basename(file))) %>%
    mutate(dataset = gsub("_data|_predictions.csv", "", Source_File))
  
  # Bind the data to the combined dataframe
  combined_preds <- bind_rows(combined_preds, data)
}

unique(combined_preds$dataset)

skim(combined_preds)
```

QC: check for ppts with centiles ~ 1 or 0 and make sure Z scores exist

```{r}
combined_preds %>% 
  filter_at(vars(pheno_list), any_vars(. %in% c(1, 0))) %>%
  dplyr::select(participant) %>%
  unique() %>%
  nrow()

combined_preds %>% 
  filter_at(vars(pheno_list.z), any_vars(. %in% c(NA, Inf, -Inf))) %>%
  dplyr::select(participant) %>%
  unique() %>%
  nrow()
```

saving out csv forces some centile scores to round up to 1, but z scores are still being calculated correctly.

Get errors
- pulled centile/z error calcs from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_diffs.csv' ./derivatives/ukb_basic`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_diffs.csv", full.names = TRUE) %>% unlist()

diffs.df <- fread(file = raw_files, sep=",") %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

sum(is.na(diffs.df))
```


Get subject-wise summaries
- pulled from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/subject-wise/*.csv' ./derivatives/ukb_basic`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_subj_pred.csv", full.names = TRUE) %>% unlist()

subj_sum.df <- fread(file = raw_files, sep=",") %>%
     mutate(dataset = gsub("_data|_data_predictions.csv|prop-|[0-9]|-", "", Source_File))

sum(is.na(subj_sum.df))
```

# CENTILES

Do centile scores change based on combat version?
Foregoing anova based on emails with Andrew (anova violates assumptions of no equal variance but there's no option for kruskall-wallace with paired samples - which these are, since it's the same subjects)

Within each feature (phenotype), iterate paired t test of ranks between each combo of combat dfs (nonparametric per discussion with Andrew). (see Zimmerman & Zumbo, 1993). Using custom functions from `ranked_welch_tests.R`.

```{r, }
full_cent_res <- centile.t.tests.full_result(diffs.df, feature_list=pheno_abs.diff.list)
saveRDS(full_cent_res, "./derivatives/ukb_basic/featurewise_cent_t_tests_all_out.RDS") #running once and saving because it takes a long time
```

```{r}
full_cent_res <- readRDS("./derivatives/ukb_basic/featurewise_cent_t_tests_all_out.RDS")
full_cent_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr)) %>%
  dplyr::filter(!grepl('_refA', comp))#drop refA levels

full_cent_res %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  # dplyr::filter(!grepl('_refA', comp)) %>%#drop refA levels
  ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

bigger group -> relatively worse fit

Little plot
```{r}
#get means w/in feature 
mean.diffs.long <- diffs.df %>%
  dplyr::select(sex, dataset, pheno_abs.diff.list) %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
```


```{r}
dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
dataset_colors <- c(cf = "#3D5983FF", cf.lm = "#5A8A54FF", cf.gam ="#262626FF", cf.gamlss ="#CFB023FF")

cent.diffs.plot <- mean.diffs.long %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Percent Features", x = "Mean Absolute Centile Error") +
  ggtitle("Absolute errors in centile scores of brain structure features across ComBat processing pipelines")
cent.diffs.plot

ggsave("figs/win_feature_mean_cent_abs.diffs.jpeg", cent.diffs.plot)
```

Plot errors for global phenotypes

get stat results for global phenos:
```{r, message=FALSE}
full_cent_res %>%
  dplyr::filter(pheno %in% vol_list_global) %>%
  dplyr::filter(!grepl('_refA', comp)) %>%
  summarise(n_sig = sum(sig_fdr),
            nrow = nrow(.))

#n occurances of combatLS having significantly larger errors
full_cent_res %>%
  dplyr::filter(bigger_group == "cf.gamlss")%>%
  dplyr::filter(!grepl('_refA', comp)) %>%
  summarise(n_sig = sum(sig_fdr),
            nrow = nrow(.))
```


```{r}
dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")

global_abs.diffs <- diffs.df %>%
  dplyr::select(participant, sex, age_days, sim.site, dataset, paste0("abs.diff_", vol_list_global)) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff")

global_cent_errs_plot <- global_abs.diffs %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         pheno = factor(pheno, levels = c("WMV", "GMV", "sGMV", "Ventricles"), ordered = TRUE),
         abs.diff = abs.diff*100) %>% #for visuals
  ggplot(aes(pheno, abs.diff)) +
  geom_violin(aes(x=pheno, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #WMV
geom_signif(y_position = c(3, 3.5, 2.5), xmin = c(0.7, 0.7, 1),
              xmax = c(1, 1.3, 1.3), annotation = c("***","***", "***"),
              tip_length = 0, vjust = 0.6) +
  #GMV
  geom_signif(y_position = c(2.75, 3.25, 2.25), xmin = c(1.7, 1.7, 2),
              xmax = c(2, 2.3, 2.3), annotation = c("***","***", "***"),
              tip_length = 0, vjust = 0.6) +
  #sGMV
  geom_signif(y_position = c(2.7, 3.2, 2.2), xmin = c(2.7, 2.7, 3),
              xmax = c(3, 3.3, 3.3), annotation = c("***","***", "***"),
              tip_length = 0, vjust = 0.6) +
  #Ventricles
  geom_signif(y_position = c(7.1, 6.75, 6.45), xmin = c(3.7, 3.7, 4),
              xmax = c(4, 4.3, 4.3), annotation = c("***","***", "***"),
              tip_length = 0, vjust = 0.6) +
  labs(y="Absolulte Centile Error", x = "Feature") +
  theme(plot.title = element_text(size=12))
global_cent_errs_plot
# ggsave("figs/global_centile_errors.jpeg", global_cent_errs_plot)
```

All features:
```{r}
long_abs.diffs <- diffs.df %>%
  dplyr::filter(dataset == "cf.lm" | dataset == "cf.gam" | dataset == "cf.gamlss") %>% #drop refA levels
  dplyr::select(participant, sex, age_days, sim.site, dataset, paste0("abs.diff_", pheno_list)) %>%
  pivot_longer(cols=starts_with("abs.diff_"), names_to="pheno", names_prefix="abs.diff_", values_to = "abs.diff") %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         abs.diff = abs.diff*100,
         pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)))

long_abs_diff.plt <- long_abs.diffs %>%
  ggplot(aes(pheno, abs.diff)) +
  geom_violin(aes(x=pheno, y=abs.diff, fill=dataset, color=dataset), scale="count") +
  theme_linedraw(base_size = 11) +
  scale_fill_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values=c(cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Absolulte Centile Error", x = "Feature") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust=0.4, size=6), legend.position="top") +
  facet_wrap(~pheno_cat, nrow=4, scales="free")
ggsave("figs/all_abs_err_plt_wlabels.jpeg", long_abs_diff.plt, width=13, height=10.5, units="in")
```

plot median on brain
```{r}
#get median w/in feature 
med.diffs.long <- diffs.df %>%
  dplyr::select(sex, dataset, pheno_abs.diff.list) %>%
  dplyr::filter(dataset %in% c("cf.lm", "cf.gam", "cf.gamlss")) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), median)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="median_centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))

med.diffs.long2 <- left_join(med.diffs.long, dk.parc, by="label")
max(med.diffs.long2$median_centile_abs.diff)*100

dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
#var plot
med.diffs.plot.df <- med.diffs.long2 %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_centile_abs.diff = median_centile_abs.diff*100)

med.diffs.plot <- ggplot(med.diffs.plot.df) +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
             aes(fill = median_centile_abs.diff)) +
  facet_grid(dataset ~ pheno_cat, labeller = labeller(dataset = as_labeller(dataset_names))) + 
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=2/3, plot.margin = margin(1,1,1,1, 'pt')) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo", name = "Median Absolute Centile Error", limits = c(0, 1)) #
# med.diffs.plot
```

```{r}
#plot global
med.diffs.plot.global.df <- med.diffs.long2 %>%
  dplyr::filter(pheno_cat == "Global Volume") %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  dplyr::select(!c(label, region, hemi)) %>% #drop cols corresponding to dk regions
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_centile_abs.diff = median_centile_abs.diff*100)

med.diffs.plot.global <- ggplot(med.diffs.plot.global.df) +
  ggseg::geom_brain(atlas = aseg_cerebrum, 
             aes(fill = median_centile_abs.diff),
             side = c("coronal")) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  paletteer::scale_fill_paletteer_c("grDevices::Oslo", name = "Median Absolute Centile Error", limits = c(0, 1))
# med.diffs.plot.global
```

Combine plots - need to keep playing around to make the spacing pretty when it saves out
```{r}
p_diff <- ggarrange(
  med.diffs.plot.global, med.diffs.plot,
  ncol=2, nrow=1, 
  widths = c(.95, 3.1),
  #labels=c("A", "B"),
  #hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )
```

Count of instances where cf.gamlss has higher errors

```{r}
full_cent_res %>%
  dplyr::filter(sig_fdr == TRUE & bigger_group == "cf.gamlss") %>%
  group_by(comp) %>%
  summarise(n_regions=sum(sig_fdr))
```

13 regions where ComBat GAM is better than ComBat-LS, 13 regions where linear ComBat is better than ComBat-LS, 1 region where combat w/o covars is better: ALL cortical thickness

### Sex-Differences

Testing for significant M:F differences in centile errors within each feature

check for skew (welch t.test vs ranked welch t test)
```{r}
for (pheno in pheno_list){
  val <- paste0("diff_", pheno)
  p <- ggplot(diffs.df, aes(x = diffs.df[[val]], fill= sex, color=sex)) +
      geom_histogram(alpha=0.5, position="identity") +
    ggtitle(val) +
    facet_wrap(~dataset, scales="free")
print(p)
}
```

```{r}
for (cf in c("cf.gam", "cf.gamlss")) {
  for (pheno in vol_list_global){
  val <- paste0("diff_", pheno)
  med.df <- diffs.df %>%
    dplyr::filter(dataset == cf) %>%
    group_by(sex) %>%
    summarize_at(val, median, na.rm=FALSE)

 p <- diffs.df %>%
    dplyr::filter(dataset == cf) %>%
    ggplot(aes(x=.[[val]], fill = sex, color=sex)) +
      geom_histogram(alpha=0.5, position="identity") +
    ggtitle(paste(val, cf)) +
    geom_vline(aes(xintercept = med.df[med.df$sex=="Female", ][[val]])) +
    geom_vline(aes(xintercept = med.df[med.df$sex=="Male", ][[val]]))
  print(p)
  }
}
```

not normally distributed, use nonparametric t test of ranks with welch correction for different variances. Also calculating the median centile errors of males and females, since this seems like a more intuitive thing to plot than effect size (since the effect size is in units of rank, not actually centiles)

```{r, message=FALSE, }
sex_t_tests_in_feat.df <- sex.bias.feat.t.tests(diffs.df, feature_list=pheno_diff_list)
saveRDS(sex_t_tests_in_feat.df, "./derivatives/ukb_basic/featurewise_cent_sexbias_all_out.RDS")
```

```{r}
sex_t_tests_in_feat.df <- readRDS("./derivatives/ukb_basic/featurewise_cent_sexbias_all_out.RDS")
#also get summary
sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
```

quick plot for median diffs
```{r}
sex_t_tests_in_feat.df %>%
  dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  ggplot() +
  geom_histogram(aes(x=median_sex_diff, fill= dataset, color=dataset), alpha=0.4, position = "identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  theme(plot.title = element_text(size=12), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

sex_t_tests_in_feat.df %>%
  group_by(dataset) %>%
  summarize(min_diff = min(median_sex_diff)*100, max_diff=max(median_sex_diff)*100)
```

```{r}
#get range
sex_t_tests_in_feat.df %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset) %>%
  summarize(min_sex_diff = min(median_sex_diff, na.rm=TRUE),
            max_sex_diff = max(median_sex_diff, na.rm=TRUE))

#look by feature type
sex_t_tests_in_feat.df %>%
  # dplyr::filter(dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  mutate(median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100),
         pheno_cat = factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_))) %>%
ggplot() +
  geom_histogram(aes(x=median_sex_diff, color=dataset, fill=dataset),alpha=0.5, position="identity") +
  geom_vline(xintercept = 0, linetype="dashed") +
  facet_grid(pheno_cat~dataset, scales="free")

```

```{r}
sex_t_tests_in_feat.df2 <- sex_t_tests_in_feat.df %>%
  mutate(pheno_cat = as.factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    label = sub("_[^_]*_", "_", pheno)) #for plotting
sex_t_tests_to_plot <- left_join(sex_t_tests_in_feat.df2, dk.parc, by="label")

# max(sex_t_tests_to_plot$median_sex_diff)*100
# min(sex_t_tests_to_plot$median_sex_diff)*100
```


plot w/in feature t tests

```{r}
dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
#var plot
sex.var.plot.df <- sex_t_tests_to_plot %>%
  dplyr::filter(pheno_cat != "Global Volume") %>%
  dplyr::filter(dataset %in% c("cf.lm", "cf.gam", "cf.gamlss")) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_sex_diff = median_sex_diff*100)
#find range
max(sex.var.plot.df$median_sex_diff, na.rm=TRUE)
min(sex.var.plot.df$median_sex_diff, na.rm=TRUE)

sex.var.plot <- ggplot(sex.var.plot.df) +
  theme_linedraw(base_size=12) +
  ggseg::geom_brain(atlas = dk_nomed, 
             position = position_brain(hemi ~ side),
             aes(fill = median_sex_diff)) +
  #scale_fill_gradient2() +
  # ggseg::geom_brain(data=med_wall, atlas = dk, 
  #            position = position_brain(hemi ~ side),
  #            aes(fill=median_sex_diff)) +
  facet_grid(dataset ~ pheno_cat, labeller = labeller(dataset = as_labeller(dataset_names))) + 
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=2/3, plot.margin = margin(1,1,1,1, 'pt')) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", name = "Male - Female Median \nCentile Error", limits = c(-0.25, 0.25)) #
saveRDS(sex.var.plot, file="figs/sex_var_plot.RDS")
```

```{r}
#plot global
sex.var.plot.global.df <- sex_t_tests_to_plot %>%
  dplyr::filter(pheno_cat == "Global Volume") %>%
  dplyr::filter(dataset %in% c("cf.lm", "cf.gam", "cf.gamlss")) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  dplyr::select(!c(label, region, hemi)) %>% #drop cols corresponding to dk regions
  mutate(tissue_class = as.factor(case_when(pheno == "GMV" ~ "cGM",
                                            pheno == "Ventricles" ~ "CSF",
                                            pheno == "WMV" ~ "WM",
                                            pheno == "sGMV" ~ "sGM",
                                            TRUE ~ NA)),
        median_sex_diff = median_sex_diff*100) %>% 
  group_by(dataset)

#color range
max(sex.var.plot.global.df$median_sex_diff, na.rm=TRUE)
min(sex.var.plot.global.df$median_sex_diff, na.rm=TRUE)

tp <- unique(sex.var.plot.global.df[,c('dataset','pheno_cat')]) %>%
  dplyr::filter(dataset=="raw")
tp$sex_standard <- 1

sex.var.plot.global <- ggplot(sex.var.plot.global.df) +
  geom_rect(data = tp, fill="gray", xmin = -Inf,xmax = Inf,
            ymin = -Inf, ymax = Inf, alpha = 0.4) +
  ggseg::geom_brain(atlas = aseg_cerebrum, 
             aes(fill = median_sex_diff),
             side = c("coronal")) +
  #scale_fill_gradient2() +
  facet_grid(dataset~pheno_cat) + 
  theme_linedraw(base_size=12) +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color= "gray", fill = NA), aspect.ratio=, plot.margin = margin(1,1,1,1, 'pt'), strip.text.y = element_blank()) +
  paletteer::scale_fill_paletteer_c("grDevices::Cork", limits = c(-0.25, 0.25), name = "Male - Female Median \nCentile Error") #,
# sex.var.plot.global

#save RDS
saveRDS(sex.var.plot.global, file="figs/sex_var_plot_global.RDS")
```

Combine plots - need to keep playing around to make the spacing pretty when it saves out
```{r}
p_sex <- ggarrange(
  sex.var.plot.global, sex.var.plot,
  ncol=2, nrow=1, 
  widths = c(1, 3.1),
  #labels=c("A", "B"),
  #hjust=0.01,
  align = "hv",
  common.legend = TRUE, legend = "bottom"
  )

p_sexannotate <- annotate_figure(p_sex, top = text_grob("Figure 2A. Sex-differences in centile score errors across combat configurations", 
               color = "black", size = 14, hjust=.65))
p_sexannotate
ggsave("figs/sex_diff_win_feat.jpeg", p_sexannotate, width=7, height=8)
saveRDS(p_sexannotate, file="figs/sex_diff_win_feat.RDS")
```

Sex Effect is the median male centile error - median female centile error (i.e. units are in centiles). Therefore, + sex effect (blue) means female scores tend to have more positive errors (TRUE centile > calculated centile) and - sex effect (green) means females have more negative errors (TRUE centile < calculated centile)

### W/o extremes
Are extreme centiles (<5% and >95%) driving observed results?

Get raw centiles and merge with centile differences

```{r, message=FALSE}
raw_centiles <- combined_preds %>%
  dplyr::filter(dataset == "raw")
stopifnot(nrow(raw_centiles)>10)
sum(is.na(raw_centiles))

merge.df <- full_join(raw_centiles, diffs.df)
unique(merge.df$dataset)
dim(raw_centiles)
dim(merge.df)

merge.df <- merge.df %>%
  dplyr::select(!File_ID)
```


```{r}
df_list <- c()
count <- 1
for(pheno in pheno_list) {
  list <- c(pheno, paste0("diff_", pheno), paste0("abs.diff_", pheno))

  df <- merge.df %>%
    dplyr::select(participant, sex, age_days, sim.site, Source_File, dataset, list) %>% #get correct cols
    group_by(participant) %>% 
    dplyr::filter(!any((get(pheno) < 0.05| get(pheno) > 0.95) & dataset == "raw")) %>% #drop ppts if raw centile is <0.05 or >0.95
    ungroup() %>%
    dplyr::filter(dataset != "raw") #now drop raw vals
  df_list[count] <- list(df)
  count <- count + 1
}
length(df_list) == length(pheno_list)
```
merge into single dataframe
```{r, message=FALSE}
no_ext <- Reduce(full_join, df_list)
sum(is.na(no_ext))

#make sure no cols are lost
dim(no_ext)
n_unique(no_ext$participant)
n_unique(merge.df$participant)
```

Rerun stats tests

centile error diffs
```{r, eval=FALSE, message=FALSE}
noext_cent_res <- centile.t.tests.full_result(no_ext, feature_list=pheno_abs.diff.list)
saveRDS(noext_cent_res, "./derivatives/ukb_basic/featurewise_cent_t_tests_all_noext_out.RDS")
```

bigger group -> relatively worse fit

```{r}
noext_cent_res <- readRDS("./derivatives/ukb_basic/featurewise_cent_t_tests_all_noext_out.RDS")
noext_cent_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr))

full_cent_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr))

noext_cent_res %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Little plot
```{r, eval=TRUE}
dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
dataset_colors <- c(cf = "#3D5983FF", cf.lm = "#5A8A54FF", cf.gam ="#262626FF", cf.gamlss ="#CFB023FF")

#get means w/in feature 
no.ext_mean.diffs.long <- no_ext %>%
  dplyr::select(sex, dataset, pheno, pheno_abs.diff.list) %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean, na.rm=TRUE)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="centile_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
```
```{r}
no.ext_mean.diffs.long %>%
  dplyr::filter(dataset != "raw") %>%
  mutate(centile_abs.diff = centile_abs.diff*100) %>% #for visuals
  ggplot() +
  geom_histogram(aes(x=centile_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Percent Features", x = "Mean Absolute Centile Error") +
  ggtitle("No extremes: Absolute errors in centile scores of brain structure features across ComBat processing pipelines")
cent.diffs.plot
```

```{r}
no.ext_mean.diffs.long$type <- "no_ext"
mean.diffs.long$type <- "full"

no.ext_merge <- full_join(no.ext_mean.diffs.long, mean.diffs.long)

no.ext_merge %>%
  ggplot() +
  geom_boxplot(aes(x=type, y=centile_abs.diff, fill=dataset)) +
  ggtitle("W/in feature average magnitude of centile error, w/ and w/o extreme subjects")
```

w/in feature sex-differences
```{r, message=FALSE, }
noext.sex_t_tests_in_feat.df <- sex.bias.feat.t.tests(no_ext, feature_list=pheno_diff_list)
saveRDS(noext.sex_t_tests_in_feat.df, "./derivatives/ukb_basic/featurewise_cent_sexbias_all_noext_out.RDS")
```

```{r}
noext.sex_t_tests_in_feat.df <- readRDS("./derivatives/ukb_basic/featurewise_cent_sexbias_all_noext_out.RDS")

#compare summaries
noext.sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()

sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
```

plot comparative differences in medians
```{r}
sex.var.plot.full.df <- sex_t_tests_to_plot %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  group_by(dataset, pheno_cat) %>%
  dplyr::select(dataset, pheno_cat, pheno, median_sex_diff)

sex.var.plot.full.df$type <- "full"

noext.sex_t_tests_in_feat.df2 <- noext.sex_t_tests_in_feat.df %>%
  mutate(pheno_cat = as.factor(case_when(
    pheno %in% vol_list_global ~ "Global Volume",
    pheno %in% vol_list_regions ~ "Regional Volume",
    pheno %in% sa_list ~ "Regional SA",
    pheno %in% ct_list ~ "Regional CT",
    TRUE ~ NA_character_)),
    label = sub("_[^_]*_", "_", pheno)) %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE),
         median_sex_diff = case_when(sig_fdr == FALSE ~ NA,
                              TRUE ~ median_sex_diff*100)) %>%
  dplyr::select(dataset, pheno_cat, pheno, median_sex_diff) %>%
  group_by(dataset, pheno_cat)

noext.sex_t_tests_in_feat.df2$type <- "no_ext"

#merge
noext_plot.df <- full_join(sex.var.plot.full.df, noext.sex_t_tests_in_feat.df2)
```

```{r}
noext_plot.df %>%
  ggplot() +
  geom_col(aes(x=pheno, y=median_sex_diff, fill=type), alpha=0.7, position="identity") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  facet_wrap(~dataset, scale="free_y")

noext_plot.df %>%
  ggplot() +
  geom_violin(aes(x=type, y=median_sex_diff, fill=type), trim=FALSE) +
  facet_wrap(~dataset, scales="free_y")
```

# Z-SCORES

Do z scores change based on combat version?

check for skew (welch t.test vs ranked welch t test)
```{r}
for (val in z.pheno_abs.diff.list){
  p <- ggplot(diffs.df, aes(x = diffs.df[[val]])) +
      geom_histogram(alpha=0.5, position="identity") +
    ggtitle(val) +
    facet_wrap(~dataset, scales="free")
print(p)
}
```

Within each phenotype, iterate paired t test of ranks between each combo of combat dfs using custom functions from `ranked_welch_tests.R`.

```{r}
full_z_res <- centile.t.tests.full_result(diffs.df, feature_list=z.pheno_abs.diff.list)
saveRDS(full_z_res, "./derivatives/ukb_basic/featurewise_z_t_tests_all_out.RDS")
```

```{r}
full_z_res <- readRDS("./derivatives/ukb_basic/featurewise_z_t_tests_all_out.RDS")
full_z_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr)) %>%
  dplyr::filter(!grepl('_refA', comp))#drop refA levels

full_z_res %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  # dplyr::filter(!grepl('_refA', comp)) %>%#drop refA levels
  ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Little plot
```{r}
#get means w/in feature 
mean.z.diffs.long <- diffs.df %>%
  dplyr::filter(!grepl('_refA', dataset)) %>% #drop refA levels
  dplyr::select(sex, dataset, pheno, z.pheno_abs.diff.list) %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="z_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))

dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
dataset_colors <- c(cf = "#3D5983FF", cf.lm = "#5A8A54FF", cf.gam ="#262626FF", cf.gamlss ="#CFB023FF")

z.diffs.plot <- mean.z.diffs.long %>%
  dplyr::filter(dataset != "raw") %>%
  ggplot() +
  geom_histogram(aes(x=z_abs.diff, fill=dataset, y = stat(width*density)), color="black", alpha=0.6, position="identity") +
  theme_linedraw(base_size = 11) +
  facet_wrap(~pheno_cat) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values=dataset_colors, name = "ComBat \nConfiguration", labels=dataset_names) +
  labs(y="Percent Features", x = "Mean Absolute Z-Score Error") +
  ggtitle("Absolute errors in zscores of brain structure features across ComBat processing pipelines")
z.diffs.plot

ggsave("figs/win_feature_mean_z_abs.diffs.jpeg", z.diffs.plot)
```

N features where ComBatLS has higher errors

```{r}
full_z_res %>%
  dplyr::filter(sig_fdr == TRUE & bigger_group == "cf.gamlss") %>%
  group_by(comp) %>%
  summarise(n_regions=sum(sig_fdr))
```

### Sex-Differences

Testing for significant M-F differences in z score errors WITHIN each feature!

check for skew (welch t.test vs ranked welch t test)
```{r}
for (val in z.pheno_diff_list){
  p <- ggplot(diffs.df, aes(x = diffs.df[[val]], fill= sex, color=sex)) +
      geom_histogram(alpha=0.5, position="identity") +
    ggtitle(val) +
    facet_wrap(~dataset, scales="free")
print(p)
}
```

skewed but ~ variances, sticking with t test of ranks. Also calculating the median z-score errors of males and females

```{r, message=FALSE}
z.sex_t_tests_in_feat.df <- sex.bias.feat.t.tests(diffs.df, feature_list=z.pheno_diff_list)
saveRDS(z.sex_t_tests_in_feat.df, "./derivatives/ukb_basic/featurewise_z_sexbias_all_out.RDS")
```

```{r}
z.sex_t_tests_in_feat.df <- readRDS("./derivatives/ukb_basic/featurewise_z_sexbias_all_out.RDS")

#also get summary
z.sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
```

### W/o extremes
Are extreme z-scores (<-2 and >2) driving observed results?

Get raw z-scores and merge with z-score differences

```{r}
z.df_list <- c()
count <- 1
for(pheno in pheno_list.z) {
  list <- c(pheno, paste0("diff_", pheno), paste0("abs.diff_", pheno))

  df <- merge.df %>%
    dplyr::select(participant, sex, age_days, sim.site, Source_File, dataset, list) %>% #get correct cols
    group_by(participant) %>% 
    dplyr::filter(!any((get(pheno) < -2 | get(pheno) > 2) & dataset == "raw")) %>% #drop ppts if raw z score is < -2 or > 2
    ungroup() %>%
    dplyr::filter(dataset != "raw") #now drop raw vals
  z.df_list[count] <- list(df)
  count <- count + 1
}
length(z.df_list) == length(pheno_list.z)
```

merge into single dataframe
```{r, message=FALSE}
z.no_ext <- Reduce(full_join, z.df_list)

#make sure no cols are lost
dim(z.no_ext)
dim(merge.df)

n_unique(merge.df$participant)
n_unique(z.no_ext$participant)
sum(is.na(z.no_ext))
```

Rerun stats tests

z error diffs
```{r}
noext_z_res <- centile.t.tests.full_result(z.no_ext, feature_list=z.pheno_abs.diff.list)
saveRDS(noext_z_res, "./derivatives/ukb_basic/featurewise_z_t_tests_all_noext_out.RDS")
```

```{r}
noext_z_res <- readRDS("./derivatives/ukb_basic/featurewise_z_t_tests_all_noext_out.RDS")
noext_z_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr))

full_z_res %>%
  group_by(comp, bigger_group) %>%
  summarize(n_sig_regions = sum(sig_fdr),
            min_pval=min(p.val_fdr),
            max_pval=max(p.val_fdr))

noext_z_res %>%
  dplyr::filter(sig_fdr==TRUE) %>%
  dplyr::filter(!grepl('_refA', comp)) %>%#drop refA levels
  ggplot() +
  geom_bar(aes(x=comp, fill=bigger_group)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Little plot
```{r}
dataset_names <- c(raw = "Raw Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
dataset_colors <- c(cf = "#3D5983FF", cf.lm = "#5A8A54FF", cf.gam ="#262626FF", cf.gamlss ="#CFB023FF")

#get means w/in feature 
z.no.ext_mean.diffs.long <- diffs.df %>%
  dplyr::select(sex, dataset, pheno, z.pheno_abs.diff.list) %>%
  mutate(dataset = factor(dataset, levels = c("raw", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
  group_by(dataset) %>%
  summarize(across(starts_with("abs.diff_"), mean, na.rm=TRUE)) %>%
  ungroup() %>%
  pivot_longer(cols=starts_with("abs.diff_"), values_to="z_abs.diff", names_to = "pheno", names_prefix = "abs.diff_") %>%
  mutate(pheno=gsub(".z", "", pheno)) %>%
  mutate(pheno_cat = as.factor(case_when(
      pheno %in% vol_list_global ~ "Global Volume",
      pheno %in% vol_list_regions ~ "Regional Volume",
      pheno %in% sa_list ~ "Regional SA",
      pheno %in% ct_list ~ "Regional CT",
      TRUE ~ NA_character_)),
      label = sub("_[^_]*_", "_", pheno))
```

```{r}
z.no.ext_mean.diffs.long$type <- "no_ext"
mean.z.diffs.long$type <- "full"

z.no.ext_merge <- full_join(z.no.ext_mean.diffs.long, mean.z.diffs.long)

z.no.ext_merge %>%
  dplyr::filter(pheno=="GMV" | pheno=="GMV.z")

z.no.ext_merge %>%
  ggplot() +
  geom_boxplot(aes(x=type, y=z_abs.diff, fill=dataset)) +
  ggtitle("W/in feature average magnitude of z error, w/ and w/o extreme subjects")
```

w/in feature sex-differences
```{r, message=FALSE}
noext.z.sex_t_tests_in_feat.df <- sex.bias.feat.t.tests(z.no_ext, feature_list=z.pheno_diff_list)
saveRDS(noext.z.sex_t_tests_in_feat.df, "./derivatives/ukb_basic/featurewise_z_sexbias_all_noext_out.RDS")
```

```{r}
noext.z.sex_t_tests_in_feat.df <- readRDS("./derivatives/ukb_basic/featurewise_z_sexbias_all_noext_out.RDS")

#compare summaries
noext.z.sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()

z.sex_t_tests_in_feat.df %>%
    group_by(dataset) %>%
    dplyr::summarize(n_sig_regions = sum(sig_fdr),
              min_pval = min(p.val_fdr),
              max_pval = max(p.val_fdr)) %>%
    ungroup() %>%
    as.data.frame()
```

# CENTILE FANS

pulled predicted centiles from cubic using `scp -r 'gardnerm@cubic-login.uphs.upenn.edu:/cbica/home/gardnerm/combat-biovar/ukb_basic/centile_csvs/*_centiles.csv' ./derivatives/ukb_basic`

```{r}
raw_files <- list.files(path = paste0(data_path, "/ukb_basic"), pattern = "_centiles.csv", full.names = TRUE)

df_list <- list() #new empty list
for (file in raw_files) {
  print(paste("reading file", file))
  # Read each CSV file
    data <- fread(file)
    
    data <- data %>%
     mutate(dataset = gsub("-data", "", dataset),
            dataset=gsub("ukb-CN-simsites-", "", dataset))

    # Bind the data to the combined dataframe
    df_list[[file]] <- as.data.frame(data)
    assign("basic_centiles", df_list)
}
# length(basic_centiles
centiles.df <- bind_rows(basic_centiles)
#skimr::skim(centiles.df)
# names(centiles.df)
```

just work with global volumes to visualize for now

```{r}
#get raw data points for visualization
global.df.long <- raw_df %>%
  dplyr::select(participant, age_days, sex, vol_list_global) %>%
  pivot_longer(cols = vol_list_global, values_to = "value", names_to="pheno")
```


Looking at WMV more specifically for visualizations
```{r}
#wm centile lines
wmv.df <- centiles.df %>%
  dplyr::filter(pheno == "WMV") %>%
  dplyr::filter(dataset == "raw" | dataset == "cf.gam" | dataset == "cf.gamlss" | dataset == "cf.lm") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "ukb-CN-simsites", after = Inf ),
         age_years = age_days/365.25,
         label = ifelse(age_days == max(age_days), "Test", NA))
```

adding jitter to age (x-axis) because otherwise frankly it's hard to look at
centiles = c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.99)

```{r}
dataset_names <- c('raw' = "True Data", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")

tmp_labels <- wmv.df %>%
  dplyr::filter(age_days == max(age_days) & dataset=="raw") %>%
  pivot_longer(cols=starts_with("centile"), values_to = "value", names_to="centile_num", names_prefix = "centile_") %>%
  mutate(centile = case_when(centile_num == 1 ~ "1%", centile_num==2 ~ "5%", centile_num==3 ~ "10%", 
                             centile_num == 4 ~ "25%", centile_num==5 ~ "50%", centile_num==6 ~ "75%",
                             centile_num == 7 ~ "90%", centile_num==8 ~ "95%", centile_num==9 ~ "99%")) %>%
  dplyr::filter(centile_num %in% c(1, 2, 5, 8, 9))

wmv_centile_fan <- ggplot(wmv.df) +
  geom_jitter(data = raw_df, aes(x=raw_df$age_years, y=raw_df$WMV), alpha=0.4, width=.2, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_years, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_2, color=dataset, linetype=dataset)) +
  #geom_line(aes(x=age_years, y=centile_3, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  # geom_line(aes(x=age_years, y=centile_6, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('raw'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "longdash"), name = "ComBat \nConfiguration", labels=dataset_names) +
  scale_color_manual(values = c('raw'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  geom_label(data=tmp_labels, aes(x=age_years, y=value, label=as.character(centile)), nudge_x = 0.35, size=2.5) +
  xlab("Age (yrs)") + ylab("White Matter Volume (mm3)") +
  theme_linedraw(base_size = 11) +
  theme(plot.title = element_text(size=12), legend.position="bottom")
wmv_centile_fan
```
Look at other phenotypes

```{r}
#looking at other phenotypes
ven.df <- centiles.df %>%
  dplyr::filter(pheno == "Ventricles") %>%
  dplyr::filter(dataset == "raw" | dataset == "cf.gam" | dataset == "cf.gamlss"| dataset == "cf.lm") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "raw", after = Inf ),
         age_years = age_days/365.25)
tmp_labels <- ven.df %>%
  dplyr::filter(age_years == max(age_years) & dataset=="raw") %>%
  pivot_longer(cols=starts_with("centile"), values_to = "value", names_to="centile_num", names_prefix = "centile_") %>%
  mutate(centile = case_when(centile_num == 1 ~ "1%", centile_num==2 ~ "5%", centile_num==3 ~ "10%", 
                             centile_num == 4 ~ "25%", centile_num==5 ~ "50%", centile_num==6 ~ "75%",
                             centile_num == 7 ~ "90%", centile_num==8 ~ "95%", centile_num==9 ~ "99%")) %>%
  dplyr::filter(centile_num %in% c(1, 2, 5, 8, 9)) %>%
  #repel for visuals
  mutate(value = ifelse(centile_num == 1, value*.75,
                           value))

ven_plot <- ggplot(ven.df) +
  geom_jitter(data = raw_df, aes(x=raw_df$age_years, y=raw_df$Ventricles),  alpha=0.4, width=.2, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_years, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_2, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_3, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  # geom_line(aes(x=age_years, y=centile_6, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('raw'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "longdash"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('raw'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('raw'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  theme_linedraw(base_size = 11) +
  geom_label(data=tmp_labels, aes(x=age_years, y=value, label=as.character(centile)), nudge_x = -0.75, size=3) +
  xlab("Age (days)") + ylab("Volume (mm3)") +
  labs(title="Ventricular volume brain charts")
```

```{r}
ven.df %>%
  dplyr::filter(sex=="Female") %>%
ggplot() +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  # geom_line(aes(x=age_years, y=centile_1, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_3, color=dataset)) +
  # geom_line(aes(x=age_years, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_5, color=dataset), linewidth=1.5) +
  # geom_line(aes(x=age_years, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_7, color=dataset)) +
  # geom_line(aes(x=age_years, y=centile_8, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~dataset, nrow=1, labeller=labeller(dataset_names)) + 
  # scale_linetype_manual(values = c('raw'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('raw'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('raw'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  xlab("Age (yrs)") + ylab("Volume (mm3)") +
  theme_classic(base_size = 11) +
  theme(plot.title = element_text(size=12), legend.position="none")
```

Random cortical feature

```{r}
r.sa.pc.df <- centiles.df %>%
  dplyr::filter(pheno == "rh_SA_postcentral") %>%
  dplyr::filter(dataset == "raw" | dataset == "cf.gam" | dataset == "cf.gamlss") %>%
  #pivot_longer(cols=contains("centile"), name)  %>%
  pivot_longer(
    cols = contains("centile"),
    names_to = c("sex", ".value"),
    names_pattern = "([MF]?)_(centile_\\d+)",
    values_to = "value"
  ) %>%
 dplyr::filter(!if_all(c(sex,contains("centile")), is.na)) %>%
  mutate(sex = as.factor(case_when(sex == "M" ~ "Male",
                                   sex == "F" ~ "Female")),
         dataset = fct_relevel(dataset, "raw", after = Inf ))

ggplot(r.sa.pc.df) +
  geom_jitter(data = raw_df, aes(x=raw_df$age_days, y=raw_df$rh_SA_postcentral), alpha=0.7, width=150, color="lightgray") +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  geom_line(aes(x=age_days, y=centile_1, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_3, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_5, color=dataset, linetype=dataset), linewidth=1.5) +
  geom_line(aes(x=age_days, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_7, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_8, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_days, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~sex) + 
  scale_linetype_manual(values = c('raw'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('raw'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('raw'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) + 
  theme_minimal() +
  xlab("Age (days)") + ylab("Volume (mm3)") +
  theme_minimal() +
  labs(title="SA of right postcentral brain charts")
```

# FIGURE 1: METHODS

toy distributions showing harmonization - based on code from GPT3.5

```{r}
# Function to create data for normal distribution
generate_data <- function(mean, sd, x_values) {
  data.frame(x = x_values, y = dnorm(x_values, mean = mean, sd = sd))
}

# Set parameters for raw data
mean_values <- c(0.1, 0.5, -1)  # Means for three curves even, M, F
sd_values <- c(0.8, 1.3, 1)     # Standard deviations for three curves
x_values <- seq(-4, 4, by = 0.1) # Adjust the range and interval as needed
name_list <- c("A", "C", "B")

# Generate data for three normal distributions
raw_data <- mapply(generate_data, mean = mean_values, sd = sd_values, MoreArgs = list(x_values), SIMPLIFY = FALSE)
names(raw_data) <- name_list

# Combine data frames into one
raw_data_combined <- do.call(rbind, Map(cbind, raw_data, Curve = names(raw_data)))

# Set parameters for ComBat/ComBat-GAM
mean_values <- c(0, 0.3, -0.3)  # Means for three curves even, M, F
sd_values <- c(1, 1, 1)     # Standard deviations for three curves

# Generate data for three normal distributions
cb_data <- mapply(generate_data, mean = mean_values, sd = sd_values, MoreArgs = list(x_values), SIMPLIFY = FALSE)
names(cb_data) <- name_list

# Combine data frames into one
cb_data_combined <- do.call(rbind, Map(cbind, cb_data, Curve = names(cb_data)))

# Set parameters for ComBat/ComBat-GAM
mean_values <- c(0, 0.3, -0.3)  # Means for three curves even, M, F
sd_values <- c(1, 1.1, 0.9)     # Standard deviations for three curves

# Generate data for three normal distributions
ls_data <- mapply(generate_data, mean = mean_values, sd = sd_values, MoreArgs = list(x_values), SIMPLIFY = FALSE)
names(ls_data) <- name_list

# Combine data frames into one
ls_data_combined <- do.call(rbind, Map(cbind, ls_data, Curve = names(ls_data)))

# Plot using ggplot2
ggplot(raw_data_combined, aes(x = x, y = y, color = Curve)) +
  geom_line(size = 3) +
  labs(title = "Raw Data",
       x = "X-axis", y = "Density") +
  scale_color_manual(values = c(A = "#9E52FF", B = "#5254FF", C = "#C87CFF")) +
  theme_void()

ggplot(cb_data_combined, aes(x = x, y = y, color = Curve)) +
  geom_line(size = 3) +
  labs(title = "ComBat/ComBat-GAM Data",
       x = "X-axis", y = "Density") +
  scale_color_manual(values = c(A = "#9E52FF", B = "#5254FF", C = "#C87CFF")) +
  theme_void()

ggplot(ls_data_combined, aes(x = x, y = y, color = Curve)) +
  geom_line(size = 3) +
  labs(title = "ComBatLS Data",
       x = "X-axis", y = "Density") +
  scale_color_manual(values = c(A = "#9E52FF", B = "#5254FF", C = "#C87CFF")) +
  theme_void()
```
toy brain chart for figs, diagram portion done in canva

```{r}
dataset_names <- c('ukb-CN-simsites' = "True Data", cf = "ComBat w/o Covar", cf.lm = "ComBat", cf.gam ="ComBat-GAM", cf.gamlss ="ComBatLS")
ven.df %>%
  dplyr::filter(sex=="Female") %>%
  mutate(dataset = factor(dataset, levels = c("ukb-CN-simsites", "cf", "cf.lm", "cf.gam", "cf.gamlss"), ordered = TRUE)) %>%
ggplot() +
  #scale_colour_manual(values=c("#5AAE61FF", "#9970ABFF")) +
  # geom_line(aes(x=age_years, y=centile_1, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_2, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_3, color=dataset)) +
  # geom_line(aes(x=age_years, y=centile_4, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_5, color=dataset), linewidth=1.5) +
  # geom_line(aes(x=age_years, y=centile_6, color=dataset, linetype=dataset)) +
  geom_line(aes(x=age_years, y=centile_7, color=dataset)) +
  # geom_line(aes(x=age_years, y=centile_8, color=dataset, linetype=dataset)) +
  # geom_line(aes(x=age_years, y=centile_9, color=dataset, linetype=dataset)) +
  facet_wrap(~dataset, nrow=1, labeller=labeller(dataset=dataset_names)) + 
  # scale_linetype_manual(values = c('ukb-CN-simsites'= "dotted", cf.gam = "solid", cf.gamlss = "solid", cf.lm = "solid"), name = "ComBat \nConfiguration", labels=dataset_names) +
  #scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#E84617", cf.gamlss = "#17E846", cf.lm = "purple")) +
  scale_color_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF")) + 
  xlab("Age (yrs)") + ylab("Brain Feature") +
  theme_classic(base_size = 11) +
  theme(plot.title = element_text(size=12), legend.position="none", axis.text.y=element_blank())
```

toy error distributions
```{r}
cf.df <- data.frame("err" = c(rnorm(100, -3, 10)),
          "df" = c(rep("cf.lm", 100)))
cf.gam.df <- data.frame("err" = c(rnorm(100, 1, 5)),
          "df" = c(rep("cf.gam", 100)))
cf.gamlss.df <- data.frame("err" = c(rnorm(100, 0, 3)),
          "df" = c(rep("cf.gamlss", 100)))

rbind(cf.df, cf.gam.df, cf.gamlss.df) %>%
  ggplot() +
  geom_histogram(aes(x=err, fill=df), color="black", alpha=0.7, position="identity") +
  scale_fill_manual(values = c('ukb-CN-simsites'= "black", cf.gam = "#3D75C2", cf.lm = "#75C23D", cf.gamlss ="#CFB023FF"), name = "ComBat \nConfiguration", labels=dataset_names) +
  theme_classic(base_size=20) +
  xlab("Centile Error") + 
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.line.y = element_blank()) +
  scale_x_continuous(labels=c('', 0, ''), breaks=c(-20, 0, -20))
```

# FIGURE 2

Combine plots

```{r}
fig_2 <- ggarrange(
  ven_plot,
  ggarrange(global_cent_errs_plot, p_diff, ncol=1, nrow=2, heights = c(1.2, 2), common.legend = FALSE, labels=c(NA, "C"), vjust = c(-0.25)),
  ncol=2, nrow=1, 
  labels=c("A", "B"),
  widths=c(1.1, 1)
  #hjust=0.01,
  # align = "hv"
  )

fig_2

ggsave("figs/figure_2.jpeg", fig_2, width=11, height=7, units="in")
```

